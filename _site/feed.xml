<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.2.2">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2022-12-01T07:35:05+11:00</updated><id>http://localhost:4000/feed.xml</id><entry><title type="html">Hanami 2.0 Thoughts</title><link href="http://localhost:4000/2022/11/hanami-20-thoughts" rel="alternate" type="text/html" title="Hanami 2.0 Thoughts" /><published>2022-11-28T00:00:00+11:00</published><updated>2022-11-28T00:00:00+11:00</updated><id>http://localhost:4000/2022/11/hanami-20-thoughts</id><content type="html" xml:base="http://localhost:4000/2022/11/hanami-20-thoughts">&lt;p&gt;&lt;a href=&quot;https://ryanbigg.com/2018/03/my-thoughts-on-hanami&quot;&gt;I’ve been a fan of Hanami&lt;/a&gt; for a number of years now. One of my favourite apps to work on is &lt;a href=&quot;https://github.com/radar/twist-v2&quot;&gt;even an open-source Hanami app!&lt;/a&gt; I have also been writing &lt;a href=&quot;https://github.com/radar/chirper&quot;&gt;an ActivityPub app called “Chirper”&lt;/a&gt; in Hanami.&lt;/p&gt;

&lt;p&gt;Now that Hanami 2.0 has come out, a few people have been asking me for my thoughts on this major Hanami release.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;The headline is: it’s really, really fast. It’s really clean. And it’s really good if you’re building an API at the moment.&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;It’s currently missing opinions/support on a view layer (so no templating) and DB persistence (although the Getting Started guide does recommend a way to set it up). Hanami 2.1 is supposed to come out (in early 2023) with proper baked-in support for both of those things.&lt;/p&gt;

&lt;p&gt;When working on Chirper, I haven’t missed view templates as the application is all APIs. And I didn’t mind that there wasn’t a built-in configuration for databases, as the Getting Started guide for Hanami provided everything I needed there. It was refreshing to be able to “choose my own adventure” in that way, allowing me to opt for even something such as &lt;a href=&quot;https://rubygems.org/gems/sequel&quot;&gt;Sequel&lt;/a&gt; if I chose to.&lt;/p&gt;

&lt;p&gt;I like that Hanami hasn’t got an opinion du jour on JavaScript and CSS assets, like Rails had with Sprockets, Webpacker, etc. It leaves that particular responsibility up to the build tools that are great at that, such as ESBuild.&lt;/p&gt;

&lt;p&gt;I love that the actions are clearly separated out into their own classes, rather than all being bundled into a single class. I love that you can &lt;a href=&quot;https://github.com/radar/chirper/blob/40c4c532449deedbfaaac61dd2914fde7728cd97/app/actions/api/accounts/outbox.rb#L12-L17&quot;&gt;specify the types of parameters&lt;/a&gt; that an action receives.&lt;/p&gt;

&lt;p&gt;I really enjoy the dependency injection support that &lt;a href=&quot;https://github.com/radar/chirper/blob/81504258fbe74e3269c4f7ab013d6f0009b38cb6/spec/activity_pub/processors/create_spec.rb#L3-L7&quot;&gt;allows me to test parts of the application without hitting a real database&lt;/a&gt;. This makes those tests really fast. In the class itself, dependency injection also highlights the dependencies that a particular class has. If you notice the list of &lt;code&gt;Deps&lt;/code&gt; getting long, then it’s a good sign that the class is trying to do too much; such a thing signposts the complexity of the class right at the top.&lt;/p&gt;

&lt;p&gt;I love that &lt;a href=&quot;https://github.com/decafsucks/decafsucks&quot;&gt;Tim Riley, who is on the Hanami Core Team, is re-building Decaf Sucks in public&lt;/a&gt; to really show how it’s done.&lt;/p&gt;

&lt;p&gt;There’s also a bunch of &lt;a href=&quot;https://hanamimastery.com/&quot;&gt;Hanami screencasts (HanamiMastery) recorded by Seb Wilgosz&lt;/a&gt;, which come in both video and text format.&lt;/p&gt;

&lt;p&gt;Overall, I’m glad that the Hanami team has taken their time to really polish up this release, and I’m looking forward to building more things in what is shaping up to be &lt;em&gt;the&lt;/em&gt; Ruby web framework of the future.&lt;/p&gt;</content><author><name></name></author><summary type="html">I’ve been a fan of Hanami for a number of years now. One of my favourite apps to work on is even an open-source Hanami app! I have also been writing an ActivityPub app called “Chirper” in Hanami.</summary></entry><entry><title type="html">The Gem Foundation</title><link href="http://localhost:4000/2022/11/the-gem-foundation" rel="alternate" type="text/html" title="The Gem Foundation" /><published>2022-11-24T00:00:00+11:00</published><updated>2022-11-24T00:00:00+11:00</updated><id>http://localhost:4000/2022/11/the-gem-foundation</id><content type="html" xml:base="http://localhost:4000/2022/11/the-gem-foundation">&lt;div class=&quot;text-3xl text-center&quot;&gt;&lt;p&gt;Today, I am excited to announce the launch of &lt;strong&gt;The Gem Foundation&lt;/strong&gt;.&lt;/p&gt;&lt;/div&gt;

&lt;p&gt;Its mission is assist contributors in the Ruby community in their task to further the adoption of the Ruby language, expanding the scope more broadly than just one particular web framework.&lt;/p&gt;

&lt;p&gt;Because Ruby &lt;em&gt;is&lt;/em&gt; more than just a single framework.&lt;/p&gt;

&lt;p&gt;Immediately after establishment of this foundation, we have already surpassed &lt;a href=&quot;https://rubyonrails.org/2022/11/14/the-rails-foundation&quot;&gt;The Rails Foundation&lt;/a&gt; in terms of dollars donated, as we have donated &lt;strong&gt;ONE SINGLE U.S. DOLLAR&lt;/strong&gt; to &lt;a href=&quot;https://ruby.social/@baweaver&quot;&gt;Brandon Weaver&lt;/a&gt;, who was the first developer to get in touch with the foundation. Brandon contributes to the Ruby community by &lt;a href=&quot;https://dev.to/baweaver&quot;&gt;writing articles on his personal blog&lt;/a&gt;, and also runs the Ruby Learning Center Discord.&lt;/p&gt;

&lt;p&gt;The Gem Foundation has also donated &lt;strong&gt;TWO U.S. DOLLARS&lt;/strong&gt; to &lt;a href=&quot;https://ruby.social/@jaredwhite@indieweb.social&quot;&gt;Jared White&lt;/a&gt;, who is a contributor to &lt;a href=&quot;https://www.bridgetownrb.com/&quot;&gt;the Bridgetown&lt;/a&gt; site generator.&lt;/p&gt;

&lt;p&gt;The Gem Foundation is also contributing $25/USD a month towards the &lt;a href=&quot;https://github.com/sponsors/hanami&quot;&gt;Hanami&lt;/a&gt; web framework. If you would like there to be real competition in the Ruby web framework sphere, I would encourage you to do the same.&lt;/p&gt;

&lt;p&gt;That’s &lt;em&gt;$28USD&lt;/em&gt; already donated by the Gem Foundation!&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;strong&gt;UPDATE&lt;/strong&gt;: Kieran Andrews from Adelaide (and of &lt;a href=&quot;https://activerailsbook.com&quot;&gt;Active Rails fame&lt;/a&gt;) has also donated &lt;em&gt;$30USD&lt;/em&gt; to the &lt;a href=&quot;https://github.com/pry/pry&quot;&gt;Pry gem&lt;/a&gt;, bringing The Gem Foundation’s donation total up to $58USD!&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;UPDATE #2&lt;/strong&gt;: As it’s now the 1st of December, a payment of $25USD has been made to the Hanami organisation on GitHub. This brings our total donations almost to $100!&lt;/p&gt;

&lt;p&gt;Here’s a helpful chart to track our donations:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/gem-foundation/donations.png&quot; alt=&quot;The Gem Foundation donations&quot; /&gt;&lt;/p&gt;</content><author><name></name></author><summary type="html">Today, I am excited to announce the launch of The Gem Foundation.</summary></entry><entry><title type="html">A replacement for strong parameters</title><link href="http://localhost:4000/2022/11/a-replacement-for-strong-parameters" rel="alternate" type="text/html" title="A replacement for strong parameters" /><published>2022-11-09T00:00:00+11:00</published><updated>2022-11-09T00:00:00+11:00</updated><id>http://localhost:4000/2022/11/a-replacement-for-strong-parameters</id><content type="html" xml:base="http://localhost:4000/2022/11/a-replacement-for-strong-parameters">&lt;p&gt;I’m not going to take &lt;a href=&quot;https://dev.37signals.com/vanilla-rails-is-plenty&quot;&gt;this week’s (very obvious) bait about how “Vanilla Rails is plenty”&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;In the past, I’ve spent effort watching DHH’s videos and &lt;a href=&quot;https://ryanbigg.com/2018/03/on-writing-software-well-2-a-review&quot;&gt;issuing a (time-stamped) rebuttal&lt;/a&gt;, and writing up about &lt;a href=&quot;https://ryanbigg.com/2017/06/current-considered-harmful&quot;&gt;a new Rails feature I would consider harmful&lt;/a&gt;.&lt;/p&gt;

&lt;p style=&quot;font-size: 125%&quot;&gt;&lt;strong&gt;I even &lt;a href=&quot;https://leanpub.com/maintain-rails/&quot;&gt;wrote a book called Maintainable Rails&lt;/a&gt; that offers my take on how to build a maintainable Rails application. A whole 30,000 words of it!&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;I am not going to follow that pattern today, even though the vanilla Rails article is &lt;em&gt;concerning&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;You know, if their apps were &lt;em&gt;maintainable&lt;/em&gt;, then they wouldn’t need to keep re-writing them completely, yeah?&lt;/p&gt;

&lt;p&gt;I digress.&lt;/p&gt;

&lt;p&gt;Today, I want to cover a &lt;em&gt;different&lt;/em&gt; feature of Rails that I think could be improved: strong parameters.&lt;/p&gt;

&lt;p&gt;The &lt;a href=&quot;https://guides.rubyonrails.org/action_controller_overview.html#nested-parameters&quot;&gt;documentation for strong_parameters&lt;/a&gt; always makes me a little confused with all of its different kinds of brackets. It feels like someone discovered Lisp and then thought it would be good to have as many brackets in Ruby, only to abandon the idea half-way.&lt;/p&gt;

&lt;p&gt;Here’s a complicated example from that documentation.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;params.permit(:name, { emails: [] },
              friends: [ :name,
                         { family: [ :name ], hobbies: [] }])
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The documentation goes on to explain:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;This declaration permits the name, emails, and friends attributes. It is expected that emails will be an array of permitted scalar values, and that friends will be an array of resources with specific attributes: they should have a name attribute (any permitted scalar values allowed), a hobbies attribute as an array of permitted scalar values, and a family attribute which is restricted to having a name (any permitted scalar values allowed here, too).&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;The documentation also explains that the permitted scalar values are:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;The permitted scalar types are `String`, `Symbol`, `NilClass`, `Numeric`, `TrueClass`, `FalseClass`, `Date`, `Time`, `DateTime`, `StringIO`, `IO`, `ActionDispatch::Http::UploadedFile`, and `Rack::Test::UploadedFile`.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;That’s quite a few permitted types!&lt;/p&gt;

&lt;p&gt;How might we approach this differently? I think we could do this in a clearer fashion with a gem called &lt;a href=&quot;https://dry-rb.org/gems/dry-schema/1.10/&quot;&gt;dry-schema&lt;/a&gt;. The dry-schema gem allows us to define particular schemas that our data should comply with, and like strong parameters it will automatically drop keys that are not specified in the schema itself.&lt;/p&gt;

&lt;h3 id=&quot;creating-the-schema&quot;&gt;Creating the schema&lt;/h3&gt;

&lt;p&gt;Let’s try creating a schema from the above strong parameters code, but this time in dry-schema. I’m also going to add an extra field here called age:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;PersonSchema = Dry::Schema.Params do
  required(:name).filled(:string)
  required(:age).filled(:integer)
  required(:emails).value(array[:string]).value(min_size?: 1)
  required(:friends).array(:hash) do
    required(:name).filled(:string)
    required(:family).hash do
      required(:name).filled(:string)
    end
  end
  required(:hobbies).array(:string)
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;With this schema we’re clearly defining the types of the data that we expect. Now we’ve limited the type of &lt;code&gt;name&lt;/code&gt; to string, so it can no longer accept a file for its value. That is probably for the best.&lt;/p&gt;

&lt;p&gt;The &lt;code&gt;required(:friends).array(:hash)&lt;/code&gt; syntax might hurt a little bit to read, but it means “an array of any length, where the values are all hashes”. The block of this method then defines the permitted keys within those hashes.&lt;/p&gt;

&lt;p&gt;You could define this schema at the top of your controller, if you like, or in its own file at &lt;code&gt;app/schemas/person_schema.rb&lt;/code&gt;. It really should depend on the context in which it is used.&lt;/p&gt;

&lt;p&gt;It goes further than strong parameters, because it specifies the types expected for things such as emails and hobbies, whereas strong parameters would allow any “permitted scalar values” in there, including things such as numbers. The &lt;code&gt;dry-schema&lt;/code&gt; version &lt;em&gt;also&lt;/em&gt; specifies that there has to be at least one email address.&lt;/p&gt;

&lt;h3 id=&quot;using-a-valid-set-of-parameters&quot;&gt;Using a valid set of parameters&lt;/h3&gt;

&lt;p&gt;A hash that would pass the checks for this schema.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;params = {
  name: &quot;Ryan&quot;,
  age: 34,
  emails: [&quot;me@ryanbigg.com&quot;],
  hobbies: [&quot;MTG&quot;, &quot;Coding&quot;],
  friends: [
    {
      name: &quot;Dear&quot;,
      family: { name: &quot;Reader&quot; }
    }
  ]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We can check this with:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;result = PersonSchema.(params)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We will get a &lt;code&gt;Dry::Schema::Result&lt;/code&gt; back from this, which we can grab the output of with:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;result.output
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;type-coercions&quot;&gt;Type-coercions&lt;/h3&gt;

&lt;p&gt;Another hash that would pass the checks, even though it might not look like it, is this one:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;params = {
  name: &quot;Ryan&quot;,
  age: &quot;34&quot;,
  emails: [&quot;me@ryanbigg.com&quot;],
  hobbies: [&quot;MTG&quot;, &quot;Coding&quot;],
  friends: [
    {
      name: &quot;Dear&quot;,
      family: { name: &quot;Reader&quot; }
    }
  ]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The &lt;code&gt;age&lt;/code&gt; key here is specified as a string, but the schema says the type must be an &lt;code&gt;integer&lt;/code&gt;. Let’s look at what happens:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;result = PersonSchema.(params)
result.output[:age] # =&amp;gt; 34
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The &lt;code&gt;Dry::Schema.Params&lt;/code&gt; type will do its best to cooerce string parameter values to their matching Ruby counterparts. This will also work for things such as dates in the “YYYY-MM-DD” formats, too. No more needing to do a &lt;code&gt;Date.parse&lt;/code&gt; if that parameter is being sent to something else, like a service object instead of a model.&lt;/p&gt;

&lt;h3 id=&quot;unknown-keys-are-removed&quot;&gt;Unknown Keys are removed&lt;/h3&gt;

&lt;p&gt;Like with strong parameters, if we attempt to pass an extra key:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;params = {
  name: &quot;Ryan&quot;,
  age: 34,
  emails: [&quot;me@ryanbigg.com&quot;],
  hobbies: [&quot;MTG&quot;, &quot;Coding&quot;],
  friends: [
    {
      name: &quot;Dear&quot;,
      family: { name: &quot;Reader&quot; }
    }
  ],
  very_smart: true
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Then the schema will remove this additional key, proving that I am just regular smart, if that.&lt;/p&gt;

&lt;h3 id=&quot;re-using-schemas&quot;&gt;Re-using schemas&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;dry-schema&lt;/code&gt; also allows us to re-use schemas. Let’s say that we have two schemas, our &lt;code&gt;PersonSchema&lt;/code&gt; and another schema called &lt;code&gt;FriendSchema&lt;/code&gt; that defines the shape of the friend keys. Heres how we could use those together:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;FriendSchema = Dry::Schema.params do
  required(:name).filled(:string)
  required(:family).hash do
    required(:name).filled(:string)
  end
end

PersonSchema = Dry::Schema.Params do
  required(:name).filled(:string)
  required(:age).filled(:integer)
  required(:emails).value(array[:string]).value(min_size?: 1)
  required(:friends).array(FriendSchema)
  required(:hobbies).array(:string)
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This is particularly helpful if you had a couple of complicated data structures that you wanted to validate at the same time, and use each of those schemas in different locations.&lt;/p&gt;

&lt;p&gt;I’d like to see strong parameters do that!&lt;/p&gt;

&lt;h3 id=&quot;error-messages-are-provided&quot;&gt;Error messages are provided&lt;/h3&gt;

&lt;p&gt;If the hash passed in is completely invalid, like this one:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;params = {}
result = PersonSchema.(params)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Then we can retrieve error messages that are similar to Active Model validations back out:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;=&amp;gt; {:name=&amp;gt;[&quot;is missing&quot;], :age=&amp;gt;[&quot;is missing&quot;], :emails=&amp;gt;[&quot;is missing&quot;], :friends=&amp;gt;[&quot;is missing&quot;], :hobbies=&amp;gt;[&quot;is missing&quot;]}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;On top of this, the &lt;code&gt;result&lt;/code&gt; is also going to respond to &lt;code&gt;success?&lt;/code&gt; with &lt;code&gt;false&lt;/code&gt;, meaning we could use this in a controller action to check if the parameters are valid, before even passing them to their final destination. That might be a model (with, perhaps, it’s own validations), or it could
be another service.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;I’ve only scratched the surface on what &lt;code&gt;dry-schema&lt;/code&gt; can do. I purposely wanted to keep this post short today to cover how it could replace strong parameters within Rails to provide a much better developer experience than that bracketed mess.&lt;/p&gt;

&lt;p&gt;If you’d like to know what else dry-schema can do, make sure to check out &lt;a href=&quot;https://dry-rb.org/gems/dry-schema/&quot;&gt;its documentation here&lt;/a&gt;.&lt;/p&gt;</content><author><name></name></author><summary type="html">I’m not going to take this week’s (very obvious) bait about how “Vanilla Rails is plenty”.</summary></entry><entry><title type="html">Using Union Types with GraphQL Mutations in Ruby</title><link href="http://localhost:4000/2022/05/ruby-graphql-mutations-with-union-types" rel="alternate" type="text/html" title="Using Union Types with GraphQL Mutations in Ruby" /><published>2022-05-06T00:00:00+10:00</published><updated>2022-05-06T00:00:00+10:00</updated><id>http://localhost:4000/2022/05/ruby-graphql-mutations-with-union-types</id><content type="html" xml:base="http://localhost:4000/2022/05/ruby-graphql-mutations-with-union-types">&lt;p&gt;The &lt;a href=&quot;https://graphql-ruby.org/mutations/mutation_classes.html&quot;&gt;official documentation for the graphql-ruby gem&lt;/a&gt; recommends this code for a mutation class that can either succeed or fail:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;class Mutations::CreateComment &amp;lt; Mutations::BaseMutation
  argument :body, String
  argument :post_id, ID

  field :comment, Types::Comment
  field :errors, [String], null: false

  def resolve(body:, post_id:)
    post = Post.find(post_id)
    comment = post.comments.build(body: body, author: context[:current_user])
    if comment.save
      # Successful creation, return the created object with no errors
      {
        comment: comment,
        errors: [],
      }
    else
      # Failed save, return the errors to the client
      {
        comment: nil,
        errors: comment.errors.full_messages
      }
    end
  end
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I’d like to show an alternative to this that I think leads to cleaner code by using GraphQL concept called &lt;em&gt;union types&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;We use union types in GraphQL when we want a field to return one or more distinct types as its result. In the case of the above comment mutation, the two types of things we would like to return are either:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;A comment, if the mutation was successful&lt;/li&gt;
  &lt;li&gt;Errors, if the mutation was unsuccessful&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Let’s change that mutation above to use a union type by declaring the type at the top of the mutation, and removing the two fields:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;class Mutations::CreateComment &amp;lt; Mutations::BaseMutation
  type Types::CreateCommentResult
  argument :body, String
  argument :post_id, ID

  def resolve(body:, post_id:)
    post = Post.find(post_id)
    comment = post.comments.build(body: body, author: context[:current_user])
    if comment.save
      # Successful creation, return the created object with no errors
      {
        comment: comment,
        errors: [],
      }
    else
      # Failed save, return the errors to the client
      {
        comment: nil,
        errors: comment.errors.full_messages
      }
    end
  end
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This new type will be our union type that will represent either a successful creation for a comment, or a failed one.&lt;/p&gt;

&lt;p&gt;We can define this type in our &lt;code&gt;types&lt;/code&gt; directory under &lt;code&gt;graphql&lt;/code&gt;, in a file called &lt;code&gt;create_comment_result.rb&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;module Types
  class CreateCommentResult &amp;lt; BaseUnion
    description &quot;The result from attempting to create a comment&quot;
    possible_types Types::Comment, Types::Errors

    def self.resolve_type(object, _context)
      if object[:comment]
        [Types::Comment, object[:comment]]
      else
        [Types::Errors, object]
      end
    end
  end
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;A union type is defined by first inheriting from &lt;code&gt;BaseUnion&lt;/code&gt;. If we had common logic to share between union types in our GraphQL API, that logic would go into &lt;code&gt;BaseUnion&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Inside this &lt;code&gt;CreateCommentResult&lt;/code&gt; type itself, we provide a description that’ll appear in our API documentation, and inform this class what the possible types are. For this union type, we’re defining two possible types: &lt;code&gt;Types::Comment&lt;/code&gt;, and &lt;code&gt;Types::Errors&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;When the GraphQL code runs, it will call this &lt;code&gt;resolve_type&lt;/code&gt; method to determine the correct GraphQL type to use when representing the result of the mutation. This method checks if &lt;code&gt;object[:comment]&lt;/code&gt; is present, and if it is the type that’ll be used is a &lt;code&gt;Types::Comment&lt;/code&gt;, and we can fetch the comment from that object using &lt;code&gt;object[:comment]&lt;/code&gt;. In Rails parlance, this &lt;code&gt;object[:comment]&lt;/code&gt; will be an instance of the &lt;code&gt;Comment&lt;/code&gt; model – a result of a successful &lt;code&gt;build&lt;/code&gt; and &lt;code&gt;save&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;If the operation was to fail, we would instead return a &lt;code&gt;Types::Error&lt;/code&gt; type, and use the resulting object as the base object for that type.&lt;/p&gt;

&lt;p&gt;These two types can be defined in the &lt;code&gt;types&lt;/code&gt; directory too. Let’s look at &lt;code&gt;CommentType&lt;/code&gt; first, defined in &lt;code&gt;types/comment.rb&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;class Types::Comment &amp;lt; Types::BaseObject
  field :id, ID, null: false
  field :body, String, null: false
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This type is used to represent comments in our GraphQL API. It provides access to both the &lt;code&gt;id&lt;/code&gt; and &lt;code&gt;body&lt;/code&gt; attributes from any &lt;code&gt;Comment&lt;/code&gt; instance that is represented by this API.&lt;/p&gt;

&lt;p&gt;Then, the &lt;code&gt;Errors&lt;/code&gt; type:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;class Types::Errors &amp;lt; Types::BaseObject
  field :errors, [String], null: false
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This type represents the &lt;code&gt;{ comment: nil, errors: [...] }&lt;/code&gt; hash that will be returned when a comment creation fails.&lt;/p&gt;

&lt;p&gt;With these union types setup, we can write this GraphQL query that will rely on them:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;mutation {
  createComment(input: { postId: 1, body: &quot;Hello world&quot; }) {
    __typename
    ... on Comment {
      id
    }

    ...on Errors {
      errors
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Firstly, we call this mutation by passing in its required arguments. After that, we fetch a field called &lt;code&gt;__typename&lt;/code&gt;. This field is automatically defined, and it will return the type whatever object is returned, either &lt;code&gt;Comment&lt;/code&gt; or &lt;code&gt;Errors&lt;/code&gt;. When calling this GraphQL API, we can use &lt;code&gt;__typename&lt;/code&gt; to determine how to act.&lt;/p&gt;

&lt;p&gt;The &lt;code&gt;... on&lt;/code&gt; syntax here tells GraphQL which fields we would like to use in the case of each part of the union being returned here. If it’s a comment, we will fetch just the &lt;code&gt;id&lt;/code&gt;. If it’s &lt;code&gt;Errors&lt;/code&gt;, we can fetch just the errors.&lt;/p&gt;

&lt;p&gt;If we were to call this mutation with an empty comment body, we would see this as the result:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-json&quot;&gt;{
  &quot;data&quot;: {
    &quot;createComment&quot;: {
      &quot;__typename&quot;: &quot;Errors&quot;,
      &quot;errors&quot;: [
        &quot;Body can&apos;t be blank&quot;
      ]
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And if we were to call it with a valid body, we would see this:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-json&quot;&gt;{
  &quot;data&quot;: {
    &quot;createComment&quot;: {
      &quot;__typename&quot;: &quot;Comment&quot;,
      &quot;id&quot;: &quot;6&quot;
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;When using this API (for example, within a frontend codebase), we can assert on &lt;code&gt;__typename&lt;/code&gt; to determine how to show the result to a user – if it’s a &lt;code&gt;Comment&lt;/code&gt;, then indicate a successful comment creation. If it’s &lt;code&gt;Errors&lt;/code&gt;, then show those errors on the form.&lt;/p&gt;</content><author><name></name></author><summary type="html">The official documentation for the graphql-ruby gem recommends this code for a mutation class that can either succeed or fail:</summary></entry><entry><title type="html">Typed View Components with dry-types</title><link href="http://localhost:4000/2022/03/typed-view-components" rel="alternate" type="text/html" title="Typed View Components with dry-types" /><published>2022-03-08T00:00:00+11:00</published><updated>2022-03-08T00:00:00+11:00</updated><id>http://localhost:4000/2022/03/typed-view-components</id><content type="html" xml:base="http://localhost:4000/2022/03/typed-view-components">&lt;p&gt;This post was originally inspired by &lt;a href=&quot;https://twitter.com/RogersKonnor&quot;&gt;Konnor Rogers&lt;/a&gt;, and &lt;a href=&quot;https://gist.github.com/ParamagicDev/5dc17dea9e8ab414d227461ae521f011&quot;&gt;this gist from him&lt;/a&gt;.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Last year, I wrote about &lt;a href=&quot;https://ryanbigg.com/2021/04/view-components-the-missing-link&quot;&gt;View Components&lt;/a&gt; for the first time. That post demonstrated how you could use View Components to bridge the gap between Ruby and React by using a View Component to build up the props for a React component.&lt;/p&gt;

&lt;p&gt;Since then, I’ve joined &lt;a href=&quot;https://fatzebra.com&quot;&gt;Fat Zebra&lt;/a&gt; and we’re doing a lot of work involving Rails, React and View Components.&lt;/p&gt;

&lt;p&gt;One thing we’ve discovered that helps with using View Components is adding types by using the &lt;code&gt;dry-initializer&lt;/code&gt; and &lt;code&gt;dry-types&lt;/code&gt; to those View Components. While we have the protection of types in TypeScript, we do not have the same level of protection in Ruby. And since TypeScript only does compile-time checking, it means that we could pass a property from these Ruby View Components down to our React components where that property’s type is incorrect.&lt;/p&gt;

&lt;p&gt;Take for (contrived) example, this simple component that takes in a &lt;code&gt;standalone&lt;/code&gt; property.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;class RefundComponent &amp;lt; ViewComponent::Base
  attr_reader :standalone

  def initialize(standalone:)
    @standalone = standalone
  end

  def props
    {
      standalone: standalone,
      # ...
    }
  end
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;There’s nothing in this component that dictates the type for &lt;code&gt;standalone&lt;/code&gt;. It should be a boolean. It &lt;em&gt;could be&lt;/em&gt; a string, or a number, or literally any valid object in Ruby. So when this component is used in this way:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;render RefundComponent.new(standalone: params[:standalone])
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;What’s going to happen here?&lt;/p&gt;

&lt;p&gt;Well, if we &lt;em&gt;think&lt;/em&gt; standalone is a boolean, we can expect &lt;code&gt;params[:standalone]&lt;/code&gt; is going to be either &lt;code&gt;&quot;true&quot;&lt;/code&gt; or &lt;code&gt;&quot;false&quot;&lt;/code&gt; ,given that Rails parameters are stringified.&lt;/p&gt;

&lt;p&gt;Inside our React component, we might have code like this.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-tsx&quot;&gt;{standalone ? &quot;Standalone&quot; : &quot;Not Standalone&quot;}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The string &lt;code&gt;&quot;true&quot;&lt;/code&gt; does the same as the boolean &lt;code&gt;true&lt;/code&gt;. The string &lt;code&gt;&quot;false&quot;&lt;/code&gt; does not do the same as the boolean &lt;code&gt;&quot;false&quot;&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;This is completely innocent code, and the kind that we might write any old day. Nothing stopped us from writing it. In fact, TypeScript gave us &lt;em&gt;two&lt;/em&gt; thumbs up when we compiled our React code. Ruby doesn’t care. Ruby’s fine as long as the syntax is correct.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;To prevent a mistake like this, we can use the &lt;code&gt;dry-initializer&lt;/code&gt; and &lt;code&gt;dry-types&lt;/code&gt; gems like this:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;class RefundComponent &amp;lt; ViewComponent::Base
  extend Dry::Initializer
  Types = Dry.Types()

  option :standalone, Types::Bool

  def props
    {
      standalone: standalone,
      # ...
    }
  end
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The &lt;code&gt;Types&lt;/code&gt; constant here is usually defined on a more “global” level. For example, you might define it at &lt;code&gt;lib/types.rb&lt;/code&gt; for your entire application. I’ve just included it in the class here for brevity.&lt;/p&gt;

&lt;p&gt;The &lt;code&gt;option&lt;/code&gt; method here defines a keyword argument initializer for &lt;code&gt;RefundComponent&lt;/code&gt;, so this means our component will still be able to be rendered in the same way:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;render RefundComponent.new(standalone: params[:standalone])
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;But this time, if we pass it a stringly-typed &lt;code&gt;standalone&lt;/code&gt; here, it will show us an error:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&quot;false&quot; violates constraints (type?(FalseClass, &quot;false&quot;) failed) (Dry::Types::ConstraintError)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The error message is wordy, but with enough practice (just like TypeScript!) we can learn to read these. The error message here says that the type of &lt;code&gt;FalseClass&lt;/code&gt;, is not the same type as &lt;code&gt;&quot;false&quot;&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;We cannot pass the stringly-typed &lt;code&gt;params[:standalone]&lt;/code&gt; here anymore.&lt;/p&gt;

&lt;p&gt;Instead, we would have to convert this parameter to a boolean so that our code would work:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;render RefundComponent.new(standalone: params[:standalone] == &apos;true&apos;)
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;but-wait-theres-more&quot;&gt;But wait, there’s more…&lt;/h3&gt;

&lt;p&gt;We can also use &lt;code&gt;dry-types&lt;/code&gt; to define the types for our properties too, in case we had some complicated logic there.  Perhaps we have an amount that is returned, and we want to guarantee it’s a float by the time it gets to our React library. To spice things up, for legacy reasons the &lt;code&gt;amount&lt;/code&gt; arrives at our component as a string, not a float. With this amount also comes a currency property, which is also a string.&lt;/p&gt;

&lt;p&gt;Here’s how we would handle that by using another &lt;code&gt;dry-rb&lt;/code&gt; library, &lt;code&gt;dry-struct&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;class RefundComponent &amp;lt; ViewComponent::Base
  extend Dry::Initializer
  Types = Dry.Types()

  option :standalone, Types::Bool
  option :amount, Types::String
  option :currency, Types::String

  class Props &amp;lt; Dry::Struct
    schema schema.strict

    attribute :standalone, Types::Bool
    attribute :amount, Types::Float
    attribute :currency, Types::String
  end

  def props
    Props.new(
      standalone: standalone,
      amount: amount.to_money(currency).to_f,
      currency: currency,
      # ...
    ).to_h
  end
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This way, we can call &lt;code&gt;RefundComponent&lt;/code&gt; with a stringified &lt;code&gt;amount&lt;/code&gt;, and have &lt;code&gt;props&lt;/code&gt; be the correct type:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;gt;&amp;gt; component = RefundComponent.new(standalone: params[:standalone] == &apos;true&apos;, amount: &quot;1234&quot;, currency: &quot;AUD&quot;)
=&amp;gt; #&amp;lt;RefundComponent:0x000000013e6a76a8 @amount=&quot;1234&quot;, @currency=&quot;AUD&quot;, @standalone=true&amp;gt;
&amp;gt;&amp;gt; component.props
=&amp;gt; {:standalone=&amp;gt;true, :amount=&amp;gt;1234.0, :currency=&amp;gt;&quot;AUD&quot;}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If the type of &lt;code&gt;Props#amount&lt;/code&gt; (once it has been coerced) wasn’t a float and instead was an integer, like this:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;amount: amount.to_money(currency).to_i,
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This code would cause this error:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;1234 (Integer) has invalid type for :amount violates constraints (type?(Float, 1234) failed) (Dry::Types::SchemaError)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This helps alert us to a typing issue earlier on in our code, before it even reaches our React code.&lt;/p&gt;</content><author><name></name></author><summary type="html">This post was originally inspired by Konnor Rogers, and this gist from him.</summary></entry><entry><title type="html">Culture and Values</title><link href="http://localhost:4000/2021/12/culture-and-values" rel="alternate" type="text/html" title="Culture and Values" /><published>2021-12-09T00:00:00+11:00</published><updated>2021-12-09T00:00:00+11:00</updated><id>http://localhost:4000/2021/12/culture-and-values</id><content type="html" xml:base="http://localhost:4000/2021/12/culture-and-values">&lt;p&gt;It’s been one year since I was fired.&lt;/p&gt;

&lt;p&gt;The Big Boss at the time wanted everyone to work out of an office in Melbourne (because by the end of 2020, everyone thought that The Pandemic was &lt;em&gt;over&lt;/em&gt;), and I was moving 250km to the west.&lt;/p&gt;

&lt;p&gt;What’s more, is that I was an opinionated asshole who cared too much about things and got angry about it. The whole pandemic thing didn’t help.&lt;/p&gt;

&lt;p&gt;It was the third time I had been let go from a job in just over a year. I was made redundant in November 2019 and again in April 2020. In 13 months, I had left 3 jobs. That doesn’t look so good on a resume.&lt;/p&gt;

&lt;p&gt;So I thought I should change things this year – usher in a new era of stability for myself and my family… and instead undertook consultancy work which has meant that I’ve had &lt;em&gt;at least&lt;/em&gt; 4 on-the-books jobs this year. But why go into consultancy after so many years of working full-time? And &lt;em&gt;especially&lt;/em&gt; why go into consultancy work despite wanting all that precious stability? And in the same year that I got a mortgage?&lt;/p&gt;

&lt;p&gt;Sure, the consulting money’s good (like, really good), but there’s a simpler answer: burnout.&lt;/p&gt;

&lt;p&gt;I was burned out on companies, especially when it came to the culture and values they espoused. &lt;em&gt;Especially&lt;/em&gt; the “F” word: “family”.&lt;/p&gt;

&lt;p&gt;I became too invested in those companies, and when it was time to wrap things up there, it was traumatic and devastating. There’s no nice way to sugar-coat things.&lt;/p&gt;

&lt;p&gt;I want to share a bit about the history of that trauma today, as (I guess) a way of coping with it.&lt;/p&gt;

&lt;p&gt;Perhaps others out there have experienced similar situations. I share this to cope, but I also share this to say to those people that you are not alone, and things can get better.&lt;/p&gt;

&lt;h2 id=&quot;2019-redundancy&quot;&gt;2019 Redundancy&lt;/h2&gt;

&lt;p&gt;The job I was made redundant from 2019 was my favourite job so far. I was running a Junior Engineering Program, and had trained up about 20 different developers. I was expressly told to start plotting and scheming for a 3rd iteration of that program. Two weeks after the “plotting and scheming” meeting, I was told I would be offered a redundancy. I took the remainder of that week off to cope with the whiplash.&lt;/p&gt;

&lt;p&gt;This was in July. I was slated to wrap up in November. It was a nice long goodbye.&lt;/p&gt;

&lt;p&gt;I cared deeply about the company, and its mission, and its people. I forgave it for its sins and transgressions.&lt;/p&gt;

&lt;p&gt;I forgave it for its office in Richmond with its oddly-named, incredibly stuffy meeting rooms. The same office that had windows that were fixed opened directly to the outside, even in Winter. The same cathedral-like office that couldn’t prioritise sound-proofing to prevent the conversations of the 150-people inside echoing off every conceivable surface.&lt;/p&gt;

&lt;p&gt;I’ve almost forgiven it for the time that it decided to run a 5-day-long all-hands conference, where the days were rougly 15 hours long, but may as well have been 150 hours for how exhausted I felt at the end of it all.&lt;/p&gt;

&lt;p&gt;Then November 2019 came around, and the person who did the exit interview at that company wasn’t my manager, or even a long-term HR employee. It was practically a stranger, someone who had started there &lt;em&gt;that very week&lt;/em&gt; in HR and she conducted my exit interview. I had never met this person before this interview, and I haven’t seen her since.&lt;/p&gt;

&lt;p&gt;I do not forgive the company for that.&lt;/p&gt;

&lt;p&gt;What softened the blow was a sizable redundancy payout. One that helped me buy the house that I’m now sitting in. I like that I have a house that’s progressively getting to be more and more my own, brick by sandstone brick, and less and less the bank’s. But I digress.&lt;/p&gt;

&lt;p&gt;It’s after this whole redundancy process that I came to realise that I cared too much about the company. I was &lt;em&gt;too invested&lt;/em&gt; in its values, its success, its &lt;em&gt;culture&lt;/em&gt;. I had tied too much of my own &lt;em&gt;value&lt;/em&gt; to the company’s &lt;em&gt;value&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;It was devastating to be shown the door.&lt;/p&gt;

&lt;h2 id=&quot;april-2020-redundancy&quot;&gt;April 2020 Redundancy&lt;/h2&gt;

&lt;p&gt;Then I found a job with a company whose values I very strongly aligned with. A company that trained up junior-junior developers. People who were just getting started with their programming careers. I thought I could make a real difference here in educating the next generation of developers who were entering the industry.&lt;/p&gt;

&lt;p&gt;Then a little thing called a pandemic hit. I’m sure you’ve heard of it by now. The parent company of the one I joined relied on international students for a large majority of its income. A pandemic in Australia meant closed borders (easy to enforce, as we’re a &lt;em&gt;giant island&lt;/em&gt;), and closed borders meant no international students, which ultimately meant little-to-no money for that company.&lt;/p&gt;

&lt;p&gt;I, along with the entire company, were told about potential redundancies happening in a staff-wide email on a &lt;em&gt;Monday&lt;/em&gt; at the end of March. During this week we found out it was going to be 235 people across the whole company. I got that dreaded call back on &lt;em&gt;Friday&lt;/em&gt; at 3pm. That was a particularly unproductive week, let me tell you. This time again it wasn’t my boss, or even a long-term colleague. It was some high-up HR woman who sounded absolutely exhausted.&lt;/p&gt;

&lt;p&gt;About 5 minutes after this phone call, I was locked out of Slack, GitHub, and email. It was clinical and effective. I went into the office the next week and collected my things. That was the last time I was in an office.&lt;/p&gt;

&lt;p&gt;I had become &lt;em&gt;too invested&lt;/em&gt; again in the company’s success.&lt;/p&gt;

&lt;p&gt;And I was cast out, without pity and this time without compensation.&lt;/p&gt;

&lt;h2 id=&quot;december-2020&quot;&gt;December 2020&lt;/h2&gt;

&lt;p&gt;With the pandemic hitting its stride by April 2020, I didn’t exactly put a lot of thought into where I wanted to go next. What I did put thought into was that I didn’t want to be made redundant again after being made redundant twice in quick succession, and that I didn’t want to lose my job during the pandemic.&lt;/p&gt;

&lt;p&gt;I cared about this job, and poured my focus and attention into it. I wanted things to be &lt;em&gt;right&lt;/em&gt; for our customers. A little too hard. I cared about things that I shouldn’t have cared about. I got upset when things that I thought were important were not considered important by others. I cared about creating a good working culture for the development team. I cared about replacing parts of our Backbone code with something from this decade. I cared too much. I got angry.&lt;/p&gt;

&lt;p&gt;And I got fired.&lt;/p&gt;

&lt;h2 id=&quot;2021&quot;&gt;2021&lt;/h2&gt;

&lt;p&gt;So this year, I started out as a consultant which is a pleasant way of saying “an opinionated asshole for hire”. I could choose to work 3-month contracts with no strings attached. I didn’t &lt;em&gt;need&lt;/em&gt; to care about the company culture, or get invested in its success. I needed to trade labor for dollars.&lt;/p&gt;

&lt;p&gt;I got to work with a few different teams releasing some major features in Rails and Rails-adjacent tech, and even upgraded a Rails app or two. I was trusted for my opinion on things, but really worked hard on giving the opinion in a &lt;em&gt;nice way&lt;/em&gt;. I joked to close friends that I should’ve hung bunting above my desk spelling out the word “PROFESSIONALISM” in giant letters. Sometimes I think I should still put it up.&lt;/p&gt;

&lt;p&gt;Ultimately, I was successful in doing the consultant thing of trading labor for dollars. And leaving things better than I how I found them, just for my own moral satisfaction.&lt;/p&gt;

&lt;p&gt;But, ultimately, it was lonely stuff. Working out of my house this year, by myself, with a 15-minute call for standup at the start of the day… just doesn’t tickle the social aspect of my brain in the right way. It often felt like I was an &lt;em&gt;interloper&lt;/em&gt; into these projects, tossing grenades (or bouquets, depending on the mood) into projects and then skipping off into the sunset with my fat bags of consultant cash.&lt;/p&gt;

&lt;p&gt;You ever walk into a meeting room, except it’s the wrong one? Well, if you like that feeling, become a consultant because that’s the feeling you get every damn day.&lt;/p&gt;

&lt;h2 id=&quot;interviewing-in-2021&quot;&gt;Interviewing in 2021&lt;/h2&gt;

&lt;p&gt;Around about the time that I figured out the “fucking hell, this is lonely work” thing I wrote &lt;a href=&quot;https://ryanbigg.com/2021/07/job-hunt-q2-2021&quot;&gt;this post&lt;/a&gt;. I write &lt;em&gt;this&lt;/em&gt; post today to provide some context, some colour, around why I sound so… bleak in that other post. It wasn’t just the pandemic.&lt;/p&gt;

&lt;p&gt;At the time of that post in July, I interviewed at a number of companies. I got offered coding tests. &lt;a href=&quot;https://ryanbigg.com/2021/07/on-coding-tests&quot;&gt;I got angry about being offered coding tests&lt;/a&gt;. And I refused to do them this time. Some people balked at that. I stood my ground, and was outright refused by some companies because I refused to do coding tests.&lt;/p&gt;

&lt;p&gt;The other half of the interviews that companies love to do is the culture part of the interview.&lt;/p&gt;

&lt;p&gt;A culture interview essentially boils down to “are you an asshole?” and, honestly, you could spend an hour reading about who I am and what I’ve done and get a pretty good idea about that. Or you could spend that hour talking to me and I’ll tell you the same thing. The best answer I can give you right now for that is: “you would probably rather hire 2021 Ryan than 2020 Ryan, and you’d &lt;em&gt;certainly&lt;/em&gt; hire 2020 Ryan over 2015 Ryan”. Just wait for 2022 Ryan. Jeez that guy is good.&lt;/p&gt;

&lt;p&gt;Things have improved. There are things that need improving that I am aware of. There are things that need improving that I’m not aware of. This is what makes us human. We’ll work on it together. I’ll try my damndest to not repeat the mistakes of the past and to prevent future ones.&lt;/p&gt;

&lt;p&gt;A culture interview can sometimes have questions like “what value of ours do you most identify with?” and if you’re interviewing at several different companies and have either been made redundant or fired from the last three big companies you’ve worked for… chances are you’re going to be particularly burned out on that aspect. You’re not going to have done your homework on those values of this one particular company, and you’re going to flub that particular question. Like I did.&lt;/p&gt;

&lt;p&gt;Later on, when &lt;em&gt;at least&lt;/em&gt; 5 friends suggest that I would be really great for that company’s Developer Mentor role (a different one to the one I applied for) that they’ve been advertising for months… the job where you could &lt;em&gt;train junior developers and get paid to do it&lt;/em&gt; and &lt;em&gt;holy fuck you’d be so good at it because this is your wheelhouse&lt;/em&gt;…. it kinda smarts and I get to re-live the trauma of &lt;em&gt;failing an interview as a really experienced developer&lt;/em&gt; again, and again, and again. All because I didn’t read the fucking list of values on their website, because I was seriously burned out on the whole “culture and values” thing.&lt;/p&gt;

&lt;p&gt;Who doesn’t love re-living moments of such abject failure?&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;To me, it is not important what the values written on a page of a company’s website are. It’s all the same bullshit.&lt;/p&gt;

&lt;p&gt;What matters to me is what happens there every single day. The values are not what is written on a website. The values are the stuff &lt;em&gt;in between the people&lt;/em&gt; every day. It’s the holding the proverbial bucket for the developer who’s just found That Piece of Legacy Code. It’s giving people time and space &lt;em&gt;away from the damn screen&lt;/em&gt; when they need it, no questions asked. It’s allowing people to make mistakes, and not punishing them. It’s about making sure the people doing the work are treated like people.&lt;/p&gt;

&lt;p&gt;These are the values that matter to me. It’s ironic that I write these values, on a page, on a website. But there you go.&lt;/p&gt;

&lt;h2 id=&quot;working-full-time-again&quot;&gt;Working full-time, again&lt;/h2&gt;

&lt;p&gt;I joined &lt;a href=&quot;https://www.fatzebra.com/&quot;&gt;a company&lt;/a&gt; in August. I do a little bit more than “crush code” – I’m working on improving this company’s approach to frontend design and tooling. I’m working on building out a design system. And yes, I get to train up other people too. I spend a lot of my time convincing people that the scary frontend boogeyman is just code, like all the rest of the app. You can understand that, so you can understand this, too. Here’s some pretty buttons you can use.&lt;/p&gt;

&lt;p&gt;I have learned a lot about becoming &lt;em&gt;too invested&lt;/em&gt; in the culture and values of the companies I have worked for in the past. I still struggle with that to this day. That ever-burdensome question of: “am I becoming &lt;em&gt;too&lt;/em&gt; attached here?”. Every day I measure how well I would react if today was the day I was told I was being let go. My mental “grab &amp;amp; go bag” still sits, heavy in my brain. Would I be as upset as those three other times?&lt;/p&gt;

&lt;p&gt;The trauma of being let go three times in 13 months left a deep, mental scar. I trusted people to make decisions, and those decisions were unfavourable.&lt;/p&gt;

&lt;p&gt;At my current job, I get told that my work is deeply appreciated and I feel like my opinion is respected. And I share that opinion in at least what I think is a non-asshole way. And I trust people to tell me if or when I’m being one. I can still hold strong opinions around the right way to do things. But I’ve learned to share those opinions in a nicer way. They’ve even trusted me to interview and hire other people.&lt;/p&gt;

&lt;p&gt;But occassionally, the trauma flares up and says “what if this, too, is all bullshit?”. That’s what counselling is for. I’m grateful that the Australian government subsidises these sessions, and even if they didn’t they’re worth more than their full price. I’ve talked through these feelings, and worked out some coping mechanisms. The trauma flares up less occasionally, and when it does I have things to bat it back with. Lights to push back the darkness. It’s forever present, lurking. But I’m armed now, and I am ready for it.&lt;/p&gt;

&lt;p&gt;I wouldn’t say that I am anywhere near as invested in this company’s culture and values as I have been with previous companies. That isn’t to say that I am &lt;em&gt;uncaring&lt;/em&gt; about the culture or values. I am simply not as attached. I still care about the happiness of the people around me. I reckon that’s what’s essential here. If things were to wrap up today, tomorrow or next week, I would probably cope better than those three other times.&lt;/p&gt;

&lt;p&gt;I choose to work full-time again, to become &lt;em&gt;trusting&lt;/em&gt; of a company again, to help with those &lt;em&gt;interloper&lt;/em&gt; consultant feelings.&lt;/p&gt;

&lt;p&gt;I guess that’s an indicator of personal growth. While trauma does happen, we can always &lt;em&gt;grow around&lt;/em&gt; it. To come up against adversarial situations is a part of what makes us human. We are not alone in these situations, as much as it can feel this way sometimes.&lt;/p&gt;

&lt;p&gt;I hope that sharing a little bit about my history and how I’ve worked through it helps you, either today or into the future.&lt;/p&gt;</content><author><name></name></author><summary type="html">It’s been one year since I was fired.</summary></entry><entry><title type="html">A tour of Twist</title><link href="http://localhost:4000/2021/08/a-tour-of-twist" rel="alternate" type="text/html" title="A tour of Twist" /><published>2021-08-11T00:00:00+10:00</published><updated>2021-08-11T00:00:00+10:00</updated><id>http://localhost:4000/2021/08/a-tour-of-twist</id><content type="html" xml:base="http://localhost:4000/2021/08/a-tour-of-twist">&lt;p&gt;When I’m writing &lt;a href=&quot;/books&quot;&gt;my books&lt;/a&gt;, it’s more often than not that reviewers read and review these books on an application that I built myself called &lt;a href=&quot;https://github.com/radar/twist-v2&quot;&gt;Twist&lt;/a&gt;. It looks like this:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/radar/twist-v2/master/preview.png&quot; alt=&quot;Twist&quot; /&gt;&lt;/p&gt;

&lt;p&gt;In this post, I’d like to cover just one half of Twist: the backend half. There’s also a frontend half that’s just as interesting!&lt;/p&gt;

&lt;p&gt;What’s most interesting about this backend application is that it is a Ruby application that is &lt;em&gt;not&lt;/em&gt; a Rails application, and it is &lt;em&gt;not&lt;/em&gt; a Sinatra application. While it borrows inspiration (and gems!) from the Hanami project, it is not a Hanami application. It’s a hybrid application, one that is built on top of some pretty great foundations from those Hanami gems, and also some gems from the &lt;a href=&quot;https://dry-rb.org/&quot;&gt;dry-rb&lt;/a&gt; and &lt;a href=&quot;https://rom-rb.org/&quot;&gt;rom-rb&lt;/a&gt; suites of gems. I’d like to spend this post covering a few key details here about Twist and its unique structure.&lt;/p&gt;

&lt;p&gt;In this post I cover:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;The application container object&lt;/li&gt;
  &lt;li&gt;Sub-system dependencies&lt;/li&gt;
  &lt;li&gt;Entities, Repositories and Relations from rom-rb&lt;/li&gt;
  &lt;li&gt;Receiving webhook requests from GitHub&lt;/li&gt;
  &lt;li&gt;Background jobs&lt;/li&gt;
  &lt;li&gt;Transactions&lt;/li&gt;
  &lt;li&gt;The GraphQL API&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;To cover what Twist does in a nutshell: Twist receives webhook notifications from GitHub after new commits are pushed to a book’s GitHub repository. Twist then reads a book’s Markdown or AsciiDoc files and converts those formats into HTML and stores it in a database. Later on, that HTML is served out through a GraphQL endpoint in the form of books, chapters, and elements. Readers can then read the book and leave notes on the book as they go. I use these notes to improve the quality of the books I write.&lt;/p&gt;

&lt;p&gt;If you want to get an idea of what working on this app is like, I’ve live streamed about 10 hours of active development on this project. &lt;a href=&quot;https://www.youtube.com/watch?v=qWdyo3icsjU&quot;&gt;The first episode is on Youtube here&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;the-application-container&quot;&gt;The application container&lt;/h2&gt;

&lt;p&gt;The application starts off in a similar way to a Rails application. There’s a &lt;code&gt;config.ru&lt;/code&gt; file that goes off and loads &lt;code&gt;config/boot.rb&lt;/code&gt;. That sets up Bundler and Dotenv, configuring the gems and environment necessary for running the application. After that, we come to the application &lt;em&gt;container&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;An application container is a concept from the &lt;code&gt;dry-system&lt;/code&gt; gem. It’s a space to define the components of your application and how they’re loaded. Twist does this with the following code:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;require &apos;dry/system/container&apos;
require &apos;dry/auto_inject&apos;
require &apos;dry/system/loader/autoloading&apos;
require &apos;zeitwerk&apos;

module Twist
  class Container &amp;lt; Dry::System::Container
    config.root = __dir__

    config.component_dirs.loader = Dry::System::Loader::Autoloading
    config.component_dirs.add_to_load_path = false
    config.component_dirs.default_namespace = &apos;twist&apos;

    config.component_dirs.add &quot;lib&quot; do |dir|
      dir.auto_register = true
      dir.default_namespace = &apos;twist&apos;
    end
  end

  Import = Dry::AutoInject(Container)
end

loader = Zeitwerk::Loader.new
loader.inflector.inflect &quot;graphql&quot; =&amp;gt; &quot;GraphQL&quot;
loader.inflector.inflect &quot;cors&quot; =&amp;gt; &quot;CORS&quot;
loader.push_dir Twist::Container.config.root.join(&quot;lib&quot;).realpath
loader.setup
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;When this code defines a container for our application, it specifies &lt;code&gt;component_dirs&lt;/code&gt; for that application. These are directories that contain code that is useful to our application. From here, twist specifies that anything in &lt;code&gt;lib&lt;/code&gt; is something we want to register as components for this application. What’s great about this is that we’ve set this application up to be autoloaded, and so things are only ever loaded when we reference them. You get this feature with Rails, sure, but you also get it in &lt;code&gt;dry-system&lt;/code&gt; too.&lt;/p&gt;

&lt;p&gt;That autoloading is taken care of by the &lt;a href=&quot;https://github.com/fxn/zeitwerk&quot;&gt;Zeitwerk&lt;/a&gt; gem. This gem will notice when you’re referencing a constant like &lt;code&gt;Twist::Entities::Book&lt;/code&gt;, and if that constant hasn’t been loaded, it will attempt to load it from the &lt;code&gt;lib/twist/entities/book.rb&lt;/code&gt; file. Throughout this application, all constants follow this naming pattern of where the path to the file matches the namespacing of the constant.&lt;/p&gt;

&lt;p&gt;There are two special cases for Zeitwerk here where we want to inflect some words different to how Zeitwerk might try to. For &lt;code&gt;GraphQL&lt;/code&gt;, Zeitwerk would look for a directory called &lt;code&gt;graph_q_l&lt;/code&gt; by default. We can inform Zeitwerk should look for a directory called &lt;code&gt;graphql&lt;/code&gt; by specifying that inflection rule near the bottom of this file.&lt;/p&gt;

&lt;p&gt;When this container is finalized (with a call to &lt;code&gt;finalize!&lt;/code&gt; in &lt;code&gt;config/environment.rb&lt;/code&gt;), it will scan through the &lt;code&gt;lib&lt;/code&gt; directory and register everything underneath it as keys within the application container. As a small example of the keys registered, here’s what happens when we ask the container for its keys:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;Twist::Container.keys
=&amp;gt; [&quot;oauth.client&quot;,
 &quot;database&quot;,
 &quot;authorization.book&quot;,
 &quot;entities.book&quot;,
 &quot;entities.book_note&quot;,
 &quot;entities.branch&quot;,
 &quot;entities.chapter&quot;,
 &quot;entities.comment&quot;,
 &quot;entities.commit&quot;,
 &quot;entities.element&quot;,
 &quot;entities.footnote&quot;,
 &quot;entities.image&quot;,
 &quot;entities.note&quot;,
 &quot;entities.note_count&quot;,
 &quot;entities.permission&quot;,
 &quot;entities.reader&quot;,
 &quot;entities.section&quot;,
 &quot;entities.user&quot;,
 ...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;These keys and their naming will be relevant in a minute.&lt;/p&gt;

&lt;h2 id=&quot;system-dependencies&quot;&gt;System Dependencies&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;dry-system&lt;/code&gt; has a concept of system dependencies – parts of your application that you can opt-in to booting along with finalizing your application container. In Twist, we have a large &lt;code&gt;core&lt;/code&gt; dependency in &lt;code&gt;system/boot/core.rb&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;
Twist::Container.boot(:core, namespace: true) do
  use :persistence

  init do
    require &apos;babosa&apos;
    require &apos;redcarpet&apos;
    require &apos;nokogiri&apos;
    require &apos;pygments&apos;
    require &apos;sidekiq&apos;

    require &apos;dry/monads&apos;
    require &apos;dry/monads/do&apos;
  end

end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This file is responsible for requiring the different Ruby libraries that this application will need during its runtime.&lt;/p&gt;

&lt;p&gt;The other file in this directory is called &lt;code&gt;persistence.rb&lt;/code&gt;, and it defines the &lt;code&gt;persistence&lt;/code&gt; system dependency:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;Twist::Container.boot(:persistence) do
  init do
    require &quot;rom-repository&quot;
    require &quot;rom-changeset&quot;
    require &quot;sequel&quot;
  end

  start do
    container = ROM.container(:sql, Sequel.connect(ENV[&apos;DATABASE_URL&apos;]), extensions: [:pg_json]) do |config|
      config.auto_registration(File.expand_path(&quot;lib/twist&quot;))

      # config.gateways[:default].use_logger Logger.new(STDOUT)
    end
    register(:database, container)
  end
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;It is possible to configure these dependencies in such a way that &lt;code&gt;core&lt;/code&gt; &lt;em&gt;could&lt;/em&gt; be booted separately from &lt;code&gt;persistence&lt;/code&gt;, but I haven’t found a reason to uncouple these yet.&lt;/p&gt;

&lt;p&gt;In &lt;code&gt;persistence&lt;/code&gt;, there’s &lt;code&gt;require&lt;/code&gt; statements for the persistence libraries, and then when the application starts up, a new container for ROM is created here. The container for the application that we saw earlier contains configuration for the application. The ROM container contains configuration for the database itself. This new container automatically registers ROM-specific things from &lt;code&gt;lib/twist&lt;/code&gt;, which we’ll look at now.&lt;/p&gt;

&lt;h2 id=&quot;entities-repositories-and-relations&quot;&gt;Entities, Repositories and Relations&lt;/h2&gt;

&lt;p&gt;In order to interact with this database, Twist uses &lt;a href=&quot;https://rom-rb.org&quot;&gt;rom-rb&lt;/a&gt;. Where ActiveRecord would tie everything together in the one class:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://ryanbigg.com/images/maintainable_rails/normal_model_clean.png&quot; alt=&quot;Active Record&quot; /&gt;&lt;/p&gt;

&lt;p&gt;These responsibilities are split out into several distinct classes within ROM-based applications.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Entities: Ruby classes that use &lt;code&gt;ROM::Struct&lt;/code&gt; to define attributes.&lt;/li&gt;
  &lt;li&gt;Relations: Classes that interact with a single database table and where complicated query logic lives.&lt;/li&gt;
  &lt;li&gt;Repositories: Classes that serve as an adapter layer between relations and the application as a whole.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;entities&quot;&gt;Entities&lt;/h3&gt;

&lt;p&gt;Here’s a quick example of an entity class:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;module Twist
  module Entities
    class Book &amp;lt; ROM::Struct
      attribute :id, Types::Integer
      attribute :title, Types::String
      attribute :permalink, Types::String
      attribute :github_user, Types::String
      attribute :github_repo, Types::String

      def path
        git = Git.new(
          username: github_user,
          repo: github_repo,
        )
        git.local_path
      end
    end
  end
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The attributes are defined right in the class, and so we don’t need to go skulking through &lt;code&gt;db/schema.rb&lt;/code&gt; or the database itself or a &lt;code&gt;console&lt;/code&gt; session to figure out what they are. We also get a type-safety of sorts here… if we attempt to assign a number to those string fields, this is what happens:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;Dry::Struct::Error: [Twist::Entities::Book.new] 2 (Integer) has invalid type for :title violates constraints (type?(String, 2) failed)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Whereas a Rails app would just silently coerce the number into a string, &lt;code&gt;ROM::Struct&lt;/code&gt; and its underlying &lt;code&gt;Dry::Struct&lt;/code&gt; do not do that coercion and will warn you before you go ahead and do something you might later regret.&lt;/p&gt;

&lt;p&gt;The &lt;code&gt;path&lt;/code&gt; method here uses attributes from the entity to give us the path to a book on disk.&lt;/p&gt;

&lt;p&gt;Note here that there is absolutely nothing to do with talking to a database in this class. Or validations. Or callbacks. The only code here is code that works with the attributes from the entity itself.&lt;/p&gt;

&lt;h3 id=&quot;repositories--relations&quot;&gt;Repositories &amp;amp; Relations&lt;/h3&gt;

&lt;p&gt;Repositories are used to provide an interface layer between the relation classes that speak with the database and application-specific classes. Once data is returned from a repository, it is no longer possible to make database queries by calling additional methods on those returned objects.&lt;/p&gt;

&lt;p&gt;In order to set this up to use the configuration from &lt;code&gt;persistence.rb&lt;/code&gt;, Twist has a &lt;code&gt;Repository&lt;/code&gt; class that imports the configuration:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;module Twist
  class Repository &amp;lt; ROM::Repository::Root
    struct_namespace ::Twist::Entities

    include Import[container: &quot;database&quot;]
  end
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The &lt;code&gt;include&lt;/code&gt; statement here uses &lt;code&gt;dry-auto_inject&lt;/code&gt; to find the &lt;code&gt;database&lt;/code&gt; key’s configuration, and imports it here as &lt;code&gt;container&lt;/code&gt;. All ROM repositories need to know the &lt;em&gt;container&lt;/em&gt; that they’re operating in, so that they’re aware of which database to speak to.&lt;/p&gt;

&lt;p&gt;A quick example of a repository would be the &lt;code&gt;BranchRepo&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;module Twist
  module Repositories
    class BranchRepo &amp;lt; Twist::Repository[:branches]
      commands :create, use: :timestamps, plugins_options: { timestamps: { timestamps: %i(created_at updated_at) } }

      def by_book(book_id)
        branches.where(book_id: book_id).to_a
      end

      def by_id(id)
        branches.by_pk(id).one
      end

      ...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ROM Repositories do not immediately offer us things such as &lt;code&gt;create&lt;/code&gt; or &lt;code&gt;update&lt;/code&gt; – we have to opt into them. That’s what’s happening here with the first line that specifies &lt;code&gt;commands&lt;/code&gt; here.&lt;/p&gt;

&lt;p&gt;The &lt;code&gt;by_book&lt;/code&gt; and &lt;code&gt;by_id&lt;/code&gt; methods here use another method called &lt;code&gt;branches&lt;/code&gt;. This method is an instance of the &lt;code&gt;Twist::Relations::Branches&lt;/code&gt; class and we can then call methods on that to query the database.&lt;/p&gt;

&lt;p&gt;If we have particularly complicated query logic, we extract that logic out to relations. An example of this is the code from &lt;code&gt;NoteRepo&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;# rubocop:disable Metrics/AbcSize
def count(element_ids, state)
  counts = notes.counts_for_elements(element_ids, state)

  missing = element_ids.select { |id| counts.none? { |c| c.element_id == id } }
  counts += missing.map { |m| Entities::NoteCount.new(element_id: m, count: 0) }
  counts.map { |nc| [nc.element_id, nc.count] }.to_h
end
# rubocop:enable Metrics/AbcSize
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The &lt;code&gt;counts_for_elements&lt;/code&gt; method used here is defined within &lt;code&gt;Twist::Relations::Notes&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;module Twist
  module Relations
    class Notes &amp;lt; ROM::Relation[:sql]
      schema(:notes, infer: true)

      def counts_for_elements(element_ids, state)
        where(element_id: element_ids)
        .where(state: state)
        .select { [element_id, function(:count, :id).as(:count)] }
        .group(:element_id)
        .order(nil)
        .to_a
      end
    end
  end
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;What’s happening here is that we’ve got &lt;em&gt;two&lt;/em&gt; spots of complicated logic: one where we need to query the database for the note counts for a range of elements, and another where we need to do some massaging of that data into &lt;code&gt;Entities::NoteCount&lt;/code&gt; objects. By having the code split up into repositories and relations here, we’re able to have a clear “home” for the code that talks to the database (that’s the relation) and then code that massages that data belongs in the repository. In a typical Rails application, you would throw everything together into one super method in the model.&lt;/p&gt;

&lt;p&gt;This &lt;code&gt;count&lt;/code&gt; method on the &lt;code&gt;NoteRepo&lt;/code&gt; will return a confusing looking hash:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;Twist::Container[&quot;repositories.note_repo&quot;].count([16], &quot;open&quot;)
=&amp;gt; {16=&amp;gt;1}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This hash is not fit for human consumption, but is later sent through an API and then made fit for human consumption. The key is the element ID, and the values are the number of notes for that element.&lt;/p&gt;

&lt;p&gt;How about another example, that &lt;em&gt;is&lt;/em&gt; “fit for human consumption”?&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;Twist::Container[&quot;repositories.branch_repo&quot;].by_book(1)
=&amp;gt; [
  #&amp;lt;Twist::Entities::Branch
    id=1
    name=&quot;master&quot;
    default=true
    book_id=1
    created_at=2021-08-11 14:59:48.203662 +1000
    updated_at=2021-08-11 14:59:48.203662 +1000
  &amp;gt;
]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;When we call the &lt;code&gt;by_book&lt;/code&gt; method on the &lt;code&gt;BranchRepo&lt;/code&gt;, that class reaches out to the &lt;code&gt;branches&lt;/code&gt; relation and performs a &lt;code&gt;where&lt;/code&gt; query, finding all branches for a particular book. When the data comes back from the database, it’s mapped into &lt;code&gt;Twist::Entities::Branch&lt;/code&gt; objects. These entities are then very bare-bones:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;[10] pry(main)&amp;gt; ls Twist::Container[&quot;repositories.branch_repo&quot;].by_book(1).first
#&amp;lt;Dry::Core::Equalizer:0x00007fba268d3140&amp;gt;#methods: freeze  hash
Dry::Core::Equalizer::Methods#methods: ==  eql?
Dry::Struct#methods: []  __attributes__  __new__  attributes  deconstruct_keys  inspect  new  to_h  to_hash
ROM::Struct#methods: fetch
Twist::Entities::Branch#methods: default  id  name
Twist::Entities::Branch#methods: book_id  created_at  updated_at
instance variables: @attributes
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Not counting methods from &lt;code&gt;Object.methods&lt;/code&gt;, there are only 13 methods available on this object. A typical Active Record model will have around 300 different methods, but that varies based on the number of attributes it has too, as it adds in meta-programmed methods like &lt;code&gt;title_will_change?&lt;/code&gt; from &lt;code&gt;ActiveModel::Dirty&lt;/code&gt; and friends. I think 300 methods is a lot.&lt;/p&gt;

&lt;h2 id=&quot;receiving-webhook-requests&quot;&gt;Receiving webhook requests&lt;/h2&gt;

&lt;p&gt;Twist’s primary purpose is to serve as a two-endpoint Rack app. The first endpoint – &lt;code&gt;/books/:permalink/receive&lt;/code&gt; – is used by GitHub’s webhooks system. The second is &lt;code&gt;/graphql&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;GitHub notifies Twist through the “receive” endpoint whenever a book’s repository is updated. The route for this request is defined in the &lt;code&gt;web&lt;/code&gt; part of Twist.&lt;/p&gt;

&lt;p&gt;It’s here that it’s probably best to mention that Twist’s backend is split into two distinct parts. There’s the regular Ruby stuff, and the web stuff.&lt;/p&gt;

&lt;p&gt;The “regular Ruby stuff” includes things like &lt;code&gt;Twist::Entities::Book&lt;/code&gt;, a class that is used to represent data about a book within the application. The “regular” side of the application also includes the relations and repositories that we saw earlier. Let’s not also forget to mention that the “regular” directory also contains &lt;em&gt;transactions&lt;/em&gt;, which are classes that perform one, and only one, transaction within the application. Things like creating a new note, or inviting a new reader to a book.&lt;/p&gt;

&lt;p&gt;Over on the “web” side of the application (&lt;code&gt;lib/twist/web&lt;/code&gt;), you’ll find the stuff you know and love from Rails: your router, your controllers, the actions.&lt;/p&gt;

&lt;p&gt;The router is defined as a Hanami router:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;module Twist
  module Web
    Router = Hanami::Router.new do
      if ENV[&apos;APP_ENV&apos;] == &quot;development&quot;
        require &apos;sidekiq/web&apos;
        mount Sidekiq::Web, at: &apos;/sidekiq&apos;
      end

      post &apos;/graphql&apos;, to: Controllers::GraphQL::Run.new
      options &apos;/graphql&apos;, to: Controllers::GraphQL::Run.new

      post &apos;/books/:permalink/receive&apos;, to: Controllers::Books::Receive.new

      get &apos;/oauth/authorize&apos;, to: Controllers::Oauth::Authorize.new
      get &apos;/oauth/callback&apos;, to: Controllers::Oauth::Callback.new
    end
  end
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;As you can see from this code, routes do not route to one giant controller class with several actions inside it. Instead, each action is its own class. This concept makes it much easier to jump to the code for one particular action, without being confused about what code is relevant to which action inside a controller – like what might happen to you in a standard Rails application. An example of this is that the &lt;code&gt;authorize&lt;/code&gt; and &lt;code&gt;callback&lt;/code&gt; actions associated with the OAuth parts of this application are their own separate classes here.&lt;/p&gt;

&lt;p&gt;We’re straying a little off track there, so let’s get back on track: the &lt;code&gt;/books/:permalink/receive&lt;/code&gt; route. That route goes to the &lt;code&gt;Controllers::Books::Receive&lt;/code&gt; action, which is defined in &lt;code&gt;lib/twist/web/controllers/books/receive.rb&lt;/code&gt;. Note here that the path here matches the constant – this is something that Zeitwerk enforces so that it can automatically load our constant when we need it.&lt;/p&gt;

&lt;p&gt;This controller starts out in an interesting way:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;module Twist
  module Web
    module Controllers
      module Books
        class Receive &amp;lt; Hanami::Action
          include Twist::Import[
            find_book: &quot;transactions.books.find&quot;,
            find_or_create_branch: &quot;transactions.branches.find_or_create&quot;
          ]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;An &lt;em&gt;include&lt;/em&gt; statement at the top of a controller that isn’t doing something like &lt;code&gt;include ApplicationHelper&lt;/code&gt;? This certainly seems like some sort of black magic – at least that’s what I thought when I originally saw it.&lt;/p&gt;

&lt;p&gt;What this is doing is including two helpful transactions from within our application’s container. This code will find the classes registered under the keys &lt;code&gt;transactions.books.find&lt;/code&gt; and &lt;code&gt;transactions.branches.find_or_create&lt;/code&gt; and it will load those classes at this point. Not only are these classes loaded, but new instances of these classes are initialized at this point too. And &lt;em&gt;not only that&lt;/em&gt;, but these instances are then made available through the methods &lt;code&gt;find_book&lt;/code&gt; and &lt;code&gt;find_or_create_branch&lt;/code&gt; within this controller.&lt;/p&gt;

&lt;p&gt;This is made possible by another dry-rb gem called &lt;code&gt;dry-auto_inject&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Later on this controller, we can refer to these instances and call the &lt;code&gt;call&lt;/code&gt; method on these transactions by writing code such as:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;book = find_book.(permalink: req.params[:permalink])
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;branch = find_or_create_branch.(book_id: book.id, ref: payload[&quot;ref&quot;])
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;It’s worth noting that similar includes / imports can be found in those transaction classes too:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;module Twist
  module Transactions
    module Books
      class Find
        include Twist::Import[&quot;repositories.book_repo&quot;]

        def call(permalink:)
          book_repo.find_by_permalink(permalink)
        end
      end
    end
  end
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The benefit here of using &lt;code&gt;dry-auto_inject&lt;/code&gt; is that we can quickly include dependencies from across our application into other classes. &lt;code&gt;dry-auto_inject&lt;/code&gt; works by re-defining the &lt;code&gt;initialize&lt;/code&gt; method wherever it is used to something similar to this:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;def initialize(find_book: Twist::Container[&apos;transactions.books.find&apos;], find_or_create_branch: Twist::Container[&apos;transactions.branches.find_or_create&apos;])
  @find_book = find_book
  @find_or_create_branch = find_or_create_branch
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This means that we &lt;em&gt;could&lt;/em&gt; change away from the default values here to something else entirely. A good example of where we might like to do that is within tests. You’ll see an example of this over in &lt;code&gt;backend/spec/twist_web/controllers/books/receive_spec.rb&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;describe Twist::Web::Controllers::Books::Receive do
  let(:find_or_create_branch) do
    -&amp;gt;(book_id:, ref:) { branch }
  end

  subject do
    described_class.new(
      find_or_create_branch: find_or_create_branch,
      ...
    )
  end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The test for this action immediately stubs out &lt;code&gt;find_or_create_branch&lt;/code&gt; and will return a &lt;code&gt;branch&lt;/code&gt; object for whatever’s passed in. Later on in the test, that variable is defined as:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;let(:branch) { double(Twist::Entities::Branch, name: &quot;master&quot;) }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This means that we don’t need to set up messy test data within factories – we can stub out our transactions to return simple doubles here instead. This means that the tests for this controller action are remarkably quick. In fact, by following this pattern throughout the whole application all of the application’s tests are remarkably quick! The slowest ones are ones that need to interact with a filesystem.&lt;/p&gt;

&lt;p&gt;There are about 150 tests for this application so far and they take about 12 seconds to run.&lt;/p&gt;

&lt;p&gt;Speaking of: when Twist receives a book, it enqueues that book for processing through one of its processor classes, either &lt;code&gt;Twist::Processors::Markdown::BookWorker&lt;/code&gt; or its AsciiDoc equivalent. Let’s look at what happens then.&lt;/p&gt;

&lt;h2 id=&quot;background-jobs&quot;&gt;Background jobs&lt;/h2&gt;

&lt;p&gt;Receiving a webhook from GitHub takes a very short time. I really wish I could say the same for processing a book! However, there are some complexities here.&lt;/p&gt;

&lt;p&gt;First, Twist needs to pull the latest changes from GitHub. By this point, Twist has only been &lt;em&gt;notified&lt;/em&gt; that changes have happened – it doesn’t exactly know what’s changed. Twist runs a background job with Sidekiq that does a &lt;code&gt;git pull&lt;/code&gt; on the book’s Git repository. From there, Twist will read each of the book’s chapters in a &lt;em&gt;separate&lt;/em&gt; background job and convert the chapters into HTML. From there, it processes each individual HTML element using classes such as &lt;code&gt;Twist::Processors::Markdown::ElementProcessor&lt;/code&gt;. I won’t go so much into this code, as it’s more Twist-specific than applicable to other codebases.&lt;/p&gt;

&lt;p&gt;The complexities here involve downloading the code from GitHub, and uploading the images to S3. Each image is processed as &lt;em&gt;another&lt;/em&gt; async job separate from the book and chapter async workers. The main issue here is that, for a few brief seconds, the &lt;em&gt;words&lt;/em&gt; of a chapter can be available on Twist, but sometimes the images will not have finished processing.&lt;/p&gt;

&lt;p&gt;In the end, what we end up with in the database is a new commit from GitHub tied to the book, and under that commit are the relevant chapters, and under those chapters their elements, such as section headings, paragraphs and images.&lt;/p&gt;

&lt;h2 id=&quot;transactions&quot;&gt;Transactions&lt;/h2&gt;

&lt;p&gt;Transactions are classes within Twist that perform a single operation / action / transaction. Let’s look at how a JWT is decoded within Twist.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;module Twist
  module Transactions
    module Users
      class FindCurrentUser &amp;lt; Transaction
        include Twist::Import[&quot;repositories.user_repo&quot;]

        def call(token)
          return Failure(&quot;no token specified&quot;) if !token || token.length == 0

          token = token.split.last
          return Failure(&quot;no token specified&quot;) unless token

          payload, _headers = JWT.decode token, ENV.fetch(&apos;AUTH_TOKEN_SECRET&apos;), true, algorithm: &apos;HS256&apos;
          user = user_repo.find_by_email(payload[&quot;email&quot;])
          user ? Success(user) : Failure(&quot;no user found&quot;)
        end
      end
    end
  end
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This class inherits from &lt;code&gt;Twist::Transaction&lt;/code&gt;, and that class defines some common transaction things:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;module Twist
  class Transaction
    def self.inherited(base)
      base.include Dry::Monads[:result]
      base.include Dry::Monads::Do.for(:call)
    end

    def permission_denied!
      Failure(&quot;You must be an author to do that.&quot;)
    end
  end
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The &lt;code&gt;dry-monads&lt;/code&gt; gem here provides &lt;code&gt;Result&lt;/code&gt; objects, which can be used to short-circuit the execution of transactions to bail out early if things are going wrong. In the &lt;code&gt;call&lt;/code&gt; method of this transaction, we have failure cases where the token might be missing or too short, or if a user couldn’t be found that matched a provided token. We have a single &lt;code&gt;Success()&lt;/code&gt; case if the user could be found here.&lt;/p&gt;

&lt;p&gt;We’re able to assert on the outcome of this transaction by calling &lt;code&gt;.success?&lt;/code&gt; or &lt;code&gt;.failure?&lt;/code&gt; on it, as indicated by this class’s tests:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;require &quot;spec_helper&quot;

module Twist
  describe Transactions::Users::FindCurrentUser do
    include Twist::Import[
      &quot;transactions.users.generate_jwt&quot;,
      create_user: &quot;transactions.users.create&quot;
    ]

    let(:user) do
      create_user.(
        email: &quot;me@ryanbigg.com&quot;,
        name: &quot;Ryan Bigg&quot;,
        password: &quot;password&quot;,
        github_login: &quot;radar&quot;,
      ).success
    end

    let(:token) { generate_jwt.(email: user.email).success }

    it &quot;finds a user by a given JWT token&quot; do
      result = subject.(token)
      expect(result).to be_success
      expect(result.success).to eq(user)
    end

    it &quot;finds no user with a nil token&quot; do
      result = subject.(nil)
      expect(result).to be_failure
    end

    it &quot;finds no user with a blank token&quot; do
      result = subject.(&quot;&quot;)
      expect(result).to be_failure
    end
  end
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The benefit of using &lt;code&gt;Success&lt;/code&gt; and &lt;code&gt;Failure&lt;/code&gt; objects from &lt;code&gt;dry-monads&lt;/code&gt; is that we can easily check for the success or failure of any transaction within the application.&lt;/p&gt;

&lt;h2 id=&quot;graphql&quot;&gt;GraphQL&lt;/h2&gt;

&lt;p&gt;As I mentioned at the start of this post, Twist is two distinct applications – a frontend application written in TypeScript + React and a backend application written in Ruby. To get the two to communicate nicely with each other I use GraphQL. GraphQL is &lt;em&gt;great&lt;/em&gt; here as we can easily define the types of objects on the Ruby side of things, and have those &lt;em&gt;same types&lt;/em&gt; available in the frontend.&lt;/p&gt;

&lt;p&gt;Requests come in through the router and head to the &lt;code&gt;Twist::Web::Controllers::GraphQL::Run&lt;/code&gt; action. This action sets up a &lt;code&gt;Twist::Web::GraphQL::Runner&lt;/code&gt; to run the queries themselves. This second class exists so that I can test GraphQL queries separate from a request / response stack if I need to.&lt;/p&gt;

&lt;p&gt;Ultimately, this code path leads us to &lt;code&gt;twist/web/graphql/query_type.rb&lt;/code&gt;, which defines fields and how they’re resolved for queries:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;module Twist
  module Web
    module GraphQL
      class QueryType &amp;lt; ::GraphQL::Schema::Object
        graphql_name &quot;Query&quot;
        description &quot;The query root of this schema&quot;

        field :books, [Types::Book], null: false, resolver: Resolvers::Books
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The types are defined like this:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;module Twist
  module Web
    module GraphQL
      module Types
        class Book &amp;lt; ::GraphQL::Schema::Object
          graphql_name &quot;Book&quot;
          description &quot;A book&quot;

          field :id, ID, null: false
          field :title, String, null: false
          field :blurb, String, null: false
          field :permalink, String, null: false
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;While the resolver above is defined like this:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;module Twist
  module Web
    module GraphQL
      module Resolvers
        class Books &amp;lt; Resolver
          def resolve
            books = context[:book_repo].all
            books.select do |book|
              authorization = Authorization::Book.new(
                book: book,
                user: current_user,
                permission_repo: context[:permission_repo],
              )
              authorization.success?
            end
          end
        end
      end
    end
  end
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;It’s tempting to me to move most of this logic of the resolver out to a distinct &lt;code&gt;Twist::Transaction&lt;/code&gt; class, but this code is only used within the resolver here. I think I would move it out to that transaction if I wanted to share it across the different parts of the application.&lt;/p&gt;

&lt;p&gt;It’s important to note here that because we’re in GraphQL-land, we do as the GraphQL’ers do and read things like the &lt;code&gt;book_repo&lt;/code&gt; and &lt;code&gt;permission_repo&lt;/code&gt; from the context, rather than include-importing them. This then groups together all different context-related things into one variable, rather than having to chop and change between context and imported values.&lt;/p&gt;

&lt;p&gt;When writing these GraphQL queries, I’ll typically start building out something in the frontend first. Once I’m happy with the structure, I’ll map that to a GraphQL query and then write a spec around it before writing the Ruby code to fulfill the query. Here’s the related spec for this &lt;code&gt;books&lt;/code&gt; query:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;require &quot;requests_helper&quot;

module Twist
  describe &quot;Books&quot;, type: :request do
    let(:create_book) { Twist::Container[&quot;transactions.books.create&quot;] }
    let!(:create_user) { Twist::Container[&quot;transactions.users.create&quot;] }
    let!(:grant_permission) { Twist::Container[&quot;transactions.users.grant_permission&quot;] }
    let!(:book) { create_book.(title: &quot;Rails 4 in Action&quot;, default_branch: &quot;master&quot;).success }

    let!(:user) do
      create_user.(
        email: &quot;me@ryanbigg.com&quot;,
        password: &quot;password&quot;,
        name: &quot;Ryan Bigg&quot;,
      ).success
    end

    before do
      grant_permission.(user: user, book: book)
    end

    it &quot;gets a list of books&quot; do
      query = &amp;lt;&amp;lt;~QUERY
      {
        books {
          id
          permalink
          title
          defaultBranch {
            name
          }
        }
      }
      QUERY

      query!(query: query, user: user)
      expect(json_body).to eq({
        &quot;data&quot; =&amp;gt; {
          &quot;books&quot; =&amp;gt; [
            {
              &quot;id&quot; =&amp;gt; book.id.to_s,
              &quot;permalink&quot; =&amp;gt; book.permalink,
              &quot;title&quot; =&amp;gt; book.title,
              &quot;defaultBranch&quot; =&amp;gt; {
                &quot;name&quot; =&amp;gt; &quot;master&quot;
              }
            }
          ]
        }
      })
    end
  end
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;It’s important to note here that the request specs in this application are the only place where we’re interacting with a database. I feel like this is necessary to ensure that the queries are working completely from end-to-end. If I was to stub something here, there’s no guarantee that the shape of what I’m stubbing matches exactly the shape of what would be returned by a database query.&lt;/p&gt;

&lt;p&gt;So instead of hoping / praying that my stubbing is correct, I instead create real objects for books, users and permissions in this test. When the GraphQL query runs, it gets served by the real action and that queries a real (test) database and I can then assert that the data being returned here is what I intended it to be.&lt;/p&gt;

&lt;p&gt;What’s really great here is that if I change the query on the frontend, I can just copy and paste it right into this spec without having to map it to something Ruby-ish. The same principle applies if I’m going the other way too. I really like that about GraphQL.&lt;/p&gt;

&lt;p&gt;The final thing I’ll mention about GraphQL is that over in the &lt;code&gt;Rakefile&lt;/code&gt; for this application I have a task setup to dump the GraphQL schema out:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;require &quot;graphql/rake_task&quot;

GraphQL::RakeTask.new(
  schema_name: &quot;Twist::Web::GraphQL::Schema&quot;,
  directory: &quot;../graphql&quot;,
  dependencies: [:environment]
)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This dumps out a &lt;code&gt;graphql/schema.graphql&lt;/code&gt; file as well as a &lt;code&gt;graphql/schema.json&lt;/code&gt; file. These files are then read by some frontend tasks to automatically generate TypeScript types using the &lt;code&gt;graphql-codegen&lt;/code&gt; library. This is then used to ensure that the types that I’ve defined in the GraphQL schema are &lt;em&gt;exactly&lt;/em&gt; matching to the ones used over in the frontend. Without this, I reckon ensuring consistency between the backend and frontend applications would’ve been a major headache.&lt;/p&gt;

&lt;h2 id=&quot;summary&quot;&gt;Summary&lt;/h2&gt;

&lt;p&gt;So there you have it, a grand tour of the Twist application with my favourite highlights. I really enjoy working within this application, moreso than any Rails application that I’ve ever touched. And sure, that might be because I was the one who wrote this app and I’m the only one who maintains it.&lt;/p&gt;

&lt;p&gt;But, really, it’s more than that.&lt;/p&gt;

&lt;p&gt;The clean layers of separation between things like the entities, repositories and relations make it really easy to reason about where code should go.&lt;/p&gt;

&lt;p&gt;Transactions provide me a clear way of separating out application operations away from code that might’ve otherwise gone inside actions. I can then share this code between different parts of my application easily without worrying about having to untie it from a controller’s grasp.&lt;/p&gt;

&lt;p&gt;And the GraphQL API provides a clear, distinct layer between my backend and frontend application parts, while still allowing an enforcement of the datatypes across the barrier.&lt;/p&gt;

&lt;p&gt;It’s really a joy to work in.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;If you like what you see in this post, you might also like to read my book &lt;a href=&quot;https://leanpub.com/maintain-rails/c/opinions&quot;&gt;Maintainable Rails&lt;/a&gt; which is just $5 at the moment. This book demonstrates how to bring the concepts shown in this post into a brand new Rails application, ultimately leading to an application that is easier to maintain in the long-term.&lt;/p&gt;</content><author><name></name></author><summary type="html">When I’m writing my books, it’s more often than not that reviewers read and review these books on an application that I built myself called Twist. It looks like this:</summary></entry><entry><title type="html">On coding tests</title><link href="http://localhost:4000/2021/07/on-coding-tests" rel="alternate" type="text/html" title="On coding tests" /><published>2021-07-27T00:00:00+10:00</published><updated>2021-07-27T00:00:00+10:00</updated><id>http://localhost:4000/2021/07/on-coding-tests</id><content type="html" xml:base="http://localhost:4000/2021/07/on-coding-tests">&lt;p&gt;As you might know, I’ve been &lt;a href=&quot;https://ryanbigg.com/2021/07/job-hunt-q2-2021&quot;&gt;job hunting recently&lt;/a&gt;. I’m at the part of this step for some companies where we’ve had our initial conversation and now they want me to do a coding test.&lt;/p&gt;

&lt;p&gt;But that’s okay, because it “should only take up to 3 hours to do”. Now let’s theoretically say that I’m talking with 5 companies now. That’s &lt;em&gt;15 hours&lt;/em&gt; of my time, that I have to pull out of work, life or sleep, to do these coding tests. All to prove to them that I can code!&lt;/p&gt;

&lt;p&gt;This strikes me as odd because I’m pretty sure I can code.&lt;/p&gt;

&lt;p&gt;I’ve been employed as a developer in one way or another since 2004. That’s 17 years! I’ve had to pass other coding tests in the past to get some of those jobs. I had a lot more free time in my youth and wasn’t such a crotchety old man like I am now.&lt;/p&gt;

&lt;p&gt;I’ve &lt;a href=&quot;https://ryanbigg.com/books&quot;&gt;written books&lt;/a&gt; where I try to teach other people how to code. If I don’t know how to code, how could I teach other people to code? Mystery!&lt;/p&gt;

&lt;p&gt;I’ve recently &lt;a href=&quot;https://www.youtube.com/watch?v=qWdyo3icsjU&quot;&gt;released a 6-part screencast series&lt;/a&gt; where I demonstrate my ability to code in not one, but THREE different languages &lt;strong&gt;AT THE SAME TIME&lt;/strong&gt;! I’m clearly not a 10x developer. Maybe a 3x developer?&lt;/p&gt;

&lt;p&gt;I’ve even made the &lt;a href=&quot;https://github.com/radar/twist-v2&quot;&gt;codebase from that screencast series completely open source&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I’m also responsible for maintaining the &lt;a href=&quot;https://github.com/ruby-i18n/i18n&quot;&gt;12th-most-downloaded Ruby Gem – i18n&lt;/a&gt;. Yeah, this is code that I’ve (unlikely) written or (likely) vetted &amp;amp; approved that’s &lt;em&gt;probably running in your Rails application right now&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;But no, these things don’t count for &lt;em&gt;anything&lt;/em&gt; in the interview process. Maybe I’ve gone too far down the path of tying my self-worth up in these things. The way I feel is: if you don’t value these things I’ve &lt;em&gt;already done&lt;/em&gt;, then you do not value me.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;I can read the replies now:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;but how do we know that you really know how to code, according to our 100% bias-free baseline?&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;We have subjected our other developers to this antiquated hazing ritual so why shouldn’t we subject you to the same?&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Fact is, you don’t. Some people can code really well in interviews and have had lots of practice answering how exactly you go about reversing a purple linked list uphill both ways in the snow. Some people struggle with the pressure of developing something &lt;em&gt;completely solo&lt;/em&gt; and then having that scruitinised in an hour-long live-code-review session.&lt;/p&gt;

&lt;p&gt;I’m personally &lt;em&gt;done&lt;/em&gt; with being hazed in this way. You know I can code. I have proven this with my long tenure in this industry and the stuff I’ve put out in the world.&lt;/p&gt;

&lt;p&gt;Let’s just get down to business. I’ll happily trade labour for dollars. Hold the haze. Use the books, code and screencast I’ve already put out in order to judge my abilities.&lt;/p&gt;</content><author><name></name></author><summary type="html">As you might know, I’ve been job hunting recently. I’m at the part of this step for some companies where we’ve had our initial conversation and now they want me to do a coding test.</summary></entry><entry><title type="html">Using Ruby 2.7’s new triple-dot syntax to clean up service objects</title><link href="http://localhost:4000/2021/07/ruby-27s-new-triple-dot-syntax" rel="alternate" type="text/html" title="Using Ruby 2.7’s new triple-dot syntax to clean up service objects" /><published>2021-07-21T00:00:00+10:00</published><updated>2021-07-21T00:00:00+10:00</updated><id>http://localhost:4000/2021/07/ruby-27s-new-triple-dot-syntax</id><content type="html" xml:base="http://localhost:4000/2021/07/ruby-27s-new-triple-dot-syntax">&lt;p&gt;In big Rails projects there’s been a bit of a push to move things out to &lt;em&gt;service objects&lt;/em&gt;. You might recognise these from their appearance in things like controllers:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;CreateBook.new.call(book_params)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The &lt;code&gt;CreateBook&lt;/code&gt; class itself might look like this:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;class CreateBook
  include Dry::Monads[:do, :result]

  def call(params)
    book_params = yield validate(params)
    create_book(book_params)
  end
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In order to access that instance &lt;code&gt;call&lt;/code&gt; method from the controller, we must first create an instance of this &lt;code&gt;CreateBook&lt;/code&gt; class. This makes our code &lt;em&gt;slightly&lt;/em&gt; messy because we must always &lt;code&gt;new&lt;/code&gt; before we &lt;code&gt;call&lt;/code&gt;. The &lt;code&gt;call&lt;/code&gt; here &lt;em&gt;must&lt;/em&gt; be an instance method because we’ve included &lt;code&gt;Dry::Monads&lt;/code&gt; methods within instances of this class, as per the best-practices when using that gem.&lt;/p&gt;

&lt;p&gt;However, we can tidy things up here by using Ruby 2.7’s new triple-dot syntax. This syntax is another special type of argument, used in the same place you might use positional or keyword arguments. We can use triple-dots to pass arguments from a class method down to an instance method, like in this example:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;class CreateBook
  include Dry::Monads[:do, :result]

  def self.call(...)
    new.call(...)
  end

  def call(params)
    book_params = yield validate(params)
    create_book(book_params)
  end
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Anytime the &lt;code&gt;call&lt;/code&gt; method on the &lt;em&gt;class&lt;/em&gt; is called, a new &lt;code&gt;CreateBook&lt;/code&gt; &lt;em&gt;instance&lt;/em&gt; is created, then those arguments from the class-level &lt;code&gt;call&lt;/code&gt; are passed to the instance-level &lt;code&gt;call&lt;/code&gt;. By defining this new &lt;code&gt;call&lt;/code&gt; method on the class itself, we can then change our controller to this:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;CreateBook.call(book_params)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This makes our code out to the &lt;code&gt;CreateBook&lt;/code&gt; class from wherever we’re using it slightly easier, while still allowing us to create &amp;amp; use instances of &lt;code&gt;CreateBook&lt;/code&gt; if we wish. One particular case where that might come in handy is if you wanted to inject a dependency here:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-ruby&quot;&gt;CreateBook.new(book_repository: book_repo).call(book_params)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;But that’s a story for another day.&lt;/p&gt;</content><author><name></name></author><summary type="html">In big Rails projects there’s been a bit of a push to move things out to service objects. You might recognise these from their appearance in things like controllers:</summary></entry><entry><title type="html">Job Hunt Q2 2021</title><link href="http://localhost:4000/2021/07/job-hunt-q2-2021" rel="alternate" type="text/html" title="Job Hunt Q2 2021" /><published>2021-07-19T00:00:00+10:00</published><updated>2021-07-19T00:00:00+10:00</updated><id>http://localhost:4000/2021/07/job-hunt-q2-2021</id><content type="html" xml:base="http://localhost:4000/2021/07/job-hunt-q2-2021">&lt;p&gt;After &lt;a href=&quot;https://ryanbigg.com/2021/04/finding-a-new-contract-gig&quot;&gt;wrapping up a contract&lt;/a&gt; earlier in the year, I wrote a post about how I looked for a future job. Now it’s around about the time that &lt;em&gt;that&lt;/em&gt; job is wrapping up. So why not write another post about this hunt? Maybe there are some things that are different.&lt;/p&gt;

&lt;p&gt;Last time I pitched myself as a “mercenary developer wizard”. While I enjoy developing code, nothing brings more joy than developing &lt;em&gt;people&lt;/em&gt;. Running the Culture Amp JEP was some of the most fun-at-work I’ve had. I would love to do that stuff again. So I’ve been pitching myself this time as someone who would rather be developing people, than developing code. I could definitely do both!&lt;/p&gt;

&lt;p&gt;The appetite for this sort of work has been incredibly lacking. It appears from my perspective that more companies are &lt;em&gt;still&lt;/em&gt; more interested in hiring senior “mercenary developer wizards” who can “crush code”, than training up &lt;em&gt;any&lt;/em&gt; developers at all.&lt;/p&gt;

&lt;p&gt;I’ve been &lt;a href=&quot;https://ryanbigg.com/2019/09/hiring-juniors-2019&quot;&gt;banging the drum around hiring juniors&lt;/a&gt; for almost a decade. For the status quo to remain the same for this time is disheartening. Perhaps the developer drought is not severe enough for companies to act. The impetus is not strong enough. &lt;em&gt;Despite&lt;/em&gt; all these companies being so ravenously thirsty for senior developers.&lt;/p&gt;

&lt;p&gt;I dearly, desperately want a job where I am not &lt;em&gt;just&lt;/em&gt; somebody who can crush code, but someone who gets to work with other people to improve their skills. That’s my jam. That’s where I get the joy.&lt;/p&gt;

&lt;p&gt;But, fine. Okay. That job doesn’t (seemingly) exist.&lt;/p&gt;

&lt;p&gt;I need to be real.&lt;/p&gt;

&lt;p&gt;So I’ll just go and pick up a senior dev role at some shop somewhere, “crush code” and earn a paycheck so I can pay my mortgage.&lt;/p&gt;

&lt;p&gt;I’m disheartened by the current outcomes from the current iteration of the job hunting process, but things have changed before and might change again.&lt;/p&gt;

&lt;p&gt;Always the next step.&lt;/p&gt;</content><author><name></name></author><summary type="html">After wrapping up a contract earlier in the year, I wrote a post about how I looked for a future job. Now it’s around about the time that that job is wrapping up. So why not write another post about this hunt? Maybe there are some things that are different.</summary></entry></feed>