<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

 <title>Ryan Bigg's Blog</title>
 <link href="https://ryanbigg.com/atom.xml" rel="self"/>
 <link href="https://ryanbigg.com"/>
 <updated>2023-08-29T08:58:09+10:00</updated>
 <id>https://ryanbigg.com/</id>
 <author>
   <name>Ryan Bigg</name>
   <email>me@ryanbigg.com</email>
 </author>

 
 <entry>
   <title>Saving time with fzf</title>
   <link href="https://ryanbigg.com/2023/08/saving-time-with-fzf"/>
   <updated>2023-08-27T00:00:00+10:00</updated>
   <id>https://ryanbigg.com/2023/08/saving-time-with-fzf</id>
   <content type="html"><![CDATA[<p>One of my favourite terminal utilities is <a href="https://github.com/junegunn/fzf">a little utility called fzf</a> (fuzzy finder). It’s how I save a bunch of time by not writing out commands, or even remembering them.</p>

<h2 id="command-history">Command history</h2>

<p>The thing I use fzf for the most is command history. To access the history, I use Ctrl+R and I get a list of my most recent commands:</p>

<pre><code>10024 z ryanbigg
10026 bundle exec jekyll serve
</code></pre>

<p>(The numbers represent the position of that command in my <code>.zsh_history</code> file.)</p>

<p>If I then write the word “serve”, fzf will only show me commands with that word in it:</p>

<pre><code>10026 serve
</code></pre>

<p>I usually use this for running some different Rails apps on certain ports. So I would hit Ctrl+R, and then type a particular port number such as 3004 to get:</p>

<pre><code>10007 bundle exec rails s -p 3004
</code></pre>

<p>Instead of typing out the full command, I can type Ctrl+R and 4 keystrokes later arrive at the right command.</p>

<h2 id="files-in-current-directory">Files in current directory</h2>

<p>Another thing I use fzf for is its relative file searching. Most of the time, I’m using this to run RSpec tests. I type:</p>

<pre><code>ber
</code></pre>

<p>(Which is my alias for “bundle exec rspec”), and then I hit Ctrl+T and I get a list of files in my terminal:</p>

<pre><code>app
app/models
app/models/category.rb
...
</code></pre>

<p>Then I can type a few words, or even parts of words, to get what I’m after. In this example, I’d like to find the file at <code>spec/requests/graphql/queries/repo_categories_spec.rb</code>. What a mouthful! With <code>fzf</code>, I can type <code>repocat</code> and arrive at that spec in only seven keystrokes:</p>

<pre><code>spec/requests/graphql/queries/repo_categories_spec.rb
&lt;other files here&gt;
</code></pre>

<p>When I hit enter here, my <code>ber</code> command becomes:</p>

<pre><code>ber spec/requests/graphql/queries/repo_categories_spec.rb
</code></pre>

<p>Then I can run this test.</p>

<p>(If I’ve run this command before, I might use <code>Ctrl+R</code> to find the “full version” of <code>ber</code> + the file path!)</p>

<h2 id="filtering-output">Filtering output</h2>

<p>Finally, the last way I use <code>fzf</code> is to filter output. You can pipe a list of inputs to <code>fzf</code> and it will provide its fuzzy finding features on that list.</p>

<p>The way I use this the most is this very complicated looking function:</p>

<pre><code>fbr () {
	local branches branch
	branches=$(git for-each-ref --count=30 --sort=-committerdate refs/heads/ --format="%(refname:short)")  &amp;&amp; branch=$(echo "$branches" |
  fzf-tmux -d $(( 2 + $(wc -l &lt;&lt;&lt; "$branches") )) +m)  &amp;&amp; git checkout $(echo "$branch" | sed "s/.* //" | sed "s#remotes/[^/]*/##")
}
</code></pre>

<p>I didn’t come up with this myself, but I borrowed it from elsewhere.</p>

<p>This command finds the 30 most recent Git branches (surely more than adequate!) and provides a way of filtering through them. Here’s what I see when I run <code>fbr</code> in a gem I have checked out:</p>

<pre><code>patch-1
fix-locale-with-separator
prep-1-1-4
...
</code></pre>

<p>If I type the word <code>locale</code> and hit enter, the <code>git checkout</code> command will switch me into that branch.</p>

<p>I find this one really useful when I can only half-remember a branch name, or if I’ve got a branch with an issue number in it, then I can jump straight to that branch if I know the number.</p>
]]></content>
 </entry>
 
 <entry>
   <title>Ubuntu, Ruby, Selenium Manager, Chrome and ChromeDriver</title>
   <link href="https://ryanbigg.com/2023/08/ubuntu-ruby-selenium-manager-chrome-and-chromedriver"/>
   <updated>2023-08-22T00:00:00+10:00</updated>
   <id>https://ryanbigg.com/2023/08/ubuntu-ruby-selenium-manager-chrome-and-chromedriver</id>
   <content type="html"><![CDATA[<p><a href="/2023/08/alpine-linux-selenium-manager-chrome-and-chromedriver">This is a rehash of my Alpine Linux version of this post</a>. I’ll skip the fluff here and jump straight to the good stuff.</p>

<p>The packages needed for Chromedriver are:</p>

<pre><code>libnss3 libnspr4
</code></pre>

<p>The packages needed for Chrome are:</p>

<pre><code>libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxfixes3 libxrandr2 libgbm1 libasound2
</code></pre>

<p>(There’s also a package called <code>chromium-shell</code> that installs all of these necessary dependencies, and at least half a kitchen sink too. The install time for this package is very long.)</p>

<p>The <code>Dockerfile</code> is therefore:</p>

<pre><code>FROM ruby:3.2.2

RUN apt-get update &amp;&amp; apt-get install libnss3 libnspr4 libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxfixes3 libxrandr2 libgbm1 libasound2

# OR this, but the install time is much longer:
# RUN apt-get update &amp;&amp; apt-get install chromium-shell

RUN adduser --disabled-password --gecos "" app
COPY --chown app:app . /app
WORKDIR /app
USER app

RUN bundle config set --local path vendor/bundle
RUN bundle install
CMD bundle exec irb
</code></pre>

<p>And we can then build and run this image:</p>

<pre><code>docker build . -t ubuntu-selenium
docker run -it ubuntu-selenium
</code></pre>

<p>And confirm it works by running:</p>

<pre><code class="language-ruby">Bundler.require

Selenium::WebDriver.logger.level = Logger::DEBUG

options = ::Selenium::WebDriver::Chrome::Options.new

options.add_argument("--headless")
options.add_argument("--no-sandbox")
options.add_argument("--disable-dev-shm-usage")
options.add_argument("--disable-gpu")

Selenium::WebDriver.for :chrome, capabilities: options
</code></pre>

<p>This output should include things like a check for both Chrome + ChromeDriver, which will fail:</p>

<pre><code>DEBUG Selenium [:selenium_manager] Checking chromedriver in PATH
DEBUG Selenium [:selenium_manager] Running command: chromedriver --version
DEBUG Selenium [:selenium_manager] Output: ""
DEBUG Selenium [:selenium_manager] chromedriver not found in PATH
DEBUG Selenium [:selenium_manager] Checking chrome in PATH
DEBUG Selenium [:selenium_manager] Running command: which chrome
DEBUG Selenium [:selenium_manager] Output: ""
DEBUG Selenium [:selenium_manager] chrome not found in PATH
DEBUG Selenium [:selenium_manager] chrome has not been discovered in the system
</code></pre>

<p>(The chrome one fails here, as <code>chromium</code> has installed Chrome at <code>/usr/bin/chromium</code>.)</p>

<p>After that, we’ll see log lines for downloads of Chrome + ChromeDriver:</p>

<pre><code>DEBUG Selenium [:selenium_manager] Reading metadata from https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json
DEBUG Selenium [:selenium_manager] Required browser: chrome 116.0.5845.96
DEBUG Selenium [:selenium_manager] Downloading chrome 116.0.5845.96 from https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/116.0.5845.96/linux64/chrome-linux64.zip
DEBUG Selenium [:selenium_manager] chrome 116.0.5845.96 has been downloaded at /home/app/.cache/selenium/chrome/linux64/116.0.5845.96/chrome
DEBUG Selenium [:selenium_manager] Reading metadata from https://googlechromelabs.github.io/chrome-for-testing/known-good-versions-with-downloads.json
DEBUG Selenium [:selenium_manager] Required driver: chromedriver 116.0.5845.96
DEBUG Selenium [:selenium_manager] Driver URL: https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/116.0.5845.96/linux64/chromedriver-linux64.zip
DEBUG Selenium [:selenium_manager] Driver path: /home/app/.cache/selenium/chromedriver/linux64/116.0.5845.96/chromedriver
DEBUG Selenium [:selenium_manager] Browser path: /home/app/.cache/selenium/chrome/linux64/116.0.5845.96/chrome
</code></pre>

<p>Importantly, this shows version 116.0.5845.96 for both Chrome + ChromeDriver. We want these to match for compatibility reasons. As Chrome releases newer versions, the version that’s downloaded here will differ.</p>

<p>Then we’ll see ChromeDriver starting up:</p>

<pre><code>DEBUG Selenium [:selenium_manager] Browser path: /home/app/.cache/selenium/chrome/linux64/116.0.5845.96/chrome
DEBUG Selenium [:driver_service] port prober could not bind to ::1:9515 (Address not available - bind(2) for "::1" port 9515)
DEBUG Selenium [:driver_service] Executing Process ["/home/app/.cache/selenium/chromedriver/linux64/116.0.5845.96/chromedriver", "--port=9515"]
DEBUG Selenium [:process] Starting process: ["/home/app/.cache/selenium/chromedriver/linux64/116.0.5845.96/chromedriver", "--port=9515"] with {[:out, :err]=&gt;#&lt;IO:&lt;STDOUT&gt;&gt;, :pgroup=&gt;true}
DEBUG Selenium [:process]   -&gt; pid: 28
2023-08-22 05:46:27 DEBUG Selenium [:driver_service] polling for socket on ["127.0.0.1", 9515]
Starting ChromeDriver 116.0.5845.96 (1a391816688002153ef791ffe60d9e899a71a037-refs/branch-heads/5845@{#1382}) on port 9515
Only local connections are allowed.
Please see https://chromedriver.chromium.org/security-considerations for suggestions on keeping ChromeDriver safe.
[1692683187.222][SEVERE]: bind() failed: Address not available (99)
ChromeDriver was started successfully.
</code></pre>

<p>The “address not available (99)” error here is because ChromeDriver is trying to bind to <code>::1:9515</code>, but this Docker image is not setup with IPv6 support, so that will fail.</p>

<p>Finally, we’ll see some JSON requests to <code>POST session</code> going back and forth from <code>9515</code>, indicating ChromeDriver’s opening a Chrome window and that’s succeeding.</p>

<pre><code>DEBUG Selenium [:command] -&gt; POST session
DEBUG Selenium [:command]    &gt;&gt;&gt; http://127.0.0.1:9515/session | {"capabilities":{"alwaysMatch":{"browserName":"chrome","goog:chromeOptions":{"args":["--headless","--no-sandbox","--disable-dev-shm-usage","--disable-gpu"],"binary":"/home/app/.cache/selenium/chrome/linux64/116.0.5845.96/chrome"}}}}
</code></pre>
]]></content>
 </entry>
 
 <entry>
   <title>Alpine Linux, Selenium Manager, Chrome and ChromeDriver</title>
   <link href="https://ryanbigg.com/2023/08/alpine-linux-selenium-manager-chrome-and-chromedriver"/>
   <updated>2023-08-22T00:00:00+10:00</updated>
   <id>https://ryanbigg.com/2023/08/alpine-linux-selenium-manager-chrome-and-chromedriver</id>
   <content type="html"><![CDATA[<p>Selenium, and by extension the selenium-webdriver gem, after version 4.11 come with <a href="https://www.selenium.dev/blog/2022/introducing-selenium-manager/">a new feature called Selenium Manager</a>. This CLI tool will automatically install whatever browser and driver you need to run your Selenium tests. (These are installed under <code>~/.cache/selenium...</code>)</p>

<p>Today, I tried setting this up in an Alpine linux based Docker image and ran into trouble where it claimed it could not find the executable.</p>

<p>I was seeing errors such as:</p>

<pre><code>/bin/sh: ./chromedriver-linux64/chromedriver: not found
</code></pre>

<p>The file was definitely present though!</p>

<p>Other answers on the internet pointed to this being an issue with missing libraries. Those answers pointed to the <code>ldd</code> tool, and sure enough that showed the libraries that were required for chromedriver. The command was:</p>

<pre><code>ldd ./chromedriver-linux64/chromedriver
</code></pre>

<p>This listed the system libaries that the chromedriver executable was dependent on Then I read through those messages that were output and attempted to find packages that matched the messages.</p>

<p>To make Chromedriver v116 work on Alpine Linux, you have to have these packages installed:</p>

<pre><code>apk add gcompat glib nss libxcb libgcc
</code></pre>

<p>After installing these packages, Chromedriver was able to start.</p>

<p>But Chromedriver is not so useful without a Chrome to drive it. I used <code>ldd</code> once again, and found a <em>huge</em> list of packages that Chrome requires. Instead of installing all of these, you can install Chrome using:</p>

<pre><code>apk add chromium
</code></pre>

<p>This will then install Chromium (whatever’s latest and all of the package dependencies). This will be enough to get Chrome running.</p>

<p>Ultimately, I ended up building a small Docker image to test this out properly. Here’s that image’s <code>Dockerfile</code>:</p>

<pre><code>FROM ruby:3.2.2-alpine
RUN apk update &amp;&amp; apk add gcompat glib nss libxcb libgcc chromium

RUN adduser -D app
RUN mkdir /app
RUN chown app:app /app
USER app
WORKDIR /app
COPY --chown=app:app . /app

RUN bundle config set --local path vendor/bundle
RUN bundle install
CMD bundle exec irb
</code></pre>

<p>I build this with:</p>

<pre><code>docker build . -t selenium
</code></pre>

<p>Then I run it with:</p>

<pre><code> docker run -it selenium
</code></pre>

<p>This will launch me into an IRB session. To check if Selenium can correctly download + use Chrome and ChromeDriver, I run this code, which is very similar to the code that would be used to configure this within <code>rails_helper.rb</code> in a Rails app:</p>

<pre><code class="language-ruby">Bundler.require

Selenium::WebDriver.logger.level = Logger::DEBUG

options = ::Selenium::WebDriver::Chrome::Options.new

options.add_argument("--headless")
options.add_argument("--no-sandbox")
options.add_argument("--disable-dev-shm-usage")
options.add_argument("--disable-gpu")

Selenium::WebDriver.for :chrome, capabilities: options
</code></pre>

<p>This output should include things like a check for both Chrome + ChromeDriver, which will fail:</p>

<pre><code>DEBUG Selenium [:selenium_manager] Checking chromedriver in PATH
DEBUG Selenium [:selenium_manager] Running command: chromedriver --version
DEBUG Selenium [:selenium_manager] Output: ""
DEBUG Selenium [:selenium_manager] chromedriver not found in PATH
DEBUG Selenium [:selenium_manager] Checking chrome in PATH
DEBUG Selenium [:selenium_manager] Running command: which chrome
DEBUG Selenium [:selenium_manager] Output: ""
DEBUG Selenium [:selenium_manager] chrome not found in PATH
DEBUG Selenium [:selenium_manager] chrome has not been discovered in the system
</code></pre>

<p>(The chrome one fails here, as <code>chromium</code> has installed Chrome at <code>/usr/bin/chromium</code>.)</p>

<p>After that, we’ll see log lines for downloads of Chrome + ChromeDriver:</p>

<pre><code>DEBUG Selenium [:selenium_manager] Reading metadata from https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json
DEBUG Selenium [:selenium_manager] Required browser: chrome 116.0.5845.96
DEBUG Selenium [:selenium_manager] Downloading chrome 116.0.5845.96 from https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/116.0.5845.96/linux64/chrome-linux64.zip
DEBUG Selenium [:selenium_manager] chrome 116.0.5845.96 has been downloaded at /home/app/.cache/selenium/chrome/linux64/116.0.5845.96/chrome
DEBUG Selenium [:selenium_manager] Reading metadata from https://googlechromelabs.github.io/chrome-for-testing/known-good-versions-with-downloads.json
DEBUG Selenium [:selenium_manager] Required driver: chromedriver 116.0.5845.96
DEBUG Selenium [:selenium_manager] Driver URL: https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/116.0.5845.96/linux64/chromedriver-linux64.zip
DEBUG Selenium [:selenium_manager] Driver path: /home/app/.cache/selenium/chromedriver/linux64/116.0.5845.96/chromedriver
DEBUG Selenium [:selenium_manager] Browser path: /home/app/.cache/selenium/chrome/linux64/116.0.5845.96/chrome
</code></pre>

<p>Importantly, this shows version 116.0.5845.96 for both Chrome + ChromeDriver. We want these to match for compatibility reasons. As Chrome releases newer versions, the version that’s downloaded here will differ.</p>

<p>Then we’ll see ChromeDriver starting up:</p>

<pre><code>DEBUG Selenium [:selenium_manager] Browser path: /home/app/.cache/selenium/chrome/linux64/116.0.5845.96/chrome
DEBUG Selenium [:driver_service] port prober could not bind to ::1:9515 (Address not available - bind(2) for "::1" port 9515)
DEBUG Selenium [:driver_service] Executing Process ["/home/app/.cache/selenium/chromedriver/linux64/116.0.5845.96/chromedriver", "--port=9515"]
DEBUG Selenium [:process] Starting process: ["/home/app/.cache/selenium/chromedriver/linux64/116.0.5845.96/chromedriver", "--port=9515"] with {[:out, :err]=&gt;#&lt;IO:&lt;STDOUT&gt;&gt;, :pgroup=&gt;true}
DEBUG Selenium [:process]   -&gt; pid: 28
2023-08-22 05:46:27 DEBUG Selenium [:driver_service] polling for socket on ["127.0.0.1", 9515]
Starting ChromeDriver 116.0.5845.96 (1a391816688002153ef791ffe60d9e899a71a037-refs/branch-heads/5845@{#1382}) on port 9515
Only local connections are allowed.
Please see https://chromedriver.chromium.org/security-considerations for suggestions on keeping ChromeDriver safe.
[1692683187.222][SEVERE]: bind() failed: Address not available (99)
ChromeDriver was started successfully.
</code></pre>

<p>The “address not available (99)” error here is because ChromeDriver is trying to bind to <code>::1:9515</code>, but this Docker image is not setup with IPv6 support, so that will fail.</p>

<p>Finally, we’ll see some JSON requests to <code>POST session</code> going back and forth from <code>9515</code>, indicating ChromeDriver’s opening a Chrome window and that’s succeeding.</p>

<pre><code>DEBUG Selenium [:command] -&gt; POST session
DEBUG Selenium [:command]    &gt;&gt;&gt; http://127.0.0.1:9515/session | {"capabilities":{"alwaysMatch":{"browserName":"chrome","goog:chromeOptions":{"args":["--headless","--no-sandbox","--disable-dev-shm-usage","--disable-gpu"],"binary":"/home/app/.cache/selenium/chrome/linux64/116.0.5845.96/chrome"}}}}
</code></pre>

<p>So the important thing to note here is that if you’ve got:</p>

<ol>
  <li>A Ruby image that uses <code>ruby:3.2.2-alpine</code> (or similar) as its base</li>
  <li>And you want to use the built-in Selenium Manager to download Chrome + Chromium</li>
  <li>You will need to have these packages installed:</li>
</ol>

<pre><code>apk add gcompat glib nss libxcb libgcc chromium
</code></pre>
]]></content>
 </entry>
 
 <entry>
   <title>Zoom&apos;s return to the office</title>
   <link href="https://ryanbigg.com/2023/08/zooms-return-to-the-office"/>
   <updated>2023-08-07T00:00:00+10:00</updated>
   <id>https://ryanbigg.com/2023/08/zooms-return-to-the-office</id>
   <content type="html"><![CDATA[<p>This news <a href="https://nypost.com/2023/08/05/zoom-tells-employees-to-return-to-office-for-work/">about Zoom forcing their employees back into the office for 2 days a week</a> is just bonkers.</p>

<p>For an Australian perspective:</p>

<p>In Melbourne, 50 miles would mean people on Phillip Island and Geelong would need to commute into the city, a 2 hour commute one way. Geelong people could take the V/Line, thankfully. Phillip Islanders are shit out of luck and would have to drive in.</p>

<p>In Sydney, 50 miles would mean people in Wentworth Falls, San Remo and Wollongong would also be forced to commute 2 hours into the office as well. Katoomba residents thank your lucky stars, you’re just outside of the magic number.</p>

<p>Two hour commutes! “Give up 8 hours of your week <em>in traffic</em> in the name of <em>synergy</em>.” What baloney.</p>

<hr />

<p>I really enjoy the flexibility of working from home. I can put on a load of washinxtg over my lunch break or potter around in the garden when the sun’s out. I can take the dog for a walk or a run to the park. I can take some time out at around 3 and collect my daughter from school without having to commute first back to home and then out again to the school.</p>

<p>Environmentally: I can control the temperature in my office. There’s nobody walking around behind my monitor or talking loudly on their phone nearby. I have control over my desk and I can set it up however I like without some HR person mandating that I’m sharing it with someone due to space reasons.</p>

<p>And for all of these reasons, I’m a happy employee. I get my work done, and <em>more of it</em>, because I can choose the conditions in how that work is done. And if I need to <em>synergise</em> with another employee, why there’s Zoom for that.</p>
]]></content>
 </entry>
 
 <entry>
   <title>How to fix: Chromedriver 115, cannot find chrome binary</title>
   <link href="https://ryanbigg.com/2023/07/how-to-fix-chromedriver-115-cannot-find-chrome-binary"/>
   <updated>2023-07-28T00:00:00+10:00</updated>
   <id>https://ryanbigg.com/2023/07/how-to-fix-chromedriver-115-cannot-find-chrome-binary</id>
   <content type="html"><![CDATA[<p>Chromedriver v115 was released recently and causes this issue to appear on Macs that use Chromedriver for automated testing.</p>

<pre><code>unknown error: cannot find Chrome binary

Traceback (most recent call last):
       16: from 15  chromedriver                        0x0000000100df056c chromedriver + 4179308
       15: from 14  chromedriver                        0x0000000100df0414 chromedriver + 4178964
       14: from 13  chromedriver                        0x0000000100dacd1c chromedriver + 3902748
</code></pre>

<p>This is due to Chromedriver looking for a new binary called “Chrome for Testing”, which was <a href="https://developer.chrome.com/blog/chrome-for-testing/">recently released from the Chrome team</a>.</p>

<p>To fix this bug, you need to <a href="https://googlechromelabs.github.io/chrome-for-testing/#stable">download Chrome for Testing</a>, unzip it and move it into your <code>/Applications</code> directory.</p>

<p>Mac’s Gatekeeper program will not let you open this executable by default, as it came from a <code>.zip</code> file. To work around that problem, run:</p>

<pre><code>sudo xattr -cr '/Applications/Google Chrome for Testing.app'
</code></pre>

<p>This will remove the security restriction that is blocking this application from opening.</p>

<p>Run your test suite again, and it will now work.</p>
]]></content>
 </entry>
 
 <entry>
   <title>Rails 7, React, TypeScript, ESBuild and View Components</title>
   <link href="https://ryanbigg.com/2023/06/rails-7-react-typescript-setup"/>
   <updated>2023-06-01T00:00:00+10:00</updated>
   <id>https://ryanbigg.com/2023/06/rails-7-react-typescript-setup</id>
   <content type="html"><![CDATA[<p>Here’s a short guide to setting up an existing Rails 7 application with React, TypeScript, ESBuild. One approach here would be to use the <code>react-rails</code> gem, but I would like to show you the individual steps to setting it up here instead.</p>

<h3 id="installing-esbuild">Installing ESBuild</h3>

<p>First you’ll want to install the <code>jsbundling-rails</code> gem:</p>

<pre><code>bundle add jsbundling-rails
</code></pre>

<p>Next, you’ll run the generator for this gem to setup ESBuild:</p>

<pre><code>bin/rails javascript:install:esbuild
</code></pre>

<p>This will create an <code>app/javascript/application.js</code> file that we will not need – so delete this file.</p>

<p>ESBuild will be setup to build assets in <code>app/javascript</code>, and put them into <code>app/assets/builds</code>. From there, Rails will be able to serve those assets.</p>

<p>This install script has added a new <code>build</code> script to <code>package.json</code>:</p>

<pre><code class="language-json">"scripts": {
  "build": "esbuild app/javascript/*.* --bundle --sourcemap --outdir=app/assets/builds --public-path=assets"
}
</code></pre>

<p>Once we’ve setup our React code we will be able to run this command to take that code and compile it into some JavaScript browsers can run.</p>

<p>I like to change this script to point at an <code>entrypoints</code> subdirectory:</p>

<pre><code class="language-json">"scripts": {
  "build": "esbuild app/javascript/entrypoints/*.* --bundle --sourcemap --outdir=app/assets/builds --public-path=assets"
}
</code></pre>

<p>This is so that I can put other directories inside <code>app/javascript</code>, such as directories including little helper functions, or bigger component structures like <code>app/javascript/Purchases/Table.tsx</code>.</p>

<p>It also means that ESBuild will not build <em>everything</em> in that directory – just the files we declare as entrypoints.</p>

<h3 id="installing-react--typescript">Installing React &amp; TypeScript</h3>

<p>To install React and TypeScript we’ll run this <code>yarn</code> command:</p>

<pre><code>yarn add react@^18.2 @react-dom@^18.2 @types/react @types/react-dom typescript
</code></pre>

<p>To configure TypeScript so that it supports React’s JSX templating, we’ll create a <code>tsconfig.json</code> file at the root of our Rails application with this content in it:</p>

<pre><code class="language-json">{
  "compilerOptions": {
    "module": "commonjs",
    "esModuleInterop": true,
    "forceConsistentCasingInFileNames": true,
    "strict": true,
    "skipLibCheck": true,
    "jsx": "react",
  }
}
</code></pre>

<p>To see some React code in action and to check out setup, we can create a new file at <code>app/javascript/entrypoints/application.tsx</code> and put this code into it:</p>

<pre><code class="language-tsx">import React from "react";
import ReactDOM from "react-dom/client";

const App = () =&gt; &lt;h1&gt;Hello from React!&lt;/h1&gt;;

const root = ReactDOM.createRoot(
  document.getElementById("root") as HTMLElement
);

root.render(&lt;App /&gt;);
</code></pre>

<p>After this, we can build our application’s assets by running:</p>

<pre><code>yarn build
</code></pre>

<p>This will show us that it has built these assets:</p>

<pre><code>yarn run v1.22.19
warning package.json: No license field
$ esbuild app/javascript/*.* --bundle --sourcemap --outdir=app/assets/builds --public-path=assets

  app/assets/builds/application.js      1.0mb ⚠️
  app/assets/builds/application.js.map  1.5mb
</code></pre>

<p>To test that it’s all working, we can generate a simple view:</p>

<pre><code>rails g controller home index
</code></pre>

<p>And into <code>app/views/home/index.html.erb</code> we can put a simple div with the ID of <code>root</code>. This is the element that our <code>ReactDOM.createRoot</code> code was targeting earlier:</p>

<pre><code class="language-html">&lt;div id='root'&gt;&lt;/div&gt;
</code></pre>

<p>When we start our Rails app with <code>bundle exec rails s</code> and go to http://localhost:3000/home/index, we’ll see our “Hello from React!” message.</p>

<p><img src="/images/css-bundling/react/hello.png" alt="Hello from React" /></p>

<p>This works “out of the box” because our application layout already brings in this compiled asset:</p>

<pre><code class="language-erb">&lt;%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %&gt;
</code></pre>

<h3 id="multiple-mount-points">Multiple mount points</h3>

<p>If you’re running a single-page app, you can probably stop reading here and continue throwing things into <code>&lt;App&gt;</code>.</p>

<p>If you’re wanting to go down a different route, then keep reading. That different route is multiple individual components, where you may wish to mount a component on a per-page basis, than one component for the whole app.</p>

<p>To do this, we can create a file at <code>app/javascript/mount.tsx</code>:</p>

<pre><code class="language-tsx">import React from "react";
import ReactDOM from "react-dom/client";

type Components = Record&lt;string, React.ElementType&gt;;

export default function mount(components: Components): void {
  document.addEventListener("DOMContentLoaded", () =&gt; {
    const mountPoints = document.querySelectorAll("[data-react-component]");
    mountPoints.forEach((mountPoint) =&gt; {
      const { dataset } = mountPoint as HTMLElement;
      const componentName = dataset.reactComponent;
      if (componentName) {
        const Component = components[componentName];
        if (Component) {
          const props = JSON.parse(dataset.props as string);
          const root = ReactDOM.createRoot(mountPoint);
          root.render(&lt;Component {...props} /&gt;);
        } else {
          console.warn(
            "WARNING: No component found for: ",
            dataset.reactComponent,
            components
          );
        }
      }
    });
  });
}
</code></pre>

<p>This code attempts to find all elements that contain a <code>data-react-component</code> attribute, and then to mount components matching that name onto the page in those locations. This code also parses any props contained in a <code>data-props</code> attribute and passes those along to the component too.</p>

<p>In practical terms, a page containing:</p>

<pre><code class="language-html">&lt;div data-react-component='App' data-props="{}"&gt;&lt;/div&gt;
</code></pre>

<p>Would have a component called <code>App</code> mounted into the location of that div tag. This then allows us to intermix React components with our Rails application, which can be particularly helpful if we have an older Rails app that we’re enhancing with some newer React components.</p>

<p>To see this in action, let’s use this new <code>mount</code> function over in <code>application.tsx</code> by replacing the code in that file with this code:</p>

<pre><code>import React from "react";
import mount from "./mount";

const App = () =&gt; &lt;h1&gt;Hello from React!&lt;/h1&gt;;

mount({
  App,
});
</code></pre>

<p>And also the code in <code>app/views/home/index.html.erb</code> with this code:</p>

<pre><code class="language-html">&lt;div data-react-component='App' data-props="{}"&gt;&lt;/div&gt;
</code></pre>

<p>We can then run <code>yarn build</code> to rebuild our assets, and then refresh our browser to see the same message as before.</p>

<h3 id="view-components">View Components</h3>

<p>Writing this lengthy HTML into our views every time we want to render a React component will get tiresome quickly. To save us repeating ourselves again and again, we’re going to use a gem called <code>view_component</code>. We can install this gem with:</p>

<pre><code>bundle add view_component
</code></pre>

<p>We can then create a new component class using this gem, placing it into <code>app/components/react_component.rb</code>:</p>

<pre><code class="language-ruby"># frozen_string_literal: true

class ReactComponent &lt; ViewComponent::Base
  attr_reader :component, :raw_props

  def initialize(component, raw_props: {})
    @component = component
    @raw_props = raw_props
  end

  def call
    helpers.tag.div(
      '',
      data: {
        react_component: component,
        props: props
      }
    )
  end

  private

  def props
    raw_props
  end
end

</code></pre>

<p>This class is then going to place that <code>div</code> tag onto our page for us. This class will serve as a base class for any other component classes we define in our app. Those subclasses of <code>ReactComponent</code> can override <code>props</code> if they need to do work to prepare the props before they’re passed through to the component.</p>

<p>Then we can use this component to render React components within our application. Let’s change the code in <code>app/views/home/index.html.erb</code> to render the <code>App</code> component by using this component class:</p>

<pre><code class="language-erb">&lt;%= render ReactComponent.new("App") %&gt;
</code></pre>

<p>We can use the view component just like a partial. I’ll get to why we’re <em>not</em> using partials in a moment. It deserves its own section!</p>

<p>We will need to restart the Rails server at this point so that it picks up the file in <code>app/components</code>. After restarting the server, and refreshing the browser, we’ll once again see our React component’s output.</p>

<h3 id="why-view-components-over-partials">Why view components over partials</h3>

<p>Why did we complicate things by bringing in a new gem rather than using the wonderful partial features Rails provides?</p>

<p>The simple answer is: Ruby code belongs in Ruby files. And I don’t just mean calls to <code>tag.div</code>. I mean if you had any sort of Ruby code that needed to run before rendering this component, you could now put that code into the component class.</p>

<p>As an example here, let’s create a new React component called <code>Product</code>. It will render a name and a price. We’ll put this component at <code>app/javascript/Product/index.tsx</code>:</p>

<pre><code class="language-tsx">import React from "react";

const Product = ({ name, price }: { name: string; price: string }) =&gt; {
  return (
    &lt;&gt;
      &lt;h1&gt;
        {name} - {price}
      &lt;/h1&gt;
    &lt;/&gt;
  );
};

export default Product;
</code></pre>

<p>We can then tell our application to mount this component whenever it sees a <code>div[data-react-component=Product]</code> tag, by using the <code>mount</code> helper in <code>app/javascript/entrypoints/application.tsx</code>:</p>

<pre><code>import React from "react";
import mount from "../mount";
import Product from "../Product";

const App = () =&gt; &lt;h1&gt;Hello from React!&lt;/h1&gt;;

mount({
  App,
  Product,
});
</code></pre>

<p>As we’ve now changed <code>application.tsx</code>, we will need to rebuild it with <code>yarn build</code> again. Now is a good time to say we could’ve been running <code>yarn build --watch</code> this whole time… but I preferred being explicit about when things were being rebuilt and why. Now you know the secret.</p>

<p>To render this React component, we’ll create a new Ruby file to represent the Ruby-side of this component. We’ll put this component into <code>app/components/products/show_component.rb</code>:</p>

<pre><code class="language-ruby">module Products
  class ShowComponent &lt; ReactComponent
    def initialize(raw_props)
      super("Product", raw_props: raw_props)
    end

    def props
      raw_props.merge(
        price: helpers.number_to_currency(raw_props[:price])
      )
    end
  end
end
</code></pre>

<p>This component file inherits from our <code>ReactComponent</code> component class and will render that component. To use this Ruby component class, we can go back into <code>app/views/home/index.html.erb</code> and put this code there:</p>

<pre><code class="language-erb">&lt;%= render Products::ShowComponent.new(name: "Shoes", price: 100) %&gt;
</code></pre>

<p>Using this component will mean that we will end up with this <code>div</code> tag on the page:</p>

<pre><code class="language-html">&lt;div data-react-component="Product" data-props="{&amp;quot;name&amp;quot;:&amp;quot;Shoes&amp;quot;,&amp;quot;price&amp;quot;:100}"&gt;&lt;/div&gt;
</code></pre>

<p>Our <code>mount.tsx</code> code will see that <code>div</code> tag and mount the <code>Product</code> React component into that place, passing through the props.</p>

<p>Now, the reason for this whole section: <strong>we use view components over partials because Ruby code belongs in Ruby files</strong>.</p>

<p>As a quick example of this, if we want to format the price before it goes to the component, we can update our <code>ShowComponent</code> code to process those props:</p>

<pre><code class="language-ruby">module Products
  class ShowComponent &lt; ReactComponent
    def initialize(raw_props)
      super("Product", raw_props: raw_props)
    end

    def props
      raw_props.merge(
        price: helpers.number_to_currency(raw_props[:price])
      )
    end
  end
end
</code></pre>

<p>Here we’re calling a Ruby method in Ruby code in order to format the price. We’re not limited to just methods from <code>helpers</code> here – we could call any Ruby code that we wanted to. This is, in my opinion, better than interspersing Ruby and HTML code into the same file.</p>

<p>What this also means is that we could pass a product through to our component from the <code>app/views/home/index.html.erb</code>, rather than passing attributes one-by-one:</p>

<pre><code class="language-erb">&lt;%= render Products::ShowComponent.new(product: @product) %&gt;
</code></pre>

<p>(I’m making an assumption here about having a <code>@product</code> object set up in the controller – use your imagination!)</p>

<p>And then in that component class, we can take the raw props of the product object itself and do our formatting of the price:</p>

<pre><code class="language-ruby">module Products
  class ShowComponent &lt; ReactComponent
    def initialize(product)
      super("Product", raw_props: product)
    end

    def props
      {
        name: product.name,
        price: helpers.number_to_currency(product.price)
      }
    end
  end
end
</code></pre>

<p>The View Component class finally gives our Ruby view code a proper home to live: in a Ruby file, NOT a HTML file!</p>
]]></content>
 </entry>
 
 <entry>
   <title>Rails 7, Bootstrap CSS + JavaScript with ESBuild</title>
   <link href="https://ryanbigg.com/2023/04/rails-7-bootstrap-css-javascript-with-esbuild"/>
   <updated>2023-04-24T00:00:00+10:00</updated>
   <id>https://ryanbigg.com/2023/04/rails-7-bootstrap-css-javascript-with-esbuild</id>
   <content type="html"><![CDATA[<p>Here’s a short guide to setting up an existing Rails 7 application with Bootstrap, using ESBuild to build both the JavaScript and CSS files for Bootstrap.</p>

<p>First you’ll want to install the <code>jsbundling-rails</code> gem:</p>

<pre><code>bundle add jsbundling-rails
</code></pre>

<p>Next, you’ll run the generator for this gem to setup ESBuild:</p>

<pre><code>bin/rails javascript:install:esbuild
</code></pre>

<p>ESBuild will be setup to build assets in <code>app/javascript</code>, and put them into <code>app/assets/builds</code>. From there, Rails will be able to serve those assets.</p>

<p>To setup Bootstrap itself, we’ll add Bootstrap and its dependencies, PopperJS and jQuery:</p>

<pre><code>yarn add bootstrap @popperjs/core jquery
</code></pre>

<p>To use these dependencies, we will need to import them into our application’s build entrypoint file, which is located at <code>app/javascript/application.js</code>. The lines that we need to add to this file to get Bootstrap loaded are:</p>

<pre><code class="language-js">import "bootstrap";
import "bootstrap/dist/css/bootstrap.min.css";
</code></pre>

<p>After this, we can build our application’s assets by running:</p>

<pre><code>yarn build
</code></pre>

<p>This will show us that it has built these assets:</p>

<pre><code>yarn run v1.22.19
$ esbuild app/javascript/*.* --bundle --sourcemap --outdir=app/assets/builds --public-path=assets

  app/assets/builds/application.css      229.9kb
  app/assets/builds/application.js       186.9kb
  app/assets/builds/application.css.map  479.0kb
  app/assets/builds/application.js.map   356.7kb
</code></pre>

<p>ESBuild is smart enough here to know that we’re bringing in a CSS asset in our JS file, and due to that it will generate <em>both</em> a JS and a CSS file as assets. In addition to this, sourcemaps have been generated for both the CSS and JS files too.</p>

<p>To test that it’s all working, we can generate a simple view:</p>

<pre><code>rails g controller home index
</code></pre>

<p>And into <code>app/views/home/index.html.erb</code> we can put this HTML that I’ve “borrowed” from Bootstrap’s own example:</p>

<pre><code class="language-html">&lt;div class="modal fade" id="exampleModalXl" tabindex="-1" aria-labelledby="exampleModalXlLabel" style="display: none;" aria-hidden="true"&gt;
  &lt;div class="modal-dialog modal-xl"&gt;
    &lt;div class="modal-content"&gt;
      &lt;div class="modal-header"&gt;
        &lt;h1 class="modal-title fs-4" id="exampleModalXlLabel"&gt;Extra large modal&lt;/h1&gt;
        &lt;button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"&gt;&lt;/button&gt;
      &lt;/div&gt;
      &lt;div class="modal-body"&gt;
        ...
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;


&lt;button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModalXl"&gt;Extra large modal&lt;/button&gt;
</code></pre>

<p>When we start our Rails app with <code>bundle exec rails s</code> and go to http://localhost:3000/home/index, we’ll see a blue button. When we click the blue button, the modal will appear:</p>

<p><img src="/images/css-bundling/bootstrap/modal.png" alt="Modal" /></p>
]]></content>
 </entry>
 
 <entry>
   <title>Open Letter to the Rails Foundation</title>
   <link href="https://ryanbigg.com/2023/03/open-letter-to-the-rails-foundation"/>
   <updated>2023-03-09T00:00:00+11:00</updated>
   <id>https://ryanbigg.com/2023/03/open-letter-to-the-rails-foundation</id>
   <content type="html"><![CDATA[<p>I sent this email to Amanda at the <a href="https://rubyonrails.org/foundation">Rails Foundation</a> this morning.</p>

<hr />

<p>Hello, my name is Ryan and I run the Gem Foundation: https://ryanbigg.com/2022/11/the-gem-foundation.</p>

<p>(Just quietly between you and me, id rather you answer this email than David. We’ve got… history.)</p>

<p>I’ve also written several books on Ruby, including the same Rails book 3, almost 4 times: Rails 3 in Action, Rails 4 in Action and Active Rails 1st and 2nd editions. Oh and I wrote a bunch of the Rails guides too. And contributed enough on Rails answers on Stack Overflow to earn me 100k rep, as well as a cool SO T-shirt and socks. I also took over the #rubyonrails IRC channel there for a time.</p>

<p>Point is: I have written multiple of millions of words about Rails to further its adoption.</p>

<p>As we approach the 4 month mark of the Rails Foundation launch, I am absolutely STUNNED that there has been not a single cent that has left the organisation’s coffers since its inception.</p>

<p>The announcement was grandiose in nature. A fat sack of cash for those who do unpaid labour for Rails. Sounds delightful. I like money for the way it buys hot chocolates for my daughter who then proceeds to wear them more than drink them, amongst other things.</p>

<p>Why hasn’t the Rails Foundation donated money to Rails Girls? Why haven’t they incentivised mentoring through FirstRubyFriend for Rails-focussed mentoring? Current and past guide authors: do they get funding? Rails gem authors or those gems that Rails depends on outside of its immediate vicinity? (Oh I maintain i18n as well btw, and GitHub recently sent me an award for that.)</p>

<p>You want to further adoption of Rails. So do I. I love most parts of Rails. I say most parts because after 15 years with a thing you start being really good at seeing the warts. Overall, it’s a framework that’s provided me with a stable income (and some tiny level of notoriety) over the last 15 years.</p>

<p>The framework and its related resources are a monumental achievement of open source collaboration.</p>

<p>So my question today is when will the Rails
foundation start funding these projects? Are we going to be waiting weeks, or months?</p>

<p>I don’t send this email with cap-in-hand expecting money — I’m already paid the Bigg Bucks through my work with Rails and my books.</p>

<p>What I’d like to see is the Rails Foundation actually putting their money where their mouth is and helping grow this wonderful community of ours, and helping it thrive for another 15 years.</p>
]]></content>
 </entry>
 
 <entry>
   <title>Please explain, Elastic Search</title>
   <link href="https://ryanbigg.com/2023/03/please-explain-elasticsearch"/>
   <updated>2023-03-02T00:00:00+11:00</updated>
   <id>https://ryanbigg.com/2023/03/please-explain-elasticsearch</id>
   <content type="html"><![CDATA[<p>I’ve recently been using Elastic Search on a project. I came across an issue where Elastic Search wasn’t able to find a particular document for a particular query. My first thought that was the document wasn’t indexed within the index, but it was.</p>

<p>I’ll walk through the process of debugging this search query in this post, demonstrating a couple of helpful Elastic Search endpoints.</p>

<p>Let’s go through the whole process, from indexing to searching to explaining. I’ll be using <a href="https://httpie.io/">the wonderful httpie tool</a> to interact with Elastic Search in this post.</p>

<h2 id="indexing-a-document">Indexing a document</h2>

<p>To index a document in ElasticSearch, we need an index that this document can be inserted into. We can create this index with:</p>

<pre><code class="language-text">http put http://localhost:9200/posts
</code></pre>

<p>Running this command will show us the index has been created:</p>

<pre><code class="language-json">{
  "acknowledged": true,
  "index": "posts",
  "shards_acknowledged": true
}
</code></pre>

<p>Next, we can add a new document into this index. For this example, I’ll create a small JSON file containing the data that we want to index, calling the file <code>post.json</code>:</p>

<pre><code class="language-json">{
  "id": 1,
  "title": "Please explain, Elastic Search",
  "date": "2023-03-03",
  "user_id": 101,
}
</code></pre>

<p>We can then add this document to the index by running:</p>

<pre><code class="language-text">http put http://localhost:9200/posts/_doc/1 &lt; post.json
</code></pre>

<p>When we run this command, we’ll see the document has been inserted successfully, as indicated by the “result” field:</p>

<pre><code class="language-json">{
    "_id": "1",
    "_index": "posts",
    "_primary_term": 1,
    "_seq_no": 0,
    "_shards": {
        "failed": 0,
        "successful": 1,
        "total": 2
    },
    "_type": "_doc",
    "_version": 1,
    "result": "created"
}
</code></pre>

<p>Let’s also add a document that <em>should not</em> be returned by our search query:</p>

<pre><code class="language-json">{
  "id": 2,
  "title": "We should not see this post",
  "date": "2023-02-02",
  "user_id": 155,
}
</code></pre>

<p>I’ll save this in a file called <code>post-2.json</code>, and insert it:</p>

<pre><code class="language-text">http put http://localhost:9200/posts/_doc/2 &lt; post-2.json
</code></pre>

<h2 id="viewing-a-document">Viewing a document</h2>

<p>We can then see the document in this index using either the search API, or using the document API. Let’s look first at the search API:</p>

<pre><code class="language-text">http get http://localhost:9200/posts/_search
</code></pre>

<p>This shows:</p>

<pre><code class="language-json">{
    "_shards": {
        "failed": 0,
        "skipped": 0,
        "successful": 1,
        "total": 1
    },
    "hits": {
        "hits": [
            {
                "_id": "1",
                "_index": "posts",
                "_score": 1.0,
                "_source": {
                    "date": "2023-03-03",
                    "id": 1,
                    "title": "Please explain, Elastic Search",
                    "user_id": 101
                },
                "_type": "_doc"
            }
        ],
        "max_score": 1.0,
        "total": {
            "relation": "eq",
            "value": 1
        }
    },
    "timed_out": false,
    "took": 3
}
</code></pre>

<p>Alternatively, we can request this document using the same URL we used for the <code>PUT</code> operation to add the document into the index:</p>

<pre><code class="language-text">http get http://localhost:9200/posts/_doc/1
</code></pre>

<pre><code class="language-json">{
    "_id": "1",
    "_index": "posts",
    "_primary_term": 1,
    "_seq_no": 0,
    "_source": {
        "date": "2023-03-03",
        "id": 1,
        "title": "Please explain, Elastic Search",
        "user_id": 101
    },
    "_type": "_doc",
    "_version": 1,
    "found": true
}
</code></pre>

<h2 id="searching-for-a-document">Searching for a document</h2>

<p>Elastic Search has a very flexible query API, but it can be a bit wordy sometimes. Let’s write some search JSON to find a post based on a particular date range, and a user ID. I’m going to put this one into a file called <code>query.json</code>, and we’re going to write this in such a way that it does <em>not</em> find our document by writing the wrong user ID, and the wrong date range.</p>

<pre><code class="language-json">{
  "query": {
    "bool": {
      "must": [
        {
          "range": {
            "date": { "gte": "2023-02-01", "lte": "2023-02-28" }
          }
        },
        {
          "term": { "user_id": 100 }
        }
      ]
    }
  }
}
</code></pre>

<p>We can then run this query by using the search API:</p>

<pre><code class="language-text">http get http://localhost:9200/posts/_search &lt; query.json
</code></pre>

<p>This will return no results, as our query is wrong:</p>

<pre><code class="language-json">{
    "_shards": {
        "failed": 0,
        "skipped": 0,
        "successful": 1,
        "total": 1
    },
    "hits": {
        "hits": [],
        "max_score": null,
        "total": {
            "relation": "eq",
            "value": 0
        }
    },
    "timed_out": false,
    "took": 2
}
</code></pre>

<h2 id="explaining-a-query">Explaining a query</h2>

<p>To get information from Elastic Search on why a particular document hasn’t matched a query, we can use the Explain API.</p>

<pre><code class="language-text">http get http://localhost:9200/posts/_explain/1/ &lt; query.json
</code></pre>

<p>When we run this query, we see a <em>huge</em> amount of output:</p>

<pre><code class="language-json">{
    "_id": "1",
    "_index": "posts",
    "_type": "_doc",
    "explanation": {
        "description": "Failure to meet condition(s) of required/prohibited clause(s)",
        "details": [
            {
                "description": "no match on required clause (date:[1675209600000 TO 1677628799999])",
                "details": [
                    {
                        "description": "date:[1675209600000 TO 1677628799999] doesn't match id 0",
                        "details": [],
                        "value": 0.0
                    }
                ],
                "value": 0.0
            },
            {
                "description": "no match on required clause (user_id:[100 TO 100])",
                "details": [
                    {
                        "description": "user_id:[100 TO 100] doesn't match id 0",
                        "details": [],
                        "value": 0.0
                    }
                ],
                "value": 0.0
            }
        ],
        "value": 0.0
    },
    "matched": false
}
</code></pre>

<p>This shows us that the query did not match because both the <code>date</code> and <code>user_id</code> fields are wrong. Important to note here is that the <code>date</code> field range values are returned in milliseconds-from-epoch, rather than the <code>2023-03-03</code> format we might expect.</p>

<p>Let’s fix up the query so that it now matches, putting the query into another file called <code>fixed-query.json</code>:</p>

<pre><code class="language-json">{
  "query": {
    "bool": {
      "must": [
        {
          "range": {
            "date": { "gte": "2023-03-01", "lte": "2023-03-31" }
          }
        },
        {
          "term": { "user_id": 101 }
        }
      ]
    }
  }
}
</code></pre>

<p>We can then run this corrected query through the explain endpoint:</p>

<pre><code class="language-text">http post http://localhost:9200/posts/_explain/1 &lt; fixed-query.json
</code></pre>

<p>The output will show that our query now matches this document:</p>

<pre><code class="language-json">{
    "_id": "1",
    "_index": "posts",
    "_type": "_doc",
    "explanation": {
        "description": "sum of:",
        "details": [
            {
                "description": "date:[1677628800000 TO 1680307199999]",
                "details": [],
                "value": 1.0
            },
            {
                "description": "user_id:[101 TO 101]",
                "details": [],
                "value": 1.0
            }
        ],
        "value": 2.0
    },
    "matched": true
}
</code></pre>

<p>And if we attempt to search with this query, we’ll see it returned in the hits for this query too:</p>

<pre><code class="language-text">http get http://localhost:9200/posts/_search &lt; fixed-query.json
</code></pre>

<pre><code class="language-json">
{
    "_shards": {
        "failed": 0,
        "skipped": 0,
        "successful": 1,
        "total": 1
    },
    "hits": {
        "hits": [
            {
                "_id": "1",
                "_index": "posts",
                "_score": 2.0,
                "_source": {
                    "date": "2023-03-03",
                    "id": 1,
                    "title": "Please explain, Elastic Search",
                    "user_id": 101
                },
                "_type": "_doc"
            }
        ],
        "max_score": 2.0,
        "total": {
            "relation": "eq",
            "value": 1
        }
    },
    "timed_out": false,
    "took": 12
}
</code></pre>
]]></content>
 </entry>
 
 <entry>
   <title>Why game programming and why Magic?</title>
   <link href="https://ryanbigg.com/2023/02/why-game-programming-and-why-magic"/>
   <updated>2023-02-07T00:00:00+11:00</updated>
   <id>https://ryanbigg.com/2023/02/why-game-programming-and-why-magic</id>
   <content type="html"><![CDATA[<p>For about the past 5 months, I’ve been fiddling with a little Ruby project called <a href="https://github.com/radar/mtg">“Magic: The Gathering: The Ruby Project”</a>. It’s my attempt to make Magic: The Gathering, in Ruby.</p>

<p>But why game programming when my forté is web programming, and why <em>this</em> game specifically? Why not Uno?</p>

<p>Because I wanted a challenge!</p>

<p>I had played Magic first <a href="https://apps.apple.com/us/app/magic-the-gathering-arena/id1496227521">through their Arena app on iOS</a>, which (mostly) works, save a few little issues here and there. Last year I started playing Magic weekly at a local game shop in town. I love the different mechanics of the different cards and figuring out how they all interact best. <em>Especially</em> when they syngerise together.</p>

<p>What’s appealing about this game is that while there’s a rulebook (I’ll get to that in a minute), the <em>cards themselves</em> make up the rules. If the creators want to change the rules of the game, they can print more cards with different text on them.</p>

<p>This is Rule 101.1 of Magic:</p>

<blockquote>
  <p>101.1. Whenever a card’s text directly contradicts these rules, the card takes precedence.</p>
</blockquote>

<p>Some of the cards are simple, like <a href="https://scryfall.com/card/a25/33/savannah-lions">Savannah Lions</a>. It costs one white mana to play, and it has 2 power and 1 toughness.</p>

<p>Others, like <a href="https://scryfall.com/card/eld/171/questing-beast">Questing Beast</a> with all its words, and <a href="https://scryfall.com/card/isd/181/garruk-relentless-garruk-the-veil-cursed">Garruk Relentless</a> with all its words on one side, <em>and then even more words on the other side</em>, are not so simple.</p>

<p>This Rule 101.1, the <em>first</em> of Magic’s several “Golden Rules”, is contained in <a href="https://media.wizards.com/2023/downloads/MagicCompRules%2020230203.pdf">this two-hundred-and-seventy-eight PDF page document</a>, where all of Magic’s non-card-defined rules are written down. Some of the rules even have examples with them.</p>

<p>If you wanted to find out all of the creature types, you’d look at Rule 205.3m.</p>

<p>Want to know how combat is designed to run? Start on page 74 with Rule 506, and finish on Page 84 with rule 511.</p>

<hr />

<p>Now this MTG-in-Ruby project is not a line-for-line reproduction of the rulebook or even a card-for-card replication attempt from A-Z. It started as an attempt to reproduce the features of a stack of random cards that were on my desk, and progressed from there to attempting to implement all of the <a href="https://scryfall.com/sets/m21?as=grid&amp;order=set">Core Set 2021</a> cards. I needed to set myself a goal, and even though that goal is <em>extremely ambitious</em>, it’s still a goal and something to aim for.</p>

<p>I’ve gotten most of the white cards done, and that leaves only about 300 more cards of that set. And <a href="https://en.wikipedia.org/wiki/List_of_Magic:_The_Gathering_sets">there are quite a few sets</a> .</p>

<p>What I’m particularly proud of here is that I have a clean DSL for being able to define cards and their abilities. For a simple card like <a href="https://scryfall.com/card/khm/34/story-seeker">Story Seeker</a>, I can define it like:</p>

<pre><code class="language-ruby">module Magic
  module Cards
    StorySeeker = Creature("Story Seeker") do
      cost generic: 1, white: 1
      type "Creature -- Dwarf Cleric"
      keywords :lifelink
      power 2
      toughness 2
    end
  end
end
</code></pre>

<p>The one thing here I’d change is making those types into constants rather than being strings. I’ve been too lazy to address that yet, as it hasn’t been a problem. Here’s a quick riff on what that might look like:</p>

<pre><code class="language-ruby">module Magic
  module Cards
    StorySeeker = Creature("Story Seeker") do
      cost generic: 1, white: 1
      type Types::Creature[:Dwarf, :Cleric]
      keywords :lifelink
      power 2
      toughness 2
    end
  end
end
</code></pre>

<p>While writing this post I built <a href="https://github.com/radar/mtg/commit/8cb9efe66248a1672d0e56a04bc8e92d19209385">this exact interface</a>. I’d love to go back to revisit it sometime to handle when an <em>invalid</em> type is passed, but it’ll work for the time-being.</p>

<hr />

<p>The cards themselves are <em>usually</em> straightforward to implement. It’s how they interact that’s the tricky part. For this, I try to come up with scenarios that might happen in real games, and then model those in the tests themselves.</p>

<p>One of these that I’m particularly proud about is the mana-cost-reducing effect of <a href="https://scryfall.com/card/nec/152/foundry-inspector">Foundry Inspector</a>. I started working on this card by writing the test for it first and working up from there.</p>

<pre><code class="language-ruby"> require 'spec_helper'

RSpec.describe Magic::Game, "Mana spend -- Foundry Inspector + Free Sol Ring" do
  include_context "two player game"

  context "when at first main phase" do
    before do
      current_turn.untap!
      current_turn.upkeep!
      current_turn.draw!
      current_turn.first_main!
    end

    context "foundry inspector reduces sol ring cost" do
      let(:foundry_inspector) { Card("Foundry Inspector") }
      let(:sol_ring) { Card("Sol Ring") }

      before do
        p1.hand.add(foundry_inspector)
        p1.hand.add(sol_ring)
      end

      it "casts a foundry inspector and then a sol ring" do
        p1.add_mana(red: 3)
        action = Magic::Actions::Cast.new(player: p1, card: foundry_inspector)
        expect(action.can_perform?).to eq(true)
        action.pay_mana(generic: { red: 3 } )
        game.take_action(action)
        game.tick!

        action = Magic::Actions::Cast.new(player: p1, card: sol_ring)
        expect(action.can_perform?).to eq(true)
        game.take_action(action)

        game.tick!
        expect(p1.permanents.by_name(sol_ring.name).count).to eq(1)
      end
    end
  end
end
</code></pre>

<p>The body of the test ensures that we can pay 3 red mana to cast the Foundry Inspector, and then by casting that we can then cast the <a href="https://scryfall.com/card/dmc/190/sol-ring">Sol Ring</a> by not paying any mana at all. It finishes by using some more DSL code to ensure that the Sol Ring has been registered as a permanent controlled by Player 1.</p>

<hr />

<p>If you’re looking for where the proverbial bodies are buried on this particular project, well, there are <em>plenty</em>. This project was coded up over nights, after work and sometimes even after a glass of Port or two. Caution was thrown to the wind, and past that.</p>

<p>The worst of it would be demonstrated in <code>attacking_creature_creates_attacking_token_spec.rb</code>, where a card called <a href="https://scryfall.com/card/m21/18/falconer-adept">Falconer Adept</a> has a triggered ability of:</p>

<blockquote>
  <p>Whenever Falconer Adept attacks, create a 1/1 white Bird creature token with flying that’s tapped and attacking.</p>
</blockquote>

<p>What this means is that you can declare that Falconer Adept is attacking as a part of the <em>regular</em> “Declare Attackers” phase of combat, and then by doing that, a different game object (a Bird token) is created, where you will need to delcare what that Bird token is attacking. In effect, “Declare Attackers” happens <em>twice</em>.</p>

<p>You can see how this code is handled in the <code>Turn</code> class’s state machine, particularly anywhere the <code>final_attackers_declared</code> method is used.</p>

<p>This one took me a <em>long</em> time to implement.</p>

<hr />

<p>I like fiddling with this project. It’s outside my regular wheelhouse and is teaching me more about event-driven game programming.</p>

<p>If I get stuck on a card, it’s not like I <em>have</em> to implement it. There’s thousands more out there to choose from.</p>

<p>I’d suggest if your interested in practicing some Ruby code outside of the usual web sphere to find <a href="https://scryfall.com/random">a card at random</a> and attempting to impelment it here. Or if you’re looking for something more challenging, have a read through of this code and see if you can refactor it to handle certain events or effects in a more straightforward way.</p>
]]></content>
 </entry>
 
 <entry>
   <title>Are the switches on a Kinesis Gaming Freestyle Edge RGB Keyboard hot-swappable?</title>
   <link href="https://ryanbigg.com/2023/01/are-the-switches-on-a-kinesis-gaming-freestyle-edge-rgb-keyboard-hot-swappable"/>
   <updated>2023-01-28T00:00:00+11:00</updated>
   <id>https://ryanbigg.com/2023/01/are-the-switches-on-a-kinesis-gaming-freestyle-edge-rgb-keyboard-hot-swappable</id>
   <content type="html"><![CDATA[<p>No.</p>

<p>The switches on this keyboard are not hot-swappable. They are soldered on to the board.</p>

<p>(This post brought to you by attempting to find this information online, failing at that, and then dissecting the keyboard to inspect it myself.)</p>
]]></content>
 </entry>
 
 <entry>
   <title>Ruby GraphQL field notes</title>
   <link href="https://ryanbigg.com/2023/01/ruby-graphql-field-notes"/>
   <updated>2023-01-24T00:00:00+11:00</updated>
   <id>https://ryanbigg.com/2023/01/ruby-graphql-field-notes</id>
   <content type="html"><![CDATA[<p>Here’s a series of my notes of working within a GraphQL application as I can think of them. This comes out of my work on <a href="https://github.com/radar/twist-v2/blob/master/backend/lib/twist/web/graphql/schema.rb">Twist’s GraphQL API</a>, and other GraphQL APIs that are deployed in production.</p>

<p>Overall sentiment is that GraphQL is an improvement over the classic REST approach because:</p>

<ol>
  <li>It gives you clear types of fields</li>
  <li>You can choose which fields you wish to select</li>
  <li>You can choose to select from a single resource, or from multiple, disparate resources at the same time.</li>
</ol>

<p>I like its interoperability between Ruby and JavaScript, with good tooling existing on both sides of that divide in the <a href="https://rubygems.org/gems/graphql">GraphQL Rubygem</a> and the <a href="https://www.apollographql.com/docs/react/get-started/">Apollo Client</a> on the JavaScript side of things. Honorable mention to the <a href="https://the-guild.dev/graphql/codegen">GraphQL codegen</a> library too, which provides the ability of generating TypeScript types from a GraphQL schema.</p>

<h2 id="schema-definition">Schema definition</h2>

<p>A schema can be defined in <code>app/graphql</code> in a Rails application (since its <em>application</em> code), or a directory of your choosing in any other Ruby project.</p>

<p>I’d recommend disabling the introspection endpoints here so that 3rd parties cannot find out that your API contains particular admin-only endpoints. I’d also recommend setting up a <code>max_complexity</code> and a <code>max_depth</code> value. This prevents API requests from recursively requesting data (think post -&gt; comments -&gt; post -&gt; …), and from also building queries that might rate as “highly complex” database operations. You can read more about <a href="https://graphql-ruby.org/queries/complexity_and_depth">complexity and depth here</a>.</p>

<pre><code class="language-ruby">class AppSchema &lt; GraphQL::Schema
  mutation(Types::MutationType)
  query(Types::QueryType)
  disable_introspection_entry_points unless Rails.env.development?

  max_complexity 200
  max_depth 20
end
</code></pre>

<h2 id="schema-dumping-from-ruby">Schema dumping from Ruby</h2>

<p>On that topic, the Ruby library provides the ability to dump the schema out with a custom Rake task (that I’ve put in <code>lib/tasks/graphql.rake</code>)</p>

<pre><code class="language-ruby">require "graphql/rake_task"

GraphQL::RakeTask.new(
  schema_name: "AppSchema",
  directory: "./app/javascript/graphql",
  dependencies: [:environment]
)
</code></pre>

<p>Running this Rake task:</p>

<pre><code>bundle exec rake graphql:schema:dump
</code></pre>

<p>Will generate two files, a <code>schema.json</code> and a <code>schema.graphql</code>, which are both representations of the <em>shape</em> of the GraphQL API. Different tools (such as GraphQL codegen) can then use this schema to work with the GraphQL API.</p>

<h2 id="queries-and-resolvers">Queries and Resolvers</h2>

<p>The GraphQL Ruby library <a href="https://graphql-ruby.org/fields/introduction.html">recommends</a> defining the fields and their resolvers within the same class:</p>

<pre><code class="language-ruby">module Twist
  module Web
    module GraphQL
      class QueryType &lt; ::GraphQL::Schema::Object
        field :books, [Types::Book], null: false

        def books
          ...
        end
      end
    end
  end
end
</code></pre>

<p>I feel like this gets messy particularly quickly if your types have a large (&gt; 5) amount of fields.</p>

<p>For top level fields like this, I would recommend defining separate resolver classes:</p>

<pre><code class="language-ruby">field :books, [Types::Book], null: false, resolver: Resolvers::Books
</code></pre>

<pre><code class="language-ruby">module Twist
  module Web
    module GraphQL
      module Resolvers
        class Books &lt; Resolver
          def resolve
            ...
          end
        end
      end
    end
  end
end
</code></pre>

<p>This allows for you to have potentially complex logic for resolution separate from the field definitions, allowing you to read <em>what</em> fields are defined by looking at the type, rather than reading <em>what</em> the fields are and <em>how</em> they’re also implemented.</p>

<p>If we had a resolver for a book chapter, then I’d put that class under <code>Resolvers::Books::Chapters</code> to indicate that it’s not resolving <em>all</em> chapters, but rather chapters for a particular book.</p>

<h2 id="mutations">Mutations</h2>

<p>Along similar lines to queries and resolvers, I also suggest using separate classes for mutations, namespacing them down the lines of the particular <em>context</em> of the application (<code>Mutations::Users::Login</code>), or at least along the lines of the resource thats undergoing mutation:</p>

<pre><code class="language-ruby">field :add_comment, mutation: Mutations::Comments::Add
</code></pre>

<p>It’s worth noting that if your <code>BaseMutation</code> class inherits from <code>GraphQL::Schema::RelayClassicMutation</code>, that these mutations will have an <code>input</code> argument defined for them. In the GraphQL documentation, this would appear as:</p>

<pre><code>addComment(input: AddInput!): AddPayload
</code></pre>

<p>If you have a separate class called <code>Post::Add</code>, it will have an identical <code>AddInput</code> type and <code>AddPayload</code> defined. GraphQL supports only one type of each different name, and so we must differentiate these. To do this, inside the mutation class we define its <code>graphql_name</code>:</p>

<pre><code class="language-ruby">module Mutations
  class Comments::Add &lt; BaseMutation
    graphql_name "AddComment"
  end
end
</code></pre>

<p>This will rename both the input and payload types:</p>

<pre><code>addComment(input: AddCommentInput!): AddCommentPayload
</code></pre>

<h2 id="union-types">Union types</h2>

<p>Occassionally, it can be helpful to return one or another type from a GraphQL query or a mutation. For this, GraphQL has <em>union types</em>.</p>

<pre><code class="language-ruby">module Twist
  module Web
    module GraphQL
      module Types
        class BookPermissionCheckResult &lt; BaseUnion
          description "The result from attempting a login"
          possible_types Types::Book, Types::PermissionDenied

          def self.resolve_type(object, _context)
            if object.is_a?(Twist::Entities::Book)
              Types::Book
            else
              Types::PermissionDenied
            end
          end
        end
      end
    end
  end
end
</code></pre>

<p>This type is used in the <code>book</code> field:</p>

<pre><code class="language-ruby">field :book, Types::BookPermissionCheckResult, null: false, resolver: Resolvers::Book
</code></pre>

<p>If the resolver returns a <code>Twist::Entities::Book</code> instance, then this union type will use the GraphQL class <code>Types::Book</code> to resolve this field. Otherwise, it uses <code>Types::PermissionDenied</code>.</p>

<p>In the client-side GraphQL query, utilising these union types looks like this:</p>

<pre><code>query {
  book(permalink: "exploding-rails") {
    __typename
    ... on Book {
      id
      title
      defaultBranch {
        name
        chapters(part: FRONTMATTER) {
          ...chapterFields
        }
      }
    }

    ... on PermissionDenied {
      error
    }
  }
}
</code></pre>

<p>The query uses the GraphQL <code>__typename</code> to return the type of the <code>book</code> field. We can then read this type on the client side to determine how to act (to show a book, or not). The fields selected within both branches of this union allow us to display information about a book if the query has gone through successfully, without having to first check for permission, and then querying for a book.</p>

<p>The <code>resolve_type</code> method from union classes can also return an <em>array</em>:</p>

<pre><code class="language-ruby">def self.resolve_type(object, _context)
  if object.success?
    [Types::BookType, object.success]
  else
    [Types::PermissionDenied, object.failure]
  end
end
</code></pre>

<p>This is helpful if we wish to do something with the object being resolved. In this case, we’re unwrapping that <code>object</code> from a <code>Dry::Result</code> wrapping. If we did not do this unwrapping, then the <code>BookType</code> type would not be able to work on the object it receives, as the wrapped <code>Dry::Result</code> object does not have the <code>title</code> that <code>Types::Book</code> would expect that object to have.</p>

<h2 id="authentication">Authentication</h2>

<p>To authenticate against the GraphQL API, I’d recommend supporting sessions as well as authentication by tokens. While requests may come into the application from the same domain, they also may not. Allowing that flexibility of your API to be queryable by a 3rd party from the outset (assuming they have the right token!) can only be a good thing. It will also allow you to make requests from within tests by providing a token.</p>

<p>You can do this with something like the following code:</p>

<pre><code class="language-ruby">  def current_user

    @current_user = super
    @current_user ||= User.authenticate_by_token(request.authorization)
  end
</code></pre>

<h2 id="testing">Testing</h2>

<p>To test the GraphQL endpoints, I would recommend request specs over testing the schema itself by calling <code>Schema.execute(...)</code>. This ensures that you can run tests against your API as close to how it will be used as possible.</p>

<p>To aid in this, I like adding a <code>GraphqlHelpers</code> module with a little helper:</p>

<pre><code class="language-ruby">  def graphql_request(query:, variables: {})
    post "/graphql",
      params: {
        query: query,
        variables: variables,
      }.to_json,
      headers: { Authorization: user.token, 'Content-Type': "application/json" }
  end
</code></pre>

<p>You can then use this in a test:</p>

<pre><code class="language-ruby">query = %|
  query {
    book(permalink: "exploding-rails") {
      title
    }
  }
|

json = graphql_request(query: query)
expect(json.dig("book", "title")).to eq("Exploding Rails")
</code></pre>

<h2 id="preventing-n1-queries">Preventing N+1 queries</h2>

<p>By default, GraphQL Ruby will perform N+1 queries if you write a query such as:</p>

<pre><code>query {
  users {
    books {
      chapters
    }
  }
}
</code></pre>

<p>This will make one query for all the users, N queries for all of those users’ books, and M queries for all of those users’ books’ chapters.</p>

<p>To prevent N+1 queries, I’d recommend relying on the <code>GraphQL::Dataloader</code> features <a href="https://graphql-ruby.org/dataloader/overview.html">shown here</a>. This will collect all the IDs for the relevant resources, and then perform one large fetch for each of the users, each of the users’ books, and each of the users’ books’ chapters, resulting in only 3 queries.</p>
]]></content>
 </entry>
 
 <entry>
   <title>The method method</title>
   <link href="https://ryanbigg.com/2023/01/the-method-method"/>
   <updated>2023-01-20T00:00:00+11:00</updated>
   <id>https://ryanbigg.com/2023/01/the-method-method</id>
   <content type="html"><![CDATA[<p>The <code>method</code> method in Ruby is one of my favourite methods in Ruby. It gives you an object that represents an underlying method. It’s helpful for demonstrating that integer addition in Ruby is a method call:</p>

<pre><code>1.method(:+)
=&gt; #&lt;Method: Integer#+(_)&gt;
</code></pre>

<h2 id="where-is-this-method-defined">Where is this method defined?</h2>

<p>With this method <code>method</code>, you can find out where a method is defined, if it is defined in Ruby code anywhere:</p>

<pre><code>SomeModel.method(:find).source_location
=&gt; ["...activerecord-x.x.x/lib/active_record/core.rb", 337]
</code></pre>

<p>Then I can look at this source code within the Active Record gem to <em>find out</em> how <code>find</code> works.</p>

<h2 id="call-me-maybe">Call me, maybe?</h2>

<p>Methods can also be passed in place of traditional block arguments:</p>

<pre><code>class Maths
  def self.square(num)
    num ** 2
  end
end

square = Maths.method(:square)

[1, 2, 3, 4].map(&amp;square)
</code></pre>

<p>The <code>map</code> syntax here is short-hand for:</p>

<pre><code>[1, 2, 3, 4].map { |number| square.call(number) }
</code></pre>

<p>Which is exactly the same behaviour that a <code>Proc</code> has:</p>

<pre><code>a_proc = -&gt; (num) { num ** 2 }
[1, 2, 3, 4].map(&amp;square)
</code></pre>

<h2 id="more-documentation">More documentation</h2>

<p>You can find more about the <a href="https://devdocs.io/ruby~3.1/method">Method class</a> here. You can even find out why this code returns <code>true</code>:</p>

<pre><code>def moo(arg) arg == 3; end

number = 3
case number
when method(:moo)
  true
else
  false
end
</code></pre>
]]></content>
 </entry>
 
 <entry>
   <title>CSS :has selector for selects that have options</title>
   <link href="https://ryanbigg.com/2022/12/using-a-css-has-selector-to-target-selects-that-have-selected-options"/>
   <updated>2022-12-02T00:00:00+11:00</updated>
   <id>https://ryanbigg.com/2022/12/using-a-css-has-selector-to-target-selects-that-have-selected-options</id>
   <content type="html"><![CDATA[<p>Based on a question on the Ruby AU Slack, someone wanted to know how they could make a 2nd select box appear after an option in an original select box was selected.</p>

<p>I worked out today that thanks to the new <code>:has</code> selector in CSS, you can achieve this:</p>

<div class="mb-4">
<p class="codepen" data-height="300" data-default-tab="html,result" data-slug-hash="bGKmaRz" data-user="ryanbigg" style="height: 300px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; border: 2px solid; margin: 1em 0; padding: 1em;">
  <span>See the Pen <a href="https://codepen.io/ryanbigg/pen/bGKmaRz">
  Untitled</a> by Ryan Bigg (<a href="https://codepen.io/ryanbigg">@ryanbigg</a>)
  on <a href="https://codepen.io">CodePen</a>.</span>
</p>
</div>
<script async="" src="https://cpwebassets.codepen.io/assets/embed/ei.js"></script>

<p><strong>This demo will work in most modern browsers, with the exception of Internet Explorer 11 and Firefox.</strong> Selecting from the 1st select box will make the 2nd one appear, then selecting from that makes the 3rd box appear.</p>

<p>Given that this feature is <em>currently</em> not supported in either IE11 (at all) or Firefox (without enabling a configuration flag), I would be hesitant to use it in production.</p>

<p>Nevertheless, it’s pretty cool to see that CSS can do this and we do not have to reach for JavaScript.</p>
]]></content>
 </entry>
 
 <entry>
   <title>Hanami 2.0 Thoughts</title>
   <link href="https://ryanbigg.com/2022/11/hanami-20-thoughts"/>
   <updated>2022-11-28T00:00:00+11:00</updated>
   <id>https://ryanbigg.com/2022/11/hanami-20-thoughts</id>
   <content type="html"><![CDATA[<p><a href="https://ryanbigg.com/2018/03/my-thoughts-on-hanami">I’ve been a fan of Hanami</a> for a number of years now. One of my favourite apps to work on is <a href="https://github.com/radar/twist-v2">even an open-source Hanami app!</a> I have also been writing <a href="https://github.com/radar/chirper">an ActivityPub app called “Chirper”</a> in Hanami.</p>

<p>Now that Hanami 2.0 has come out, a few people have been asking me for my thoughts on this major Hanami release.</p>

<p><strong>The headline is: it’s really, really fast. It’s really clean. And it’s really good if you’re building an API at the moment.</strong></p>

<p>It’s currently missing opinions/support on a view layer (so no templating) and DB persistence (although the Getting Started guide does recommend a way to set it up). Hanami 2.1 is supposed to come out (in early 2023) with proper baked-in support for both of those things.</p>

<p>When working on Chirper, I haven’t missed view templates as the application is all APIs. And I didn’t mind that there wasn’t a built-in configuration for databases, as the Getting Started guide for Hanami provided everything I needed there. It was refreshing to be able to “choose my own adventure” in that way, allowing me to opt for even something such as <a href="https://rubygems.org/gems/sequel">Sequel</a> if I chose to.</p>

<p>I like that Hanami hasn’t got an opinion du jour on JavaScript and CSS assets, like Rails had with Sprockets, Webpacker, etc. It leaves that particular responsibility up to the build tools that are great at that, such as ESBuild.</p>

<p>I love that the actions are clearly separated out into their own classes, rather than all being bundled into a single class. I love that you can <a href="https://github.com/radar/chirper/blob/40c4c532449deedbfaaac61dd2914fde7728cd97/app/actions/api/accounts/outbox.rb#L12-L17">specify the types of parameters</a> that an action receives.</p>

<p>I really enjoy the dependency injection support that <a href="https://github.com/radar/chirper/blob/81504258fbe74e3269c4f7ab013d6f0009b38cb6/spec/activity_pub/processors/create_spec.rb#L3-L7">allows me to test parts of the application without hitting a real database</a>. This makes those tests really fast. In the class itself, dependency injection also highlights the dependencies that a particular class has. If you notice the list of <code>Deps</code> getting long, then it’s a good sign that the class is trying to do too much; such a thing signposts the complexity of the class right at the top.</p>

<p>I love that <a href="https://github.com/decafsucks/decafsucks">Tim Riley, who is on the Hanami Core Team, is re-building Decaf Sucks in public</a> to really show how it’s done.</p>

<p>There’s also a bunch of <a href="https://hanamimastery.com/">Hanami screencasts (HanamiMastery) recorded by Seb Wilgosz</a>, which come in both video and text format.</p>

<p>Overall, I’m glad that the Hanami team has taken their time to really polish up this release, and I’m looking forward to building more things in what is shaping up to be <em>the</em> Ruby web framework of the future.</p>
]]></content>
 </entry>
 
 <entry>
   <title>The Gem Foundation</title>
   <link href="https://ryanbigg.com/2022/11/the-gem-foundation"/>
   <updated>2022-11-24T00:00:00+11:00</updated>
   <id>https://ryanbigg.com/2022/11/the-gem-foundation</id>
   <content type="html"><![CDATA[<div class="text-3xl text-center"><p>Today, I am excited to announce the launch of <strong>The Gem Foundation</strong>.</p></div>

<p>Its mission is assist contributors in the Ruby community in their task to further the adoption of the Ruby language, expanding the scope more broadly than just one particular web framework.</p>

<p>Because Ruby <em>is</em> more than just a single framework.</p>

<p>Immediately after establishment of this foundation, we have already surpassed <a href="https://rubyonrails.org/2022/11/14/the-rails-foundation">The Rails Foundation</a> in terms of dollars donated, as we have donated <strong>ONE SINGLE U.S. DOLLAR</strong> to <a href="https://ruby.social/@baweaver">Brandon Weaver</a>, who was the first developer to get in touch with the foundation. Brandon contributes to the Ruby community by <a href="https://dev.to/baweaver">writing articles on his personal blog</a>, and also runs the Ruby Learning Center Discord.</p>

<p>The Gem Foundation has also donated <strong>TWO U.S. DOLLARS</strong> to <a href="https://ruby.social/@jaredwhite@indieweb.social">Jared White</a>, who is a contributor to <a href="https://www.bridgetownrb.com/">the Bridgetown</a> site generator.</p>

<p>The Gem Foundation is also contributing $25/USD a month towards the <a href="https://github.com/sponsors/hanami">Hanami</a> web framework. If you would like there to be real competition in the Ruby web framework sphere, I would encourage you to do the same.</p>

<p>That’s <em>$28USD</em> already donated by the Gem Foundation!</p>

<hr />

<p><strong>UPDATE</strong>: Kieran Andrews from Adelaide (and of <a href="https://activerailsbook.com">Active Rails fame</a>) has also donated <em>$30USD</em> to the <a href="https://github.com/pry/pry">Pry gem</a>, bringing The Gem Foundation’s donation total up to $58USD!</p>

<p><strong>UPDATE #2</strong>: As it’s now the 1st of December, a payment of $35USD has been made to the Hanami organisation on GitHub. This brings our total donations almost to $100!</p>

<p><strong>UPDATE #3</strong>: As it’s now the 1st of February, yet another payment of $35USD has been made to the Hanami organisation on GitHub. This brings our total of donations up to $173.</p>

<p><strong>UPDATE #4</strong>: As it’s now the 1st of March, yet another payment of $35USD has been made to the Hanami organisation on GitHub. This brings our total of donations up to $208.</p>

<p><strong>UPDATE #5</strong>: As it’s now the 1st of April, yet another payment of $35USD has been made to the Hanami organisation on GitHub. We have also donated $75 to other members of the Ruby community for their work on open source projects, with a remaining $125 “prize pool” for further pull requests for code or documentation work. This brings our total of donations up to $318.</p>

<p><strong>UPDATE #6</strong>: As it’s now the 1st of May, yet another payment of $35USD has been made to the Hanami organisation on GitHub. This brings our donations up to $353USD.</p>

<p><strong>UPDATE #7</strong>: As it’s now the 1st of June, yet another payment of $35USD has been made to the Hanami organisation on GitHub. This brings our donations up to $388USD.</p>

<p><strong>UPDATE #8</strong>: As it’s now the 1st of July, yet another payment of $35USD has been made to the Hanami organisation on GitHub. This brings our donations up to $423USD.</p>

<p><strong>UPDATE #9</strong>: As it’s now the 1st of August, yet another payment of $35USD has been made to the Hanami organisation on GitHub. This brings our donations up to $458USD. But wait, there’s more!</p>

<p><a href="https://www.appsignal.com/">Roy from AppSignal</a> has donated $1,000USD to the Gem Foundation <a href="https://ruby.social/@roy/110654296954182817">to be distributed at my discretion</a>. Thanks a lot Roy!</p>

<p>I’ve divvied out $200 of this to <a href="https://github.com/soutaro/">Soutaro Matsumoto</a> for his work on Steep and Ruby’s RBS type signature library.</p>

<p>A second $200 was going to be sent to Jemma Issroff for her work on Ruby’s YARP (Yet Another Ruby Parser), but she has instead asked the money to go towards <a href="https://www.wnb-rb.dev/">WNB.rb</a>, which is a virtual community for women and non-binary Rubyists.</p>

<p>Another $100 is going towards <a href="https://github.com/sponsors/postmodern">postmodern</a> who has worked on a wealth of tooling for Ruby, including chruby and ruby-install. This donation though is due to their continued work on maintaining the <a href="https://github.com/rubysec/ruby-advisory-db">Ruby Advisory Database</a> and the Bundler Audit project. These projects alert developers to potential security vulnerabilities in their applications, and are incredibly useful!</p>

<p>Another $100 is going towards <a href="https://github.com/ioquatix">Samuel Williams (ioquatix)</a> for his work on Rack 3, and concurrency libraries within Ruby, such as <a href="https://github.com/socketry/async">async</a>. Samuel’s really pushing the concurrency state-of-the-art forward, and for that I am thankful!</p>

<p>That now leaves $400 unallocated. I’ve got a couple of ideas of where this money could go, but I’m going to solicit some opinions of where that money should go by asking a few more people. If you’d like to share your opinion, you can send an email to <a href="mailto:me@ryanbigg.com">me@ryanbigg.com</a> with the subject “Gem Foundation Donation”.</p>

<p>So far, we have donated $1,058USD, with hopefully by next month’s update that being at least $1,500. Unless some other benevolent donor like Roy comes along to sweeten the pot.</p>

<p>As always, here’s a helpful chart to track our donations:</p>

<p><img src="/images/gem-foundation/donations.png" alt="The Gem Foundation donations" /></p>
]]></content>
 </entry>
 
 <entry>
   <title>A replacement for strong parameters</title>
   <link href="https://ryanbigg.com/2022/11/a-replacement-for-strong-parameters"/>
   <updated>2022-11-09T00:00:00+11:00</updated>
   <id>https://ryanbigg.com/2022/11/a-replacement-for-strong-parameters</id>
   <content type="html"><![CDATA[<p>I’m not going to take <a href="https://dev.37signals.com/vanilla-rails-is-plenty">this week’s (very obvious) bait about how “Vanilla Rails is plenty”</a>.</p>

<p>In the past, I’ve spent effort watching DHH’s videos and <a href="https://ryanbigg.com/2018/03/on-writing-software-well-2-a-review">issuing a (time-stamped) rebuttal</a>, and writing up about <a href="https://ryanbigg.com/2017/06/current-considered-harmful">a new Rails feature I would consider harmful</a>.</p>

<p style="font-size: 125%"><strong>I even <a href="https://leanpub.com/maintain-rails/">wrote a book called Maintainable Rails</a> that offers my take on how to build a maintainable Rails application. A whole 30,000 words of it!</strong></p>

<p>I am not going to follow that pattern today, even though the vanilla Rails article is <em>concerning</em>.</p>

<p>You know, if their apps were <em>maintainable</em>, then they wouldn’t need to keep re-writing them completely, yeah?</p>

<p>I digress.</p>

<p>Today, I want to cover a <em>different</em> feature of Rails that I think could be improved: strong parameters.</p>

<p>The <a href="https://guides.rubyonrails.org/action_controller_overview.html#nested-parameters">documentation for strong_parameters</a> always makes me a little confused with all of its different kinds of brackets. It feels like someone discovered Lisp and then thought it would be good to have as many brackets in Ruby, only to abandon the idea half-way.</p>

<p>Here’s a complicated example from that documentation.</p>

<pre><code class="language-ruby">params.permit(:name, { emails: [] },
              friends: [ :name,
                         { family: [ :name ], hobbies: [] }])
</code></pre>

<p>The documentation goes on to explain:</p>

<blockquote>
  <p>This declaration permits the name, emails, and friends attributes. It is expected that emails will be an array of permitted scalar values, and that friends will be an array of resources with specific attributes: they should have a name attribute (any permitted scalar values allowed), a hobbies attribute as an array of permitted scalar values, and a family attribute which is restricted to having a name (any permitted scalar values allowed here, too).</p>
</blockquote>

<p>The documentation also explains that the permitted scalar values are:</p>

<pre><code>The permitted scalar types are `String`, `Symbol`, `NilClass`, `Numeric`, `TrueClass`, `FalseClass`, `Date`, `Time`, `DateTime`, `StringIO`, `IO`, `ActionDispatch::Http::UploadedFile`, and `Rack::Test::UploadedFile`.
</code></pre>

<p>That’s quite a few permitted types!</p>

<p>How might we approach this differently? I think we could do this in a clearer fashion with a gem called <a href="https://dry-rb.org/gems/dry-schema/1.10/">dry-schema</a>. The dry-schema gem allows us to define particular schemas that our data should comply with, and like strong parameters it will automatically drop keys that are not specified in the schema itself.</p>

<h3 id="creating-the-schema">Creating the schema</h3>

<p>Let’s try creating a schema from the above strong parameters code, but this time in dry-schema. I’m also going to add an extra field here called age:</p>

<pre><code class="language-ruby">PersonSchema = Dry::Schema.Params do
  required(:name).filled(:string)
  required(:age).filled(:integer)
  required(:emails).value(array[:string]).value(min_size?: 1)
  required(:friends).array(:hash) do
    required(:name).filled(:string)
    required(:family).hash do
      required(:name).filled(:string)
    end
  end
  required(:hobbies).array(:string)
end
</code></pre>

<p>With this schema we’re clearly defining the types of the data that we expect. Now we’ve limited the type of <code>name</code> to string, so it can no longer accept a file for its value. That is probably for the best.</p>

<p>The <code>required(:friends).array(:hash)</code> syntax might hurt a little bit to read, but it means “an array of any length, where the values are all hashes”. The block of this method then defines the permitted keys within those hashes.</p>

<p>You could define this schema at the top of your controller, if you like, or in its own file at <code>app/schemas/person_schema.rb</code>. It really should depend on the context in which it is used.</p>

<p>It goes further than strong parameters, because it specifies the types expected for things such as emails and hobbies, whereas strong parameters would allow any “permitted scalar values” in there, including things such as numbers. The <code>dry-schema</code> version <em>also</em> specifies that there has to be at least one email address.</p>

<h3 id="using-a-valid-set-of-parameters">Using a valid set of parameters</h3>

<p>A hash that would pass the checks for this schema.</p>

<pre><code class="language-ruby">params = {
  name: "Ryan",
  age: 34,
  emails: ["me@ryanbigg.com"],
  hobbies: ["MTG", "Coding"],
  friends: [
    {
      name: "Dear",
      family: { name: "Reader" }
    }
  ]
}
</code></pre>

<p>We can check this with:</p>

<pre><code class="language-ruby">result = PersonSchema.(params)
</code></pre>

<p>We will get a <code>Dry::Schema::Result</code> back from this, which we can grab the output of with:</p>

<pre><code>result.output
</code></pre>

<h3 id="type-coercions">Type-coercions</h3>

<p>Another hash that would pass the checks, even though it might not look like it, is this one:</p>

<pre><code class="language-ruby">params = {
  name: "Ryan",
  age: "34",
  emails: ["me@ryanbigg.com"],
  hobbies: ["MTG", "Coding"],
  friends: [
    {
      name: "Dear",
      family: { name: "Reader" }
    }
  ]
}
</code></pre>

<p>The <code>age</code> key here is specified as a string, but the schema says the type must be an <code>integer</code>. Let’s look at what happens:</p>

<pre><code class="language-ruby">result = PersonSchema.(params)
result.output[:age] # =&gt; 34
</code></pre>

<p>The <code>Dry::Schema.Params</code> type will do its best to cooerce string parameter values to their matching Ruby counterparts. This will also work for things such as dates in the “YYYY-MM-DD” formats, too. No more needing to do a <code>Date.parse</code> if that parameter is being sent to something else, like a service object instead of a model.</p>

<h3 id="unknown-keys-are-removed">Unknown Keys are removed</h3>

<p>Like with strong parameters, if we attempt to pass an extra key:</p>

<pre><code class="language-ruby">params = {
  name: "Ryan",
  age: 34,
  emails: ["me@ryanbigg.com"],
  hobbies: ["MTG", "Coding"],
  friends: [
    {
      name: "Dear",
      family: { name: "Reader" }
    }
  ],
  very_smart: true
}
</code></pre>

<p>Then the schema will remove this additional key, proving that I am just regular smart, if that.</p>

<h3 id="re-using-schemas">Re-using schemas</h3>

<p><code>dry-schema</code> also allows us to re-use schemas. Let’s say that we have two schemas, our <code>PersonSchema</code> and another schema called <code>FriendSchema</code> that defines the shape of the friend keys. Heres how we could use those together:</p>

<pre><code class="language-ruby">FriendSchema = Dry::Schema.params do
  required(:name).filled(:string)
  required(:family).hash do
    required(:name).filled(:string)
  end
end

PersonSchema = Dry::Schema.Params do
  required(:name).filled(:string)
  required(:age).filled(:integer)
  required(:emails).value(array[:string]).value(min_size?: 1)
  required(:friends).array(FriendSchema)
  required(:hobbies).array(:string)
end
</code></pre>

<p>This is particularly helpful if you had a couple of complicated data structures that you wanted to validate at the same time, and use each of those schemas in different locations.</p>

<p>I’d like to see strong parameters do that!</p>

<h3 id="error-messages-are-provided">Error messages are provided</h3>

<p>If the hash passed in is completely invalid, like this one:</p>

<pre><code class="language-ruby">params = {}
result = PersonSchema.(params)
</code></pre>

<p>Then we can retrieve error messages that are similar to Active Model validations back out:</p>

<pre><code>=&gt; {:name=&gt;["is missing"], :age=&gt;["is missing"], :emails=&gt;["is missing"], :friends=&gt;["is missing"], :hobbies=&gt;["is missing"]}
</code></pre>

<p>On top of this, the <code>result</code> is also going to respond to <code>success?</code> with <code>false</code>, meaning we could use this in a controller action to check if the parameters are valid, before even passing them to their final destination. That might be a model (with, perhaps, it’s own validations), or it could
be another service.</p>

<hr />

<p>I’ve only scratched the surface on what <code>dry-schema</code> can do. I purposely wanted to keep this post short today to cover how it could replace strong parameters within Rails to provide a much better developer experience than that bracketed mess.</p>

<p>If you’d like to know what else dry-schema can do, make sure to check out <a href="https://dry-rb.org/gems/dry-schema/">its documentation here</a>.</p>
]]></content>
 </entry>
 
 <entry>
   <title>Using Union Types with GraphQL Mutations in Ruby</title>
   <link href="https://ryanbigg.com/2022/05/ruby-graphql-mutations-with-union-types"/>
   <updated>2022-05-06T00:00:00+10:00</updated>
   <id>https://ryanbigg.com/2022/05/ruby-graphql-mutations-with-union-types</id>
   <content type="html"><![CDATA[<p>The <a href="https://graphql-ruby.org/mutations/mutation_classes.html">official documentation for the graphql-ruby gem</a> recommends this code for a mutation class that can either succeed or fail:</p>

<pre><code class="language-ruby">class Mutations::CreateComment &lt; Mutations::BaseMutation
  argument :body, String
  argument :post_id, ID

  field :comment, Types::Comment
  field :errors, [String], null: false

  def resolve(body:, post_id:)
    post = Post.find(post_id)
    comment = post.comments.build(body: body, author: context[:current_user])
    if comment.save
      # Successful creation, return the created object with no errors
      {
        comment: comment,
        errors: [],
      }
    else
      # Failed save, return the errors to the client
      {
        comment: nil,
        errors: comment.errors.full_messages
      }
    end
  end
end
</code></pre>

<p>I’d like to show an alternative to this that I think leads to cleaner code by using GraphQL concept called <em>union types</em>.</p>

<p>We use union types in GraphQL when we want a field to return one or more distinct types as its result. In the case of the above comment mutation, the two types of things we would like to return are either:</p>

<ul>
  <li>A comment, if the mutation was successful</li>
  <li>Errors, if the mutation was unsuccessful</li>
</ul>

<p>Let’s change that mutation above to use a union type by declaring the type at the top of the mutation, and removing the two fields:</p>

<pre><code class="language-ruby">class Mutations::CreateComment &lt; Mutations::BaseMutation
  type Types::CreateCommentResult
  argument :body, String
  argument :post_id, ID

  def resolve(body:, post_id:)
    post = Post.find(post_id)
    comment = post.comments.build(body: body, author: context[:current_user])
    if comment.save
      # Successful creation, return the created object with no errors
      {
        comment: comment,
        errors: [],
      }
    else
      # Failed save, return the errors to the client
      {
        comment: nil,
        errors: comment.errors.full_messages
      }
    end
  end
end
</code></pre>

<p>This new type will be our union type that will represent either a successful creation for a comment, or a failed one.</p>

<p>We can define this type in our <code>types</code> directory under <code>graphql</code>, in a file called <code>create_comment_result.rb</code>:</p>

<pre><code class="language-ruby">module Types
  class CreateCommentResult &lt; BaseUnion
    description "The result from attempting to create a comment"
    possible_types Types::Comment, Types::Errors

    def self.resolve_type(object, _context)
      if object[:comment]
        [Types::Comment, object[:comment]]
      else
        [Types::Errors, object]
      end
    end
  end
end
</code></pre>

<p>A union type is defined by first inheriting from <code>BaseUnion</code>. If we had common logic to share between union types in our GraphQL API, that logic would go into <code>BaseUnion</code>.</p>

<p>Inside this <code>CreateCommentResult</code> type itself, we provide a description that’ll appear in our API documentation, and inform this class what the possible types are. For this union type, we’re defining two possible types: <code>Types::Comment</code>, and <code>Types::Errors</code>.</p>

<p>When the GraphQL code runs, it will call this <code>resolve_type</code> method to determine the correct GraphQL type to use when representing the result of the mutation. This method checks if <code>object[:comment]</code> is present, and if it is the type that’ll be used is a <code>Types::Comment</code>, and we can fetch the comment from that object using <code>object[:comment]</code>. In Rails parlance, this <code>object[:comment]</code> will be an instance of the <code>Comment</code> model – a result of a successful <code>build</code> and <code>save</code>.</p>

<p>If the operation was to fail, we would instead return a <code>Types::Error</code> type, and use the resulting object as the base object for that type.</p>

<p>These two types can be defined in the <code>types</code> directory too. Let’s look at <code>CommentType</code> first, defined in <code>types/comment.rb</code>:</p>

<pre><code class="language-ruby">class Types::Comment &lt; Types::BaseObject
  field :id, ID, null: false
  field :body, String, null: false
end
</code></pre>

<p>This type is used to represent comments in our GraphQL API. It provides access to both the <code>id</code> and <code>body</code> attributes from any <code>Comment</code> instance that is represented by this API.</p>

<p>Then, the <code>Errors</code> type:</p>

<pre><code class="language-ruby">class Types::Errors &lt; Types::BaseObject
  field :errors, [String], null: false
end
</code></pre>

<p>This type represents the <code>{ comment: nil, errors: [...] }</code> hash that will be returned when a comment creation fails.</p>

<p>With these union types setup, we can write this GraphQL query that will rely on them:</p>

<pre><code>mutation {
  createComment(input: { postId: 1, body: "Hello world" }) {
    __typename
    ... on Comment {
      id
    }

    ...on Errors {
      errors
    }
  }
}
</code></pre>

<p>Firstly, we call this mutation by passing in its required arguments. After that, we fetch a field called <code>__typename</code>. This field is automatically defined, and it will return the type whatever object is returned, either <code>Comment</code> or <code>Errors</code>. When calling this GraphQL API, we can use <code>__typename</code> to determine how to act.</p>

<p>The <code>... on</code> syntax here tells GraphQL which fields we would like to use in the case of each part of the union being returned here. If it’s a comment, we will fetch just the <code>id</code>. If it’s <code>Errors</code>, we can fetch just the errors.</p>

<p>If we were to call this mutation with an empty comment body, we would see this as the result:</p>

<pre><code class="language-json">{
  "data": {
    "createComment": {
      "__typename": "Errors",
      "errors": [
        "Body can't be blank"
      ]
    }
  }
}
</code></pre>

<p>And if we were to call it with a valid body, we would see this:</p>

<pre><code class="language-json">{
  "data": {
    "createComment": {
      "__typename": "Comment",
      "id": "6"
    }
  }
}
</code></pre>

<p>When using this API (for example, within a frontend codebase), we can assert on <code>__typename</code> to determine how to show the result to a user – if it’s a <code>Comment</code>, then indicate a successful comment creation. If it’s <code>Errors</code>, then show those errors on the form.</p>
]]></content>
 </entry>
 
 <entry>
   <title>Typed View Components with dry-types</title>
   <link href="https://ryanbigg.com/2022/03/typed-view-components"/>
   <updated>2022-03-08T00:00:00+11:00</updated>
   <id>https://ryanbigg.com/2022/03/typed-view-components</id>
   <content type="html"><![CDATA[<p>This post was originally inspired by <a href="https://twitter.com/RogersKonnor">Konnor Rogers</a>, and <a href="https://gist.github.com/ParamagicDev/5dc17dea9e8ab414d227461ae521f011">this gist from him</a>.</p>

<hr />

<p>Last year, I wrote about <a href="https://ryanbigg.com/2021/04/view-components-the-missing-link">View Components</a> for the first time. That post demonstrated how you could use View Components to bridge the gap between Ruby and React by using a View Component to build up the props for a React component.</p>

<p>Since then, I’ve joined <a href="https://fatzebra.com">Fat Zebra</a> and we’re doing a lot of work involving Rails, React and View Components.</p>

<p>One thing we’ve discovered that helps with using View Components is adding types by using the <code>dry-initializer</code> and <code>dry-types</code> to those View Components. While we have the protection of types in TypeScript, we do not have the same level of protection in Ruby. And since TypeScript only does compile-time checking, it means that we could pass a property from these Ruby View Components down to our React components where that property’s type is incorrect.</p>

<p>Take for (contrived) example, this simple component that takes in a <code>standalone</code> property.</p>

<pre><code class="language-ruby">class RefundComponent &lt; ViewComponent::Base
  attr_reader :standalone

  def initialize(standalone:)
    @standalone = standalone
  end

  def props
    {
      standalone: standalone,
      # ...
    }
  end
end
</code></pre>

<p>There’s nothing in this component that dictates the type for <code>standalone</code>. It should be a boolean. It <em>could be</em> a string, or a number, or literally any valid object in Ruby. So when this component is used in this way:</p>

<pre><code class="language-ruby">render RefundComponent.new(standalone: params[:standalone])
</code></pre>

<p>What’s going to happen here?</p>

<p>Well, if we <em>think</em> standalone is a boolean, we can expect <code>params[:standalone]</code> is going to be either <code>"true"</code> or <code>"false"</code> ,given that Rails parameters are stringified.</p>

<p>Inside our React component, we might have code like this.</p>

<pre><code class="language-tsx">{standalone ? "Standalone" : "Not Standalone"}
</code></pre>

<p>The string <code>"true"</code> does the same as the boolean <code>true</code>. The string <code>"false"</code> does not do the same as the boolean <code>"false"</code>.</p>

<p>This is completely innocent code, and the kind that we might write any old day. Nothing stopped us from writing it. In fact, TypeScript gave us <em>two</em> thumbs up when we compiled our React code. Ruby doesn’t care. Ruby’s fine as long as the syntax is correct.</p>

<hr />

<p>To prevent a mistake like this, we can use the <code>dry-initializer</code> and <code>dry-types</code> gems like this:</p>

<pre><code class="language-ruby">class RefundComponent &lt; ViewComponent::Base
  extend Dry::Initializer
  Types = Dry.Types()

  option :standalone, Types::Bool

  def props
    {
      standalone: standalone,
      # ...
    }
  end
end
</code></pre>

<p>The <code>Types</code> constant here is usually defined on a more “global” level. For example, you might define it at <code>lib/types.rb</code> for your entire application. I’ve just included it in the class here for brevity.</p>

<p>The <code>option</code> method here defines a keyword argument initializer for <code>RefundComponent</code>, so this means our component will still be able to be rendered in the same way:</p>

<pre><code class="language-ruby">render RefundComponent.new(standalone: params[:standalone])
</code></pre>

<p>But this time, if we pass it a stringly-typed <code>standalone</code> here, it will show us an error:</p>

<pre><code>"false" violates constraints (type?(FalseClass, "false") failed) (Dry::Types::ConstraintError)
</code></pre>

<p>The error message is wordy, but with enough practice (just like TypeScript!) we can learn to read these. The error message here says that the type of <code>FalseClass</code>, is not the same type as <code>"false"</code>.</p>

<p>We cannot pass the stringly-typed <code>params[:standalone]</code> here anymore.</p>

<p>Instead, we would have to convert this parameter to a boolean so that our code would work:</p>

<pre><code>render RefundComponent.new(standalone: params[:standalone] == 'true')
</code></pre>

<h3 id="but-wait-theres-more">But wait, there’s more…</h3>

<p>We can also use <code>dry-types</code> to define the types for our properties too, in case we had some complicated logic there.  Perhaps we have an amount that is returned, and we want to guarantee it’s a float by the time it gets to our React library. To spice things up, for legacy reasons the <code>amount</code> arrives at our component as a string, not a float. With this amount also comes a currency property, which is also a string.</p>

<p>Here’s how we would handle that by using another <code>dry-rb</code> library, <code>dry-struct</code>:</p>

<pre><code class="language-ruby">class RefundComponent &lt; ViewComponent::Base
  extend Dry::Initializer
  Types = Dry.Types()

  option :standalone, Types::Bool
  option :amount, Types::String
  option :currency, Types::String

  class Props &lt; Dry::Struct
    schema schema.strict

    attribute :standalone, Types::Bool
    attribute :amount, Types::Float
    attribute :currency, Types::String
  end

  def props
    Props.new(
      standalone: standalone,
      amount: amount.to_money(currency).to_f,
      currency: currency,
      # ...
    ).to_h
  end
end
</code></pre>

<p>This way, we can call <code>RefundComponent</code> with a stringified <code>amount</code>, and have <code>props</code> be the correct type:</p>

<pre><code>&gt;&gt; component = RefundComponent.new(standalone: params[:standalone] == 'true', amount: "1234", currency: "AUD")
=&gt; #&lt;RefundComponent:0x000000013e6a76a8 @amount="1234", @currency="AUD", @standalone=true&gt;
&gt;&gt; component.props
=&gt; {:standalone=&gt;true, :amount=&gt;1234.0, :currency=&gt;"AUD"}
</code></pre>

<p>If the type of <code>Props#amount</code> (once it has been coerced) wasn’t a float and instead was an integer, like this:</p>

<pre><code class="language-ruby">amount: amount.to_money(currency).to_i,
</code></pre>

<p>This code would cause this error:</p>

<pre><code>1234 (Integer) has invalid type for :amount violates constraints (type?(Float, 1234) failed) (Dry::Types::SchemaError)
</code></pre>

<p>This helps alert us to a typing issue earlier on in our code, before it even reaches our React code.</p>
]]></content>
 </entry>
 
 <entry>
   <title>Culture and Values</title>
   <link href="https://ryanbigg.com/2021/12/culture-and-values"/>
   <updated>2021-12-09T00:00:00+11:00</updated>
   <id>https://ryanbigg.com/2021/12/culture-and-values</id>
   <content type="html"><![CDATA[<p>It’s been one year since I was fired.</p>

<p>The Big Boss at the time wanted everyone to work out of an office in Melbourne (because by the end of 2020, everyone thought that The Pandemic was <em>over</em>), and I was moving 250km to the west.</p>

<p>What’s more, is that I was an opinionated asshole who cared too much about things and got angry about it. The whole pandemic thing didn’t help.</p>

<p>It was the third time I had been let go from a job in just over a year. I was made redundant in November 2019 and again in April 2020. In 13 months, I had left 3 jobs. That doesn’t look so good on a resume.</p>

<p>So I thought I should change things this year – usher in a new era of stability for myself and my family… and instead undertook consultancy work which has meant that I’ve had <em>at least</em> 4 on-the-books jobs this year. But why go into consultancy after so many years of working full-time? And <em>especially</em> why go into consultancy work despite wanting all that precious stability? And in the same year that I got a mortgage?</p>

<p>Sure, the consulting money’s good (like, really good), but there’s a simpler answer: burnout.</p>

<p>I was burned out on companies, especially when it came to the culture and values they espoused. <em>Especially</em> the “F” word: “family”.</p>

<p>I became too invested in those companies, and when it was time to wrap things up there, it was traumatic and devastating. There’s no nice way to sugar-coat things.</p>

<p>I want to share a bit about the history of that trauma today, as (I guess) a way of coping with it.</p>

<p>Perhaps others out there have experienced similar situations. I share this to cope, but I also share this to say to those people that you are not alone, and things can get better.</p>

<h2 id="2019-redundancy">2019 Redundancy</h2>

<p>The job I was made redundant from 2019 was my favourite job so far. I was running a Junior Engineering Program, and had trained up about 20 different developers. I was expressly told to start plotting and scheming for a 3rd iteration of that program. Two weeks after the “plotting and scheming” meeting, I was told I would be offered a redundancy. I took the remainder of that week off to cope with the whiplash.</p>

<p>This was in July. I was slated to wrap up in November. It was a nice long goodbye.</p>

<p>I cared deeply about the company, and its mission, and its people. I forgave it for its sins and transgressions.</p>

<p>I forgave it for its office in Richmond with its oddly-named, incredibly stuffy meeting rooms. The same office that had windows that were fixed opened directly to the outside, even in Winter. The same cathedral-like office that couldn’t prioritise sound-proofing to prevent the conversations of the 150-people inside echoing off every conceivable surface.</p>

<p>I’ve almost forgiven it for the time that it decided to run a 5-day-long all-hands conference, where the days were rougly 15 hours long, but may as well have been 150 hours for how exhausted I felt at the end of it all.</p>

<p>Then November 2019 came around, and the person who did the exit interview at that company wasn’t my manager, or even a long-term HR employee. It was practically a stranger, someone who had started there <em>that very week</em> in HR and she conducted my exit interview. I had never met this person before this interview, and I haven’t seen her since.</p>

<p>I do not forgive the company for that.</p>

<p>What softened the blow was a sizable redundancy payout. One that helped me buy the house that I’m now sitting in. I like that I have a house that’s progressively getting to be more and more my own, brick by sandstone brick, and less and less the bank’s. But I digress.</p>

<p>It’s after this whole redundancy process that I came to realise that I cared too much about the company. I was <em>too invested</em> in its values, its success, its <em>culture</em>. I had tied too much of my own <em>value</em> to the company’s <em>value</em>.</p>

<p>It was devastating to be shown the door.</p>

<h2 id="april-2020-redundancy">April 2020 Redundancy</h2>

<p>Then I found a job with a company whose values I very strongly aligned with. A company that trained up junior-junior developers. People who were just getting started with their programming careers. I thought I could make a real difference here in educating the next generation of developers who were entering the industry.</p>

<p>Then a little thing called a pandemic hit. I’m sure you’ve heard of it by now. The parent company of the one I joined relied on international students for a large majority of its income. A pandemic in Australia meant closed borders (easy to enforce, as we’re a <em>giant island</em>), and closed borders meant no international students, which ultimately meant little-to-no money for that company.</p>

<p>I, along with the entire company, were told about potential redundancies happening in a staff-wide email on a <em>Monday</em> at the end of March. During this week we found out it was going to be 235 people across the whole company. I got that dreaded call back on <em>Friday</em> at 3pm. That was a particularly unproductive week, let me tell you. This time again it wasn’t my boss, or even a long-term colleague. It was some high-up HR woman who sounded absolutely exhausted.</p>

<p>About 5 minutes after this phone call, I was locked out of Slack, GitHub, and email. It was clinical and effective. I went into the office the next week and collected my things. That was the last time I was in an office.</p>

<p>I had become <em>too invested</em> again in the company’s success.</p>

<p>And I was cast out, without pity and this time without compensation.</p>

<h2 id="december-2020">December 2020</h2>

<p>With the pandemic hitting its stride by April 2020, I didn’t exactly put a lot of thought into where I wanted to go next. What I did put thought into was that I didn’t want to be made redundant again after being made redundant twice in quick succession, and that I didn’t want to lose my job during the pandemic.</p>

<p>I cared about this job, and poured my focus and attention into it. I wanted things to be <em>right</em> for our customers. A little too hard. I cared about things that I shouldn’t have cared about. I got upset when things that I thought were important were not considered important by others. I cared about creating a good working culture for the development team. I cared about replacing parts of our Backbone code with something from this decade. I cared too much. I got angry.</p>

<p>And I got fired.</p>

<h2 id="2021">2021</h2>

<p>So this year, I started out as a consultant which is a pleasant way of saying “an opinionated asshole for hire”. I could choose to work 3-month contracts with no strings attached. I didn’t <em>need</em> to care about the company culture, or get invested in its success. I needed to trade labor for dollars.</p>

<p>I got to work with a few different teams releasing some major features in Rails and Rails-adjacent tech, and even upgraded a Rails app or two. I was trusted for my opinion on things, but really worked hard on giving the opinion in a <em>nice way</em>. I joked to close friends that I should’ve hung bunting above my desk spelling out the word “PROFESSIONALISM” in giant letters. Sometimes I think I should still put it up.</p>

<p>Ultimately, I was successful in doing the consultant thing of trading labor for dollars. And leaving things better than I how I found them, just for my own moral satisfaction.</p>

<p>But, ultimately, it was lonely stuff. Working out of my house this year, by myself, with a 15-minute call for standup at the start of the day… just doesn’t tickle the social aspect of my brain in the right way. It often felt like I was an <em>interloper</em> into these projects, tossing grenades (or bouquets, depending on the mood) into projects and then skipping off into the sunset with my fat bags of consultant cash.</p>

<p>You ever walk into a meeting room, except it’s the wrong one? Well, if you like that feeling, become a consultant because that’s the feeling you get every damn day.</p>

<h2 id="interviewing-in-2021">Interviewing in 2021</h2>

<p>Around about the time that I figured out the “fucking hell, this is lonely work” thing I wrote <a href="https://ryanbigg.com/2021/07/job-hunt-q2-2021">this post</a>. I write <em>this</em> post today to provide some context, some colour, around why I sound so… bleak in that other post. It wasn’t just the pandemic.</p>

<p>At the time of that post in July, I interviewed at a number of companies. I got offered coding tests. <a href="https://ryanbigg.com/2021/07/on-coding-tests">I got angry about being offered coding tests</a>. And I refused to do them this time. Some people balked at that. I stood my ground, and was outright refused by some companies because I refused to do coding tests.</p>

<p>The other half of the interviews that companies love to do is the culture part of the interview.</p>

<p>A culture interview essentially boils down to “are you an asshole?” and, honestly, you could spend an hour reading about who I am and what I’ve done and get a pretty good idea about that. Or you could spend that hour talking to me and I’ll tell you the same thing. The best answer I can give you right now for that is: “you would probably rather hire 2021 Ryan than 2020 Ryan, and you’d <em>certainly</em> hire 2020 Ryan over 2015 Ryan”. Just wait for 2022 Ryan. Jeez that guy is good.</p>

<p>Things have improved. There are things that need improving that I am aware of. There are things that need improving that I’m not aware of. This is what makes us human. We’ll work on it together. I’ll try my damndest to not repeat the mistakes of the past and to prevent future ones.</p>

<p>A culture interview can sometimes have questions like “what value of ours do you most identify with?” and if you’re interviewing at several different companies and have either been made redundant or fired from the last three big companies you’ve worked for… chances are you’re going to be particularly burned out on that aspect. You’re not going to have done your homework on those values of this one particular company, and you’re going to flub that particular question. Like I did.</p>

<p>Later on, when <em>at least</em> 5 friends suggest that I would be really great for that company’s Developer Mentor role (a different one to the one I applied for) that they’ve been advertising for months… the job where you could <em>train junior developers and get paid to do it</em> and <em>holy fuck you’d be so good at it because this is your wheelhouse</em>…. it kinda smarts and I get to re-live the trauma of <em>failing an interview as a really experienced developer</em> again, and again, and again. All because I didn’t read the fucking list of values on their website, because I was seriously burned out on the whole “culture and values” thing.</p>

<p>Who doesn’t love re-living moments of such abject failure?</p>

<hr />

<p>To me, it is not important what the values written on a page of a company’s website are. It’s all the same bullshit.</p>

<p>What matters to me is what happens there every single day. The values are not what is written on a website. The values are the stuff <em>in between the people</em> every day. It’s the holding the proverbial bucket for the developer who’s just found That Piece of Legacy Code. It’s giving people time and space <em>away from the damn screen</em> when they need it, no questions asked. It’s allowing people to make mistakes, and not punishing them. It’s about making sure the people doing the work are treated like people.</p>

<p>These are the values that matter to me. It’s ironic that I write these values, on a page, on a website. But there you go.</p>

<h2 id="working-full-time-again">Working full-time, again</h2>

<p>I joined <a href="https://www.fatzebra.com/">a company</a> in August. I do a little bit more than “crush code” – I’m working on improving this company’s approach to frontend design and tooling. I’m working on building out a design system. And yes, I get to train up other people too. I spend a lot of my time convincing people that the scary frontend boogeyman is just code, like all the rest of the app. You can understand that, so you can understand this, too. Here’s some pretty buttons you can use.</p>

<p>I have learned a lot about becoming <em>too invested</em> in the culture and values of the companies I have worked for in the past. I still struggle with that to this day. That ever-burdensome question of: “am I becoming <em>too</em> attached here?”. Every day I measure how well I would react if today was the day I was told I was being let go. My mental “grab &amp; go bag” still sits, heavy in my brain. Would I be as upset as those three other times?</p>

<p>The trauma of being let go three times in 13 months left a deep, mental scar. I trusted people to make decisions, and those decisions were unfavourable.</p>

<p>At my current job, I get told that my work is deeply appreciated and I feel like my opinion is respected. And I share that opinion in at least what I think is a non-asshole way. And I trust people to tell me if or when I’m being one. I can still hold strong opinions around the right way to do things. But I’ve learned to share those opinions in a nicer way. They’ve even trusted me to interview and hire other people.</p>

<p>But occassionally, the trauma flares up and says “what if this, too, is all bullshit?”. That’s what counselling is for. I’m grateful that the Australian government subsidises these sessions, and even if they didn’t they’re worth more than their full price. I’ve talked through these feelings, and worked out some coping mechanisms. The trauma flares up less occasionally, and when it does I have things to bat it back with. Lights to push back the darkness. It’s forever present, lurking. But I’m armed now, and I am ready for it.</p>

<p>I wouldn’t say that I am anywhere near as invested in this company’s culture and values as I have been with previous companies. That isn’t to say that I am <em>uncaring</em> about the culture or values. I am simply not as attached. I still care about the happiness of the people around me. I reckon that’s what’s essential here. If things were to wrap up today, tomorrow or next week, I would probably cope better than those three other times.</p>

<p>I choose to work full-time again, to become <em>trusting</em> of a company again, to help with those <em>interloper</em> consultant feelings.</p>

<p>I guess that’s an indicator of personal growth. While trauma does happen, we can always <em>grow around</em> it. To come up against adversarial situations is a part of what makes us human. We are not alone in these situations, as much as it can feel this way sometimes.</p>

<p>I hope that sharing a little bit about my history and how I’ve worked through it helps you, either today or into the future.</p>
]]></content>
 </entry>
 

</feed>
