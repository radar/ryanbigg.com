<?xml version="1.0" encoding="iso-8859-1"?>
<feed xmlns="http://www.w3.org/2005/Atom">
 
 <title>The Life of a Radar</title>
 <link href="http://ryanbigg.com/atom.xml" rel="self"/>
 <link href="http://ryanbigg.com"/>
 <updated>2011-01-27T09:19:45+10:30</updated>
 <id>http://ryanbigg.com/</id>
 <author>
   <name>Ryan Bigg</name>
   <email>radarlistener@gmail.com</email>
 </author>

 
 <entry>
   <title>Rails 3 In Action 50 Off</title>
   <link href="http://ryanbigg.com/2011/01/rails-3-in-action-50-off"/>
   <updated>2011-01-27T00:00:00+10:30</updated>
   <id>http://ryanbigg.com/2011/01/rails-3-in-action-50-off</id>
   <content type="html"><![CDATA[<p>From now until the 23rd of February, <a href='http://manning.com/katz/'>Rails 3 in Action</a> is 50% off when you use the code <strong>rails350</strong>. This means you get the book for a discounted price of only $17.50.</p>

<p>Rails 3 in Action is a new breed of programming book; one that takes you on a journey of how you would develop an application in the real world, one step at a time. The book comes out of a collaboration between Yehuda Katz and Ryan Bigg (me1).</p>

<p>About this book</p>

<p>Rails 3 in Action begins by introducing Ruby on Rails and the basic underlying concepts. Right off the bat you&#8217;ll be developing an application and learning how Rails works. Then we take a short break from Rails, delving instead into two of the core foundations of the book: Test Driven Development (TDD) and Behaviour Driven Development (BDD). We extensively use these practices throughout the book in order to build a maintainable application, just like Rails shops worldwide operate.</p>

<p>From the get go you&#8217;re taught how to develop using tests, which really pays off in the end for any project, allowing you to write code that breaks less often.</p>

<p>Chapters 3-17 cover developing a ticket tracking application, one feature at a time. We cover things such as:</p>

<ul>
<li>RSpec &amp; Cucumber</li>

<li>The basics of a maintainable Rails application</li>

<li>RESTful routing</li>

<li>Authentication &amp; Authorization Systems</li>

<li>Sending email</li>

<li>Writing an API</li>
</ul>

<p>There&#8217;s more than that though! Check out the chapter listing to see what other exciting topics are covered.</p>

<p>Chapters 18-23 go through the more advanced sections of Rails such as how to build a Railtie (a Ruby library that ties in with Rails) and how to build mini-applications that can be plugged into other applications, called engines.</p>

<p>Rails 3 &#8211; and the evolving ecosystem around it &#8211; brings a new generation of Ruby on Rails development, whilst still staying familiar to those who&#8217;ve used previous versions. This book is a must-read for everybody who&#8217;s interested in Rails 3, from new people all the way up to experienced developers, you are guaranteed to learn something by reading this awesome book.</p>

<p>So use the <strong>rails350</strong> discount code today to get 50% off on <a href='http://manning.com/katz/'>Rails 3 in Action</a>.</p>]]></content>
 </entry>
 
 <entry>
   <title>Why Pivotal now charging for Tracker is a good thing</title>
   <link href="http://ryanbigg.com/2011/01/why-pivotal-now-charging-for-tracker-is-a-good-thing"/>
   <updated>2011-01-20T00:00:00+10:30</updated>
   <id>http://ryanbigg.com/2011/01/why-pivotal-now-charging-for-tracker-is-a-good-thing</id>
   <content type="html"><![CDATA[<p>Today, Pivotal Labs has announced that they <a href='http://pivotallabs.com/users/dan/blog/articles/1537-introducing-pivotal-tracker-pricing'>will start charging people to use (Pivotal) Tracker</a>, but only if their project is not public, for-profit or not for education. As they explain in the article, they&#8217;ve been working on Tracker now for 5 years.</p>

<p>5 years (or around 1,826 days) is immensely long time for a <em>Rails</em> project to have been around. 5 years ago, Rails was at 0.9.4, very nearly at 0.9.5. This project was before Rails was mainstream. The Pivotal Labs crew have done a tremendous job on it, constantly upgrading its features and most recently overhauling the UI to something very, very hot. For 5 years, it&#8217;s been free to use for anyone and everyone, but now they would like to start charging for it and I think this is a great idea. With the Pivotal Labs team now electing to transform Tracker to a paid service, they&#8217;ll be able to dedicate more people to work on it and maintain it, leading to a better experience overall.</p>

<p>There&#8217;s quite a lot of people who are already using the service (including myself) and love it. $50 a month for 10 collaborators is a good price point and one I&#8217;m sure any company I&#8217;d work for would be willing to pay. Pivotal Tracker has played, ahem, a pivotal role in many projects I have been on and it&#8217;s only fair that we continue to use their service and pay their toll to show our respect for 5 years of good, hard work that they&#8217;ve put into it. There&#8217;s 180,000 users (an astonishing figure for a (previously) non-commercial software), of Pivotal Tracker today, so they must be doing something right.</p>

<p>Please don&#8217;t abandon Pivotal Tracker now because they&#8217;re asking for money. How would you feel if you worked on something for that long only for the people to abandon you? You&#8217;d feel used by those people. Support Pivotal, as they have provided a kick ass project management tool (publicly) for near on two and a half years now.</p>]]></content>
 </entry>
 
 <entry>
   <title>Rails 3 in Action: SaaS</title>
   <link href="http://ryanbigg.com/2011/01/rails-3-in-action-saas"/>
   <updated>2011-01-06T00:00:00+10:30</updated>
   <id>http://ryanbigg.com/2011/01/rails-3-in-action-saas</id>
   <content type="html"><![CDATA[<p>I&#8217;ve been writing the 12th chapter for Rails 3 in Action for about a month now. It&#8217;s been a tough process because I haven&#8217;t felt sold on the idea or the &#8220;flow&#8221; of the chapter since I begun writing it. It&#8217;s a chapter about Software as a Service (SaaS), mainly covering letting users sign up for an account on a monthly subscription that has different limits depending on the plans they picked. My main thought has been &#8220;What does this have to do with Rails 3?&#8221;. Sure, there&#8217;s some elements of it such as using the <code>scope</code> method in routes to change the URLs from <code>/projects/1/tickets/2</code> to <code>/[account_name]/projects/1/tickets/2</code>, (which by the way I hear the <a href='http://api.rubyonrails.org/classes/ActionDispatch/Routing/Mapper/Scoping.html#method-i-scope'>API&#8217;s got a pretty good example of</a>) but as for introducing new features, it&#8217;s a pretty barren chapter.</p>

<p>Plus, it&#8217;s long. Simply implementing that scope breaks a whole bunch of functionality in the application and the chapter (in its current form) goes through covering how to fix that up. Most of it is the same two fixes. Not all that terribly exciting. I had planned to put the fixing-everything-up into one chapter (12) and then the actual SaaS stuff into the next chapter (13). However, tonight the fixing-everything-up chapter has gotten too long and it just feels tedious writing it.</p>

<p>That&#8217;s not what I want a chapter of Rails 3 in Action to feel like. It should be showing you features of Rails 3 that will help you along in your daily life. It should be exciting, not the same landscape for section after section after section. SaaS, to me, just doesn&#8217;t seem to fit in the book, but that isn&#8217;t to say that I&#8217;m scrapping my work entirely on this.</p>

<p>I will be taking the SaaS stuff out of Rails 3 in Action to reduce page count and I will complete it and release it as a separate guide when the book is complete. This wouldn&#8217;t be such a pain if refactoring a Rails application to have all its routes under a scope was so difficult.</p>

<p>I&#8217;m sorry to anybody who expected the final release to contain the SaaS chapter, but I think it&#8217;s best if we let that one simmer for the time whilst we cook up something more exciting, such as how to write an API.</p>

<p>Thanks for reading the book so far, I really hope you&#8217;ve enjoyed it. If you&#8217;ve got any qualms or queries, you can reach me through <a href='mailto:radarlistener@gmail.com'>email</a>, <a href='http://twitter.com/ryanbigg'>twitter</a> or GTalk at radarlistener@gmail.com.</p>

<p>I&#8217;ve put a Chapter 12 related question <a href='http://stackoverflow.com/questions/4613996/implementing-account-scoping'>on Stack Overflow</a> that somebody may know the answer to. It&#8217;s to do with the routing helpers, which was the main headache with this chapter.</p>]]></content>
 </entry>
 
 <entry>
   <title>Why you should run bundle update</title>
   <link href="http://ryanbigg.com/2011/01/why-you-should-run-bundle-update"/>
   <updated>2011-01-04T00:00:00+10:30</updated>
   <id>http://ryanbigg.com/2011/01/why-you-should-run-bundle-update</id>
   <content type="html"><![CDATA[<h3 id='prelude'>Prelude</h3>

<p><code>bundle update</code> is a command provided by the Bundler gem which will update <em>all</em> your gem dependencies to their latest versions. Providing you have a <code>Gemfile.lock</code> pre-existing, running <code>bundle install</code> will only install the versions specified in the <code>Gemfile.lock</code> and will complain that you have incompatible versions:</p>

<pre><code>Bundler could not find compatible versions for gem &quot;activesupport&quot;:
  In snapshot (Gemfile.lock):
    activesupport (3.0.0)

  In Gemfile:
    rails (= 3.0.3) depends on
      activesupport (= 3.0.3)

Running `bundle update` will rebuild your snapshot from scratch, using only
the gems in your Gemfile, which may resolve the conflict.</code></pre>

<p>This command advises you to run <code>bundle update</code> which &#8220;will rebuild your snapshot from scratch&#8221;, or in layman&#8217;s terms: throw out the <code>Gemfile.lock</code> file and start again, finding <em>newer</em> versions of gems if they are available and building a bundle for those.</p>

<p>Beneath is an example of just this happening, and an argument as to why you should run it, but carefully.</p>

<h3 id='alexs_tale'>Alex&#8217;s Tale</h3>

<p>There&#8217;s <a href='http://optimisdev.com/posts/don-t-ever-run-bundle-update'>a post by Alex from OptimisDev</a> that basically says: &#8220;Don&#8217;t even run bundle update&#8221;. That&#8217;s even the title of the post. His argument is that by running <code>bundle update</code> his I18n version changed from <code>0.4.0</code> to <code>0.5.0</code> which caused his translations to break. This is because in <code>i18n 0.5.0</code> the translation syntax has changed <em>from</em> <code>\{\{key\}\}</code> <em>to</em> <code>%{key}</code>. Why did this happen? He was using the <a href='http://rubygems.org/gems/formtastic/versions/1.2.3.beta'><code>formtastic</code> gem</a> which had specified a dependency on <code>i18n</code> of <code>&gt;= 0.4.0</code> which will install any version of i18n that is <code>0.4.0</code> or greater, a category that <code>i18n 0.5.0</code> with its breaking API changes falls into.</p>

<h3 id='a_story_on_gem_versioning'>A story on gem versioning</h3>

<p>Generally speaking, there&#8217;s three parts of a version for a gem: the major, the minor and the tiny. For example, Rails right now has a major version of 3, a minor version of 0 and a tiny version of 3, making the full version <code>3.0.3</code> currently.</p>

<p>The &#8220;rule&#8221; (or perhaps it&#8217;s more of a guideline) of gem versioning is that any subsequent releases for the <em>same</em> minor version, but a newer, higher tiny version number should fix any bugs that existed in the previous version, without breaking any functionality. Therefore you should be able to have a gem dependency like this in your <code>Gemfile</code> without any fear that it would break:</p>

<pre><code>gem &#39;rails&#39;, &#39;~&gt; 3.0.0&#39;</code></pre>

<p>The <code>~&gt;</code> part of the version indicates that we want the latest version in the series that we&#8217;ve specified. Because we&#8217;ve specified a major, minor and tiny version here, we&#8217;ll get the latest tiny release of the <code>3.0</code> series (<code>3.0.3</code> at current writing) when we run <code>bundle install</code>. In a new tiny release, there should be <em>no breaking changes</em>, only patches. Therefore, specifying versions like this is considered the safest method.</p>

<p>For minor and major releases, things can be broken and so developers should take care when running any kind of task that updates their gems to the latest version.</p>

<h3 id='when_gem_dependencies_go_bad'>When gem dependencies go bad</h3>

<p>In Alex&#8217;s case, formtastic has declared it depends on <code>i18n &gt;= 0.4.0</code> which is how <em>gem dependencies go bad</em>. In new minor or major releases of <code>i18n</code>, it&#8217;s just about guaranteed that shit will be broke, and that&#8217;s exactly what&#8217;s going to be installed when an unwitting person runs <code>bundle update</code>. As gem authors (and I&#8217;m probably guilty of this myself), we should be specifying <code>~&gt;</code> for their own gem dependencies. And we as application developers should be doing for our own gem dependencies in our <code>Gemfile</code> files. This is the way to be safe against breaking changes from a new minor or major gem version. I&#8217;m not saying that <em>every</em> new major/minor release has breaking changes, but rather to be wary when you&#8217;re upgrading.</p>

<h3 id='staying_safe'>Staying safe</h3>

<p>If we follow these simple guidelines then we can live a peaceful life of Gem Dependency Heaven instead of Gem Dependency Hell (think pre-Bundler days).</p>

<p>Whilst it&#8217;s probably not a good idea to run <code>bundle update</code> (and Alex used stronger wording with the &#8220;ever&#8221; word), it&#8217;s still useful in some contexts. Recently, David Chelimsky released a new tiny version of rspec-rails (2.4.1) which fixed a single bug. If I had <code>gem &#39;rspec-rails&#39;, &#39;~&gt; 2.4.0&#39;</code> and had <code>rspec-rails 2.4.0</code> installed but wanted to use the newest gem, I could update it by running a simple command:</p>

<pre><code>bundle update rspec-rails</code></pre>

<p>This command updates the <code>rspec-rails</code> gem and its dependencies to satisfy their latest version specifications, leaving every other gem untouched.</p>

<p>So it&#8217;s <em>almost always unsafe</em> to run <code>bundle update</code> because new versions of gems could break your application, but there is a chance everything could go off without a hitch if people (including you) have been smart in specifying proper gem dependencies. Best you stick to updating single dependencies at a time rather than the whole bundle.</p>]]></content>
 </entry>
 
 <entry>
   <title>Extending Active Record</title>
   <link href="http://ryanbigg.com/2011/01/extending-active-record"/>
   <updated>2011-01-02T00:00:00+10:30</updated>
   <id>http://ryanbigg.com/2011/01/extending-active-record</id>
   <content type="html"><![CDATA[<p>This guide was originally posted in my <a href='http://github.com/radar/guides'>guides</a> repository, but I thought I would cross-post it on the blog too to increase exposure. I hope it helps some who are trying to figure this kind of thing out.</p>

<p>If you want to see more guides like this, <a href='http://pledgie.com/campaigns/14034'>donate to me!</a>. I&#8217;m thinking of doing one on Rails engines after I finish the <a href='http://ryanbigg.com/guides/initialization.html'>initialization guide</a></p>

<p>This guide will demonstrate how we can extend Active Record&#8217;s functionality to provide a couple of new methods on our models which will allow us to find records based on a specified month or year, implementing the same functionality as found in the <a href='http://github.com/radar/by_star'>by_star</a> gem, but in a modern Rails 3 way using the features that Active Record and ARel provide.</p>

<p>This guide assumes you&#8217;ve read the &#8221;<a href='http://github.com/radar/guides/blob/master/gem-development.md'>Gem Development</a>&#8221; guide which introduces how to develop a basic gem with Bundler. We extensively use the skills learned in that guide in this guide to build this gem, including Bundler and RSpec.</p>

<p>When we&#8217;re done here, we&#8217;ll have a gem that we can add into a Rails application and then be able to call methods on the Active Record models in the application, such as these <code>by_year</code> permutations which will find records based on the year passed in:</p>

<pre><code>Invoice.by_year
Invoice.by_year(2010, :field =&gt; :sent_at)</code></pre>

<p>Lastly, we&#8217;ll add a method which we can call inside classes to set up a default for this gem:</p>

<pre><code>by_star do
  field :sent_at
end</code></pre>

<h3 id='the_beginning'>The Beginning</h3>

<p>To begin with, we&#8217;re going to generate a new gem using the <code>bundle gem</code> command:</p>

<pre><code>bundle gem by_star</code></pre>

<p>This command generates the beginning scaffold, but there&#8217;s something missing&#8230; tests! We&#8217;ll add RSpec to the <code>by_star.gemspec</code> file that was generated as a development dependency, changing our development dependencies to now contain both the <code>bundler</code> and <code>rspec</code> gems:</p>

<pre><code>s.add_development_dependency &quot;bundler&quot;, &quot;&gt;= 1.0.0&quot;
s.add_development_dependency &quot;rspec&quot;, &quot;~&gt; 2.3&quot;</code></pre>

<p>We&#8217;ll also need to add a development dependency for sqlite3-ruby as we&#8217;ll be using an SQLite3 database for our tests:</p>

<pre><code>s.add_development_dependency &quot;sqlite3-ruby&quot;</code></pre>

<p>Whilst we&#8217;re in this file we&#8217;ll add a dependency for Active Record 3, given that we&#8217;re going to be extending it:</p>

<pre><code>s.add_dependency &quot;activerecord&quot;, &quot;~&gt; 3.0&quot;</code></pre>

<p>To make sure all these gems are now installed we can run <code>bundle install</code>.</p>

<h3 id='setting_up_the_first_test'>Setting up the first test</h3>

<p>Our first test is going to implement the first version of the <code>by_year</code> method. Let&#8217;s create the file that will include this test at <code>spec/lib/by_star_spec.rb</code> now:</p>

<pre><code>require &#39;spec_helper&#39;

describe &quot;by_star&quot; do
  context &quot;by_year&quot; do
    it &quot;current year&quot; do
      Post.by_year.map(&amp;:text).should include(&quot;First post!&quot;)
    end
  end

end</code></pre>

<p>For this test to begin to run, we&#8217;ll need to create the <code>spec_helper</code> file it requires on the first line. This file will be responsible for setting up the environment and test data so that our test will run. The first thing this file needs to do is exist at <code>spec/spec_helper.rb</code> and the second thing is to set up the test data. We&#8217;re going to need a database where we can execute queries. We&#8217;ll begin this file like this:</p>

<pre><code>require &#39;by_star&#39;

ActiveRecord::Base.establish_connection(:adapter =&gt; &quot;sqlite3&quot;, 
                                       :database =&gt; File.dirname(__FILE__) + &quot;/by_star.sqlite3&quot;)</code></pre>

<p>The <code>require</code> here to the <code>by_star</code> (<code>lib/by_star.rb</code>) file should load everything that this gem needs to run, including Active Record. We&#8217;ll modify <code>lib/by_star.rb</code> to have a require to load Active Record as its first line now:</p>

<pre><code>require &#39;active_record&#39;</code></pre>

<p>With Active Record required, <code>spec/spec_helper.rb</code> will be able to use <code>ActiveRecord::Base.establish_connection</code> to create a new database located at <code>spec/by_star.sqlite3</code>. It&#8217;s in this database that we&#8217;ll set up our test data, but to do that we&#8217;re first going to need to set up the schema for the tables. Underneath the <code>establish_connection</code> line in <code>spec/spec_helper.rb</code> we&#8217;ll now put this:</p>

<pre><code>load File.dirname(__FILE__) + &#39;/support/schema.rb&#39;</code></pre>

<p>This will load the file at <code>spec/support/schema.rb</code> which should define the schema for our tables. In this file, we&#8217;ll put this:</p>

<pre><code>ActiveRecord::Schema.define do
  self.verbose = false

  create_table :posts, :force =&gt; true do |t|
    t.string :text
    t.timestamps
  end
end</code></pre>

<p>This piece of code will define the schema that we need in our database for us, using the syntax we&#8217;re familiar with from Rails migrations. Now we&#8217;ll define the data in a file also in the <code>spec/support</code> file, but this time we&#8217;ll call it <code>spec/support/data.rb</code>. We&#8217;ll keep the data separate because it&#8217;s easier to manage these two separate from one another. In this file we&#8217;ll put this:</p>

<pre><code>Post.create(:text =&gt; &quot;First post!&quot;)</code></pre>

<p>To define the model, we&#8217;ll create one more final file at <code>spec/support/models.rb</code> and define the <code>Post</code> model in this:</p>

<pre><code>class Post &lt; ActiveRecord::Base

end</code></pre>

<p>To load this file and <code>spec/support/data.rb</code> we&#8217;ll put these lines in <code>spec/spec_helper.rb</code>, right under the other <code>load</code>:</p>

<pre><code>load File.dirname(__FILE__) + &#39;/support/models.rb&#39;
load File.dirname(__FILE__) + &#39;/support/data.rb&#39;</code></pre>

<p>With the schema, models and data now all set up we should be able run our spec and have it fail because it&#8217;s missing the <code>by_year</code> method now:</p>

<pre><code>$ bundle exec rspec spec
F

Failures:

  1) by_star by_year current year
     Failure/Error: Post.by_year.map(&amp;:text).should include(&quot;First post!&quot;)
     undefined method `by_year&#39; for #&lt;Class:0x00000101febfd0&gt;
     # ./spec/lib/by_star_spec.rb:6:in `block (3 levels) in &lt;top (required)&gt;&#39;</code></pre>

<p>Ah, now it can&#8217;t find the <code>by_year</code> method, so now we get to the extending part.</p>

<h3 id='implementing_'>Implementing <code>by_year</code></h3>

<p>To add these methods to Active Record, we&#8217;ll use the <code>extend</code> method which will add methods from the module to the class, there by <em>extending</em> it. Get it? Good. At the bottom of <code>lib/by_star.rb</code> we&#8217;ll add this line:</p>

<pre><code>ActiveRecord::Base.extend ByStar</code></pre>

<p>Now we just need to define the <code>by_year</code> method inside the <code>ByStar</code> module now. This method should return all objects that are in the given year. For now, we&#8217;ll just get it to do objects in the current year. Let&#8217;s define the <code>by_year</code> method in the module now:</p>

<pre><code>module ByStar
  def by_year
    start_time = Time.now.beginning_of_year
    end_time = Time.now.end_of_year
    where(self.arel_table[:created_at].in(start_time..end_time))
  end
end</code></pre>

<p>Here we get the times at both ends of the year, the very first microsecond and the very last microsecond. Then we call <code>self.arel_table</code> which returns an <code>ARel::Table</code> object which we can then use to build our queries. We call the <code>[]</code> method and pass in <code>:created_at</code> as the key and then call the <code>in</code> method on that, passing in the beginning and the end of the year. This will construct a <code>BETWEEN</code> SQL query for us for the <code>created_at</code> column in our <code>posts</code> table:</p>

<pre><code>SELECT &quot;posts&quot;.* FROM &quot;posts&quot; WHERE (&quot;posts&quot;.&quot;created_at&quot; BETWEEN &#39;2011-01-01 00:00:00.000000&#39; AND &#39;2011-12-31 23:59:59.999999&#39;)</code></pre>

<p>That time should be precise enough for anyone! The <code>by_year</code> method will return an <code>ActiveRecord::Relation</code> object which can then be used for further scoping if the people using our gems want to do something else to it, such as limiting it to return only 5 records by calling it like this:</p>

<pre><code>Post.by_year.limit(5)</code></pre>

<p>Such is the power of Active Record 3.</p>

<p>With this method defined, let&#8217;s see if we can have one passing spec now:</p>

<pre><code>$ bundle exec rspec spec/
.

Finished in 0.00169 seconds
1 example, 0 failures</code></pre>

<p>Cool! Next, we&#8217;ll get it to work with a numbered year and a time object, and then we&#8217;ll get to passing options to this method.</p>

<h3 id='a_numbered_year'>A numbered year</h3>

<p>We need a new test that will let <code>by_year</code> now take a year. Let&#8217;s add one to the the <code>context &quot;by_year&quot;</code> in <code>spec/lib/by_star_spec.rb</code>:</p>

<pre><code>it &quot;a specified year&quot; do
  Post.by_year(Time.now.year - 1).map(&amp;:text).should include(&quot;So last year!&quot;)
end</code></pre>

<p>To test this, we&#8217;re going to need a post from last year. We&#8217;ll add one to <code>spec/support/data.rb</code> now:</p>

<pre><code>Post.create(:text =&gt; &quot;So last year!&quot;, :created_at =&gt; Time.now - 1.year)</code></pre>

<p>To get <code>by_year</code> to support this we will change the method to now take one argument which, defaults to the current year, and use it to construct a <code>Time</code> object to use in the method itself.</p>

<pre><code>def by_year(year=Time.now.year)
  start_time = Date.strptime(&quot;#{year}-01-01&quot;, &quot;%Y-%m-%d&quot;).to_time
  end_time = start_time.end_of_year
  where(self.arel_table[:created_at].in(start_time..end_time))
end</code></pre>

<p>The <code>Date.strptime</code> call here will convert the year into a <code>Date</code> object, and then we call <code>to_time</code> on it to get a <code>Time</code> object, just like the one we got from <code>Time.now</code>. Let&#8217;s see if this makes our spec run now:</p>

<pre><code>$ bundle exec rspec spec/
..

Finished in 0.00358 seconds
2 examples, 0 failures</code></pre>

<p>We&#8217;re just flying through these. The final modification we&#8217;ll make to how this method is called is get it to take options which will customise what field it does the searching on.</p>

<h3 id='methods_and_options_sitting_in_a_tree'>Methods and options, sitting in a tree</h3>

<p>We&#8217;re going to get the <code>by_year</code> method to take a set of options which will modify its behaviour. This set of options will only contain one key, but as it will be a <code>Hash</code> object, it leaves it open to taking multiple options at a later stage. Options that are not <code>:field</code> (or <code>&#39;field&#39;</code> if people feel so inclined) will do nothing. Let&#8217;s write a new spec for this now in <code>spec/lib/by_star_spec.rb</code>:</p>

<pre><code>it &quot;a specified year, with options&quot; do
  published_posts = Post.by_year(Time.now.year, :field =&gt; &quot;published_at&quot;)
  published_posts.map(&amp;:text).should include(&quot;First published post!&quot;)
  published_posts.map(&amp;:text).should_not include(&quot;First post!&quot;)
end</code></pre>

<p>Here the options are going to be <code>{ :field =&gt; &quot;published_at&quot; }</code> and this will modify the <code>by_year</code> method to look up based on this field instead. We ensure that we don&#8217;t see the &#8220;First post!&#8221; post because this doesn&#8217;t have a <code>published_at</code> field set, and shouldn&#8217;t show up in our test if the options are being interpreted as they should be. The <code>published_at</code> field doesn&#8217;t exist in our database&#8217;s schema yet, so we&#8217;ll add it to the <code>spec/support/schema.rb</code> file, changing our <code>posts</code> table definition to this:</p>

<pre><code>ActiveRecord::Schema.define do
  self.verbose = false

  create_table :posts, :force =&gt; true do |t|
    t.string :text
    t.timestamps
    t.datetime :published_at
  end
end</code></pre>

<p>When we re-run our tests, the <code>posts</code> table will be re-created with this new field. To get a record with the <code>published_at</code> attribute set to something, we&#8217;ll set one up in <code>spec/support/data.rb</code>:</p>

<pre><code>Post.create(:text =&gt; &quot;First published post!&quot;, :published_at =&gt; Time.now)</code></pre>

<p>Now to get this variety of the <code>by_year</code> method to work, we&#8217;ll convert the method to this:</p>

<pre><code>def by_year(year=Time.now.year, options={ :field =&gt; &quot;created_at&quot; })
  start_time = Date.strptime(&quot;#{year}-01-01&quot;, &quot;%Y-%m-%d&quot;).to_time
  end_time = start_time.end_of_year
  field = options[:field]
  
  where(self.arel_table[field].in(start_time..end_time))
end</code></pre>

<p>There we have the <code>options</code> defaulting to a hash with the <code>:field</code> key set to &#8220;created_at&#8221;. If we pass through another field, like we do in the test, then it will alter the field used to do the lookup. So, does this test pass? Let&#8217;s find out:</p>

<pre><code>$ bundle exec rspec spec/
...

Finished in 0.0049 seconds
3 examples, 0 failures</code></pre>

<p>There we go, passing too! One final thing: the class configuration.</p>

<h3 id='configuring_the_gem_in_the_class'>Configuring the gem in the class</h3>

<p>If we&#8217;ve got a model that doesn&#8217;t have a <code>created_at</code> field, but does have another field, then we don&#8217;t want to always be passing in the <code>:field</code> option everywhere. Instead, we want to configure this option on a per-class basis like this:</p>

<pre><code>class Event &lt; ActiveRecord::Base
  by_star do
    field :date
  end
end</code></pre>

<p>To test this implementation, we&#8217;ll define a new model called <code>Event</code> in <code>spec/support/models.rb</code> using exactly the same code as above. Then we&#8217;ll need to add the table for this to <code>spec/support/schema.rb</code>:</p>

<pre><code>create_table :events, :force =&gt; true do |t|
  t.string :name
  t.date :date
end</code></pre>

<p>And then finally, to test that this actually works, we need to add data to <code>spec/support/data.rb</code>:</p>

<pre><code>Event.create(:name =&gt; &quot;The Party&quot;, :date =&gt; Time.now)</code></pre>

<p>Oh, and yes we&#8217;ll need to add a test for this too in <code>spec/lib/by_star_spec.rb</code>:</p>

<pre><code>it &quot;pre-configured field&quot; do
  Event.by_year.map(&amp;:name).should include(&quot;The Party&quot;)
end</code></pre>

<p>Let&#8217;s run our specs now:</p>

<pre><code>$ bundle exec rspec spec
... undefined method `by_star&#39; for Event(Table doesn&#39;t exist):Class</code></pre>

<p>There&#8217;s currently no <code>by_star</code> method defined on the <code>Event</code> class&#8230; because we&#8217;re still yet to define it. This method takes a block which we&#8217;ll use to configure the gem for this model and we&#8217;ll now place it inside the <code>ByStar</code> module inside <code>lib/by_star.rb</code>:</p>

<pre><code>def by_star(&amp;block)
  @config ||= ByStar::Config.new
  @config.instance_eval(&amp;block) if block_given?
  @config
end

class Config
  def field(value=nil)
    @field = value if value
    @field
  end
end</code></pre>

<p>When the <code>by_star</code> method is called, it will get a new <code>ByStar::Config</code> object and evaluate the block it&#8217;s given within the context of that object, so that any method called inside the block is now called on the <code>ByStar::Config</code> object itself. In the <code>Config</code> class, we define a <code>field</code> method which will set <code>@field</code> to a value if one&#8217;s given and return it, or if no value is given then simply return the set value. Using this, we can reference the field as <code>by_star.field</code> in our <code>by_year</code> method. But we must take care to recognise that the passed option to the method should have precedence over the class&#8217;s default. Therefore, our <code>by_year</code> method should now look like this:</p>

<pre><code> def by_year(year=Time.now.year, options = {})
   beginning_of_year = Date.strptime(&quot;#{year}-01-01&quot;, &quot;%Y-%m-%d&quot;).beginning_of_year
   end_of_year = beginning_of_year.end_of_year
   field = options[:field] || by_star.field || &quot;created_at&quot;
   where(self.arel_table[field].in(beginning_of_year..end_of_year))
 end</code></pre>

<p>We&#8217;ve taken out the default in the <code>options</code> argument for the method, because if it defaulted to <code>created_at</code> then we wouldn&#8217;t know if that was what was passed in or if that was the default. So instead, on the second-to-last line for this method, we check if the <code>:field</code> key in <code>options</code> is set and if it isn&#8217;t then fall back to <code>by_star.field</code> and if that&#8217;s not set then finally <code>created_at</code> becomes our default once more. One more run of our specs and everything should now be peachy:</p>

<pre><code> $ bundle exec rspec spec/
 ....

 Finished in 0.01141 seconds
 4 examples, 0 failures</code></pre>

<h3 id='conclusion'>Conclusion</h3>

<p>In this guide you have learned how to extend Active Record to have a <code>by_year</code> method which finds records based on the current year, or one that was passed in. The lookup field is configurable by passing in a <code>:field</code> option to the method. Finally, we set up a way to configure the options for our method using a class method called <code>by_star</code>.</p>

<p>I hope you&#8217;ve learned something by reading this, and thanks for doing so! You can find the end-result of this gem in the <a href='https://github.com/radar/guides/tree/master/extending-active-record'>extending-active-record directory</a> on <a href='http://github.com/radar/guides'>this project</a>.</p>

<p>If you like my work, <a href='http://pledgie.com/campaigns/14034'>donate to me!</a></p>]]></content>
 </entry>
 
 <entry>
   <title>Converting from WordPress to Jekyll</title>
   <link href="http://ryanbigg.com/2010/12/converting-from-wordpress-to-jekyll"/>
   <updated>2010-12-27T00:00:00+10:30</updated>
   <id>http://ryanbigg.com/2010/12/converting-from-wordpress-to-jekyll</id>
   <content type="html"><![CDATA[<p>Yesterday I converted this blog from WordPress to Jekyll, thanks to some prompting from <a href='http://twitter.com/lenary'>Sam Elliott</a> and <a href='http://twitter.com/rohitarondekar'>Rohit Arondekar</a>. All in all, the process wasn&#8217;t actually all that painful. What triggered this whole thing was three factors:</p>

<ul>
<li>My Slicehost server crashed, possibly due to some intense load I was getting from the <a href='http://ryanbigg.com/2010/12/ubuntu-ruby-rvm-rails-and-you'>Ubuntu, Ruby, RVM, Rails and You</a> post I wrote (whilst under the influence of delicious cider).</li>

<li>When the server rebooted, I was unable to boot Apache2 back up because <em>somebody</em> (read: me) had fucked with sqlite3 to try to get his IRC bot to work on the server.</li>

<li>Slicehost charged me $38/month for a 512MB box. Linode charges about half that for the same thing. Fuck Slicehost.</li>
</ul>

<p>So off I went on a magical journey to fix these three problems.</p>

<h3 id='never_work_on_live_systems'>Never work on live systems</h3>

<p>A rule that every developer has to learn the hard way (be it from anywhere to their own system up to a website with a couple of hundred users) is that you <strong>never ever, ever, ever work on live systems because something will go terribly, terribly wrong</strong>. The second rule that every developer learns is <strong>backups, motherfucker, do you have them?</strong>. So when I had 3 years of posts that I didn&#8217;t want to lose I obeyed these two rules.</p>

<h3 id='wordpress_conversion'>Wordpress conversion</h3>

<p>First task was to take an SQL backup from the WordPress install that I had and move it over to my own system. Next, I imported this SQL into a local install of MySQL and made sure it was the latest-and-greatest. Sure, enough it was. Rohit had pointed me at the <a href='https://github.com/mojombo/jekyll/wiki/blog-migrations'>Blog migrations wiki page</a> for Jekyll and it had what appeared to be clear instructions for WordPress there.</p>

<p>So I cloned the <a href='http://github.com/mojombo/jekyll'>Jekyll</a> project into my <code>~/Sites/gems</code> folder and ran just the wordpress commands because I have tunnel vision when reading documentation (note: not my real username and password):</p>

<pre><code>$ export DB=ryanbigg
$ export USER=lolno 
$ export PASS=nopass4u 
$ ruby -r &#39;~/Sites/gems/jekyll/lib/jekyll/migrators/wordpress&#39; -e &#39;Jekyll::WordPress.process( &quot;#{ENV[&quot;DB&quot;]}&quot;, &quot;#{ENV[&quot;USER&quot;]}&quot;, &quot;#{ENV[&quot;PASS&quot;]}&quot;)&#39;</code></pre>

<p>To my surprise, it worked. I had a whole bunch of <code>_posts</code> files representing the posts in my system.</p>

<h3 id='booting_jekyll'>Booting Jekyll</h3>

<p>I installed the <code>jekyll</code> gem itself using <code>gem install jekyll</code> and then ran <code>jekyll --server</code> and it threw up a ton of &#8220;errors&#8221;, which actually turned out to be warnings about my ability to sometimes intersperse invalid HTML / Markdown with valid Markdown (or the other way around). When I went to http://localhost:4000 I got a 403 error. So I checked out other Jekyll blogs like <a href='http://github.com/qrush/litanyagainstfear'>Nick Quaranto's litanyagainstfear repository</a> to see what I was missing. I instantly came across the <a href='https://github.com/qrush/litanyagainstfear/blob/master/index.html'>index.html</a> file in this repository and &#8220;borrowed&#8221; it for my own blog, turning it into <a href='https://github.com/radar/ryanbigg.com/blob/master/index.html'>what's now here</a>. I choose to only show the last 25 posts because everything before that is ancient history. The links to them will still work, but I&#8217;m just not showing them in the archive list to conserve space.</p>

<h3 id='stylin'>Stylin&#8217;</h3>

<p>The next thing I needed to do was to create a <a href='https://github.com/radar/ryanbigg.com/blob/master/_layouts/default.html'>default.html layout</a> file in the <code>_layouts</code> folder to style this new home page of mine. I created a <code>css</code> folder at the root of the project and put in <a href='https://github.com/radar/ryanbigg.com/blob/master/css/style.css'>`style.css`</a> and got to work styling it. I wanted something a little more lightweight than the old theme and I think what I came up with was alright. This morning I added a <a href='https://github.com/radar/ryanbigg.com/blob/master/css/mobile.css'>`mobile.css`</a> which should format the blog just fine for mobile screens. It looks great on my iPhone 4.</p>

<h3 id='comments'>Comments</h3>

<p>I wanted to keep the comments from the WordPress site and Rohit recommended Disqus as a way to do that. I installed the <a href='http://wordpress.org/extend/plugins/disqus-comment-system/'>WordPress plugin</a> for it and followed the bouncing ball and had my comments exported to Disqus in no time. I needed to add the following to the <a href='https://github.com/radar/ryanbigg.com/blob/0c30ab8b5b9721b16fa125d94270d797d4eb556e/_layouts/post.html#L16-30'>post layout</a> to support the Disqus comment system. The <code>wordpress_id</code> field is the &#8220;secret sauce&#8221; here for how Disqus knows which post links up to what comments. The only caveat I&#8217;ve been informed about for Disqus is that the comments won&#8217;t be indexed by Google because they&#8217;re loaded via a JavaScript request, but I can tolerate that. Any useful information I would put in a post, probably.</p>

<h3 id='wordpress_pages'>WordPress pages</h3>

<p>To convert over the pages from WordPress that weren&#8217;t posts I&#8217;ve copied the source of them (such as the <a href='http://ryanbigg.com/about-me.html'>About me</a> page) and put them as static HTML files in the root of the project. When Jekyll compiles the site, these are copied over to the <code>_site</code> directory.</p>

<h3 id='deployment'>Deployment</h3>

<p>Currently going via the low-tech method of an SSH + <code>git pull</code> on the server, but hoping to switch to a commit hook in the future.</p>

<h3 id='benefits'>Benefits</h3>

<p>The benefits are many. My posts are now <a href='http://github.com/radar/ryanbigg.com'>open source</a> which means that if people find problems with them that can send in pull requests, but that&#8217;s just a pipe dream probably.</p>

<p>The main benefit is the speed. On the vanilla WordPress install I had I was lucky to get 2 requests per second for the home page. With Jekyll, I&#8217;m getting about 2,300 reqests per second. This is due to the fact all my posts are static assets now. I think I could double this if I <a href='http://ryanbigg.com/2009/06/how-to-make-your-rails-application-578-times-faster/'>switched to Nginx</a>, which I plan on doing when I don&#8217;t have a use for the PHP version anymore.</p>

<p>I also get to write my posts the way I like to: Markdown + HTML. No crummy little editor window, I can do it all from within TextMate.</p>

<p>I&#8217;m really liking Jekyll as lightweight alternative to WordPress and it&#8217;s great to finally be off a PHP-based system. I mean, if Ruby is so good <a href='http://en.wikipedia.org/wiki/Not_Invented_Here'>why would I be using a PHP based system?</a></p>]]></content>
 </entry>
 
 <entry>
   <title>Ubuntu, Ruby, RVM, Rails, and You</title>
   <link href="http://ryanbigg.com/2010/12/ubuntu-ruby-rvm-rails-and-you"/>
   <updated>2010-12-25T00:00:00+10:30</updated>
   <id>http://ryanbigg.com/2010/12/ubuntu-ruby-rvm-rails-and-you</id>
   <content type="html"><![CDATA[<p>
  <strong>This beginner's guide will set up with Ruby 1.9.2, RVM and Rails 3.0.3 and is specifically written for a <em>development</em> environment on Ubuntu 10.10, but will probably work on many other operating systems, including older versions of Ubuntu. YMMV.</strong>
</p><p>
<strong>If you're looking for a way to set this up on a production server then I would recommend the use of <a href='https://github.com/joshfng/railsready'>the railsready script</a> which installs all the necessary packages for Ruby 1.9.2p136 and then that version of Ruby itself, Bundler and Rails. Then it leaves it up to you to install Apache or nginx to get your application online.</strong>
</p><p>
  If you're not using Ubuntu then try <a href='https://github.com/wayneeseguin/rvm/raw/master/contrib/bootstrap_rails_environment'>Wayne E. Seguin's rails_bootstrap_script</a> which probably gets a version of Rails working for you, albeit with 1.8.7 rather than 1.9.2.
</p><h2>Under no circumstance should you install Ruby, Rubygems or any Ruby-related packages from apt-get. This system is out-dated and leads to major headaches. Avoid it for Ruby-related packages. We do Ruby, we know what's best. Trust us.</h2>
<p>Still not convinced? <a href='http://news.ycombinator.org/item?id=2039438'>Read this</a>.</p>

<p>This guide will go through installing the <a href='http://rvm.beginrescueend.com'>RVM (Ruby Version Manager)</a>, then a version of Ruby (1.9.2), then <a href='http://rubyonrails.org'>Rails</a> and finally <a href='http://gembundler.com'>Bundler</a>.</p>

<p>By the end of this guide, you will have these things installed and have some very, very easy ways to manage gem dependencies for your different applications / libraries, as well as having multiple Ruby versions installed and usable all at once.</p>

<p>We assume you have <code>sudo</code> access to your machine, and that you have an understanding of the basic concepts of Ruby, such as &#8220;What is Rubygems?&#8221; and more importantly &#8220;How do I turn this computer-thing on?&#8221;. This knowledge can be garnered by reading the first chapter of <a href='http://manning.com/black2'>any Ruby book</a>.</p>
<h3>Housekeeping</h3>
<p>First of all, we&#8217;re going to run <code>sudo apt-get update</code> so that we have the latest sources on our box so that we don&#8217;t run into any package-related issues, such as not being able to install some packages.</p>

<p>Next, we&#8217;re going to install <a href='http://git-scm.org'>Git (a version control system)</a> and <code>curl</code> which are both required to install and use RVM, and <code>build-essential</code> which is required to compile Ruby versions, amongst other compilable things. To install these three packages we use this command:</p>

<pre><code>sudo apt-get install build-essential git-core curl</code></pre>
<h3>RVM</h3>
<p>RVM is a <a href='http://rvm.beginrescueend.com'>Ruby Version Manager</a> created by Wayne E. Seguin and is extremely helpful for installing and managing many different versions of Ruby all at once. Sometimes you could be working on a project that requires an older (1.8.7) version of Ruby but also need a new version (1.9.2) for one of your newer projects. This is a problem that RVM solves beautifully.</p>

<p>Another situation could be that you want to have different sets of gems on the same version of Ruby but don&#8217;t want to have to do deal with Gem Conflict Hell. RVM has <a href='http://rvm.beginrescueend.com/gemsets/basics/'>gemsets</a> for this. <strong>This is a feature you wouldn't have if you used the packaged Ruby</strong>.</p>

<p>We&#8217;re going to use it to install only one version of Ruby, but we can <a href='http://rvm.beginrescueend.com'>consult the documentation</a> if we want to install a different version of Ruby.</p>

<p>With <code>git-core</code> and <code>curl</code> installed we&#8217;ll be able to install RVM with this command:</p>

<pre><code>bash &lt; &lt;( curl http://rvm.beginrescueend.com/releases/rvm-install-head )</code></pre>

<p>The beautiful part of this is that it installs Ruby to our home directory, providing a sandboxed environment just for us.</p>

<p>Once that&#8217;s done, we&#8217;re going to need to add a line to <code>~/.bashrc</code> file (the file responsible for setting up our bash session) which will load RVM:</p>

<pre><code>echo &#39;[[ -s &quot;$HOME/.rvm/scripts/rvm&quot; ]] &amp;&amp; source &quot;$HOME/.rvm/scripts/rvm&quot;&#39; &gt;&gt; ~/.bashrc </code></pre>

<p>Then we&#8217;ll need to reload the <code>~/.bashrc</code> file which we can do with this small command:</p>

<pre><code>. ~/.bashrc</code></pre>

<p>The next command we run will tell us what other packages we need to install for Ruby to work:</p>

<pre><code>rvm notes
...
# For Ruby (MRI &amp; ree)  you should install the following OS dependencies:
ruby: aptitude install build-essential bison openssl libreadline6 libreadline6-dev
curl git-core zlib1g zlib1g-dev libssl-dev libyaml-dev libsqlite3-0
libsqlite3-dev sqlite3 libxml2-dev libxslt-dev autoconf</code></pre>

<p>A couple of these packages we&#8217;ve already installed, such as <code>git-core</code> and <code>curl</code>. They won&#8217;t be re-installed again.</p>

<p>These packages will lessen the pain when we&#8217;re working with Ruby. For example, the <code>libssl-dev</code> package will make OpenSSL support in Ruby work, <code>libsqlite3-0</code> and <code>libsqlite3-dev</code> are required for the <code>sqlite3-ruby</code> gem and the <code>libxml2-dev</code> and <code>libxslt-dev</code> packages are required for the <code>nokogiri</code> gem. Let&#8217;s install all these packages now using this command:</p>

<pre><code>sudo aptitude install build-essential bison openssl libreadline6 libreadline6-dev curl git-core zlib1g
zlib1g-dev libssl-dev libyaml-dev libsqlite3-0 libsqlite3-dev sqlite3 libxml2-dev libxslt-dev autoconf</code></pre>
<strong>This command *must* be written on a single line, otherwise some of the packages will not install.</strong>
<p>Now our Ruby lives will be as painless as possible.</p>
<h3>Ruby</h3>
<p>With RVM and these packages we can install Ruby 1.9.2:</p>

<pre><code>rvm install 1.9.2</code></pre>

<p>This command will take a couple of minutes, so grab your $DRINKOFCHOICE and go outside or something. Once it&#8217;s done, we&#8217;ll have Ruby 1.9.2 installed. To begin using it we can use this lovely command:</p>

<pre><code>rvm use 1.9.2</code></pre>

<p>Are we using 1.9.2? You betcha:</p>

<pre><code>ruby -v
ruby 1.9.2p136 (2010-12-25 revision 30365) [x86_64-linux]</code></pre>

<p>Or, even better, would be to make this the <em>default</em> for our user! Oooh, yes!</p>

<pre><code>rvm --default use 1.9.2</code></pre>

<p>Now whenever we open a new bash session for this user we&#8217;ll have Ruby available for us to use! Yay!</p>
<h3>Rails</h3>
<p>Now that RVM and a version of Ruby is installed, we can install Rails. Because RVM is installed to our home directory, we don&#8217;t need to use that nasty <code>sudo</code> to install things; we&#8217;ve got write-access! To install the Rails gem we&#8217;ll run this command:</p>

<pre><code>gem install rails</code></pre>

<p>This will install the <code>rails</code> gem and the other 22 gems that it and its dependencies depend on, including Bundler.</p>
<h3>MySQL</h3>
<p>If you&#8217;re planning on using the <code>mysql2</code> gem for your application then you&#8217;ll want to install the <code>libmysqlclient16-dev</code> package before you do that. Without it, you&#8217;ll get an error when the gem tries to compile its native extensions:</p>

<pre><code>Building native extensions.  This could take a while...
ERROR:  Error installing mysql2:
	ERROR: Failed to build gem native extension.

/home/ryan/.rvm/rubies/ruby-1.9.2-p136/bin/ruby extconf.rb
checking for rb_thread_blocking_region()... yes
checking for mysql_query() in -lmysqlclient... no
checking for main() in -lm... yes
checking for mysql_query() in -lmysqlclient... no
checking for main() in -lz... yes
checking for mysql_query() in -lmysqlclient... no
checking for main() in -lsocket... no
checking for mysql_query() in -lmysqlclient... no
checking for main() in -lnsl... yes
checking for mysql_query() in -lmysqlclient... no
checking for main() in -lmygcc... no
checking for mysql_query() in -lmysqlclient... no
*** extconf.rb failed ***
Could not create Makefile due to some reason, probably lack of
necessary libraries and/or headers.  Check the mkmf.log file for more
details.  You may need configuration options.</code></pre>
<h3>PostgreSQL</h3>
<p>Similar to the <code>mysql2</code> gem&#8217;s error above, you&#8217;ll also get an error with the <code>pg</code> gem if you don&#8217;t have the <code>libpq-dev</code> package installed you&#8217;ll get this error:</p>

<pre><code>    Building native extensions.  This could take a while...
ERROR:  Error installing pg:
	ERROR: Failed to build gem native extension.

/home/ryan/.rvm/rubies/ruby-1.9.2-p136/bin/ruby extconf.rb
checking for pg_config... no
checking for libpq-fe.h... no
Can&#39;t find the &#39;libpq-fe.h header
*** extconf.rb failed ***
Could not create Makefile due to some reason, probably lack of
necessary libraries and/or headers.  Check the mkmf.log file for more
details.  You may need configuration options.</code></pre>
<h3>Fin.</h3>
<p>And that&#8217;s it! Now you&#8217;ve got a Ruby environment you can use to write your (first?) Rails application in with such minimal effort. A good read after this would be the <a href='http://guides.rubyonrails.org'>official guides for Ruby on Rails</a>. Or perhaps the documentation on the <a href='http://rvm.beginrescueend.com'>RVM site</a> which goes into using things such as <a href='http://rvm.beginrescueend.com/gemsets/basics/'>gemsets</a> and the exceptionally helpful <a href='http://rvm.beginrescueend.com/workflow/rvmrc/#project'>per-project .rvmrc file</a>. A quick way to generate an <code>.rvmrc</code> file is to run a command like this inside the project</p>

<pre><code>rvm use 1.9.2@rails3 --rvmrc</code></pre>

<p>RVM is such a powerful tool and comes in handy for day-to-day Ruby development. Use it, and not the packages from apt to live a life of development luxury.</p>
<h4>Credits</h4>
<p>Thanks to <a href='http://twitter.com/krainboltgreene'>krainboltgreene</a> for pointing out that the guide needed to install the packages specified by rvm notes. He&#8217;s got a similar <a href='http://krainboltgreene.github.com/l/3'>write up here for Ubuntu 10.04</a>. Some of the instructions in this guide were &#8220;inspired&#8221; by that post.</p>]]></content>
 </entry>
 
 <entry>
   <title>Rails routing and automatic assumptions</title>
   <link href="http://ryanbigg.com/2010/12/rails-routing-and-automatic-assumptions"/>
   <updated>2010-12-19T00:00:00+10:30</updated>
   <id>http://ryanbigg.com/2010/12/rails-routing-and-automatic-assumptions</id>
   <content type="html"><![CDATA[<p>Last night while working on chapter 12 for <a href='http://manning.com/katz'>Rails 3 in Action</a> I stumbled across an interesting problem detailed in <a href='https://gist.github.com/746414'>this gist</a>. The problem I was seeing is that the <code>edit_admin_user_path</code> route <em>was not</em> failing, while the <code>admin_user_permissions_path</code> path <em>was</em> failing.</p>

<p>I had my suspicions to why the first link worked and spent the remainder of last night digging through my favourite bit of Rails and Rails related source(ry): Action Dispatch and rack-mount. I didn&#8217;t figure it all completely out until after a good night&#8217;s sleep. It wasn&#8217;t until I saw pixeltrix&#8217;s comment on the Gist this morning that it all clicked.</p>

<p>I knew from a while ago that sometimes Rails will just <em>know</em> what to put as the <code>:id</code> part of a route and I never did bother questioning how that part of Rails works until last night. It turns out that Action Dispatch (and by extension, rack-mount) are very intelligent in the way that they build routes. Take the <code>edit_admin_user_path</code> route for example. This requires two parameters: <code>:account_id</code> and <code>:id</code>, representing an account and user object respectively. The routing code doesn&#8217;t <em>care</em> what arguments are passed in here, only the order of them. All it does is call <code>to_param</code> on the objects to extract the segments for the routes. So when you do this:</p>
<pre>
   edit_admin_user_path(@user)
</pre>
<p>But the order of the parameters in the URL are <code>:account_id</code> and then <code>:id</code>, Rails will assume that the first object is meant for the <code>:account_id</code> parameter. How does it work out the <code>:id</code> parameter then? It&#8217;s not passed into the helper, so instead it&#8217;s gathered from the current request&#8217;s parameters. Therefore, this helper generates a URL such as <code>/2/users/2/edit</code> inadvertently. We can change this to be simply:</p>
<pre>
   edit_admin_user_path
</pre>
<p>Then Rails will assume that we want the current <code>:account_id</code> and <code>:id</code> from the current request, making our code much shorter, compared to what we&#8217;d have to do if this feature didn&#8217;t exist:</p>
<pre>
  edit_admin_user_path(@account, @user)
</pre>
<p>The <code>admin_user_permissions_path(@user)</code> helper throws an error because it expects to receive both a <code>:account_id</code> and <code>:user_id</code> parameter. Without the <code>:user_id</code> parameter available or passed in to the helper, rack-mount won&#8217;t know how to generate this URL and will raise a &#8220;No route matches&#8221; error.</p>

<p>Oh, and I also <a href='http://twitter.com/ryanbigg/status/16104049640210432'>offered a free copy of Rails 3 in Action</a> to the person who helped me solve this issue, but it was really a team effort. alindeman, pixeltrix and pacsoe all get free, signed dead-tree copies when the book&#8217;s done. Thanks lads.</p>]]></content>
 </entry>
 
 <entry>
   <title>Asking Questions The Right Way</title>
   <link href="http://ryanbigg.com/2010/12/asking-questions-the-right-way"/>
   <updated>2010-12-16T00:00:00+10:30</updated>
   <id>http://ryanbigg.com/2010/12/asking-questions-the-right-way</id>
   <content type="html"><![CDATA[<p>I spend a lot of time on <a href='http://stackoverflow.com/users/15245/ryan-bigg'>Stack Overflow</a> answering Ruby and Rails questions, but also venturing into other areas such as git or html and so on. I&#8217;ve answered over 400 questions on there and recently broke 8,000 reputation points. As of this posting, I&#8217;ve been there 32 days in a row.</p>

<p>It&#8217;s safe to say I&#8217;m a tad addicted.</p>

<p>I really enjoy answering <a href='http://stackoverflow.com/questions/4433823/testing-reject-if-in-anaf'>interesting questions</a> asked by the huge number of people who use the site, possibly mainly because I get a &#8220;reward&#8221; for it most of the time in that my reputation &#8220;score&#8221; increases when someone presses the upvote arrow or the accept checkmark. Or possibly also because I learn stuff like that model classes in Rails 3 have a <code>nested_attribute_options</code> method on them which allows access to the configuration for all <code>accepts_nested_attribute_for</code> in that model. Or possibly both.</p>

<p>What I don&#8217;t enjoy though is decrypting <a href='http://stackoverflow.com/questions/4456254/why-dont-i-get-a-method-error'>weird questions</a>. These questions usually follow the same MO. The user begins by declaring something vague like &#8220;my code isn&#8217;t working&#8221; and then follows it up with a &#8220;plz can any1 help?&#8221; or something similar. Sure, they&#8217;re probably new to the language. So it&#8217;s up to show them the proper way to ask a question for Ruby.</p>
<h3>Step 0: Smart questions</h3>
<p>Read of <a href='http://www.catb.org/~esr/faqs/smart-questions.html'>"How to Ask Questions The Smart Way" by Eric Steven Raymond</a>. It pretty much covers every single possible permutation of asking a question. Follow this guide, and you cannot do any wrong.</p>
<h3>Step 1: Show us the code</h3>
<p>Generally when I help somebody solve the issue it&#8217;s good to get some background on how they got to that particular problem. For me, the best kind of background is some actual code. In most cases the problem is right there and obvious right away and just by looking at it anybody who knows the language should be able to help you solve it.</p>

<p>If it&#8217;s an IRC channel, a user can paste a single line of code into an IRC channel, but generally the preferred method is either a <a href='http://gist.github.com'>Gist</a> or a <a href='http://pastie.org'>Pastie</a> (when it&#8217;s up). Be sure to mention that you&#8217;re going to need the HTTP URL from those services, not the Git URL. Also, don&#8217;t encourage use of <a href='http://pastebin.org'>Pastebin</a>, because it&#8217;s got ugly syntax highlighting and there&#8217;s a pretty strong rumour going around that it may be Demonspawn.</p>
<h3>Step 2: Show us the stacktrace</h3>
<p>If the code doesn&#8217;t show the breakage clearly, then the next port of call is the stacktrace associated with the error. Again, <a href='http://gist.github.com'>Gist</a> or <a href='http://pastie.org'>Pastie</a> are perfect for these. Take <a href='https://gist.github.com/3a45806f5391505530a5'>this gist</a> for example. If the user shows just the first line of the error then we&#8217;d have no context to go on. The stacktrace provides that context and from that we can determine they&#8217;re using a deprecated-in-Rails-3 method and that they should probably delete that file.</p>
<h3>Step 3: Explain what is being attempted</h3>
<p>If all else fails, then perhaps there&#8217;s a bigger issue at hand. Perhaps the code can be designed in a better fashion. By talking over the issue with other people they may have unique views on how to do it in a better fashion. Talking through a tough problem with other people who have been there before is really the best way to work out what the right way to do it is.</p>

<p>With the <code>MethodError</code> StackOverflow question it would be helpful for a person wanting to help to know why that person wants a <code>MethodError</code> exception rather than a <code>NoMethodError</code> exception. What&#8217;s the end goal?</p>

<p>By seeing these three simple things, we as helpers are more enabled to help those who are asking for our help.</p>]]></content>
 </entry>
 
 <entry>
   <title>The Writing Process</title>
   <link href="http://ryanbigg.com/2010/12/the-writing-process"/>
   <updated>2010-12-11T00:00:00+10:30</updated>
   <id>http://ryanbigg.com/2010/12/the-writing-process</id>
   <content type="html"><![CDATA[<p>It&#8217;s been a while since I&#8217;ve videoblogged about the progress on Rails 3 in Action and I&#8217;m in that kind of mood tonight, but can&#8217;t be bothered turning on the light and setting up for that, so instead you&#8217;ll get it in text version.</p>

<p>This week on Tuesday, I caught up with Mark Ryall for lunch and he asked what the writing process was like. I explained it to him and that&#8217;s definitely not the first time I&#8217;ve explained it to somebody, but nevertheless still tried to make it sound interesting. There&#8217;s a couple of key points I&#8217;d like to use this post to go into greater detail about.</p>
<h3>There are no montages</h3>
<p>Ever seen Rocky I? It has a great training montage where through some clever cutting we see Rocky train for the big fight. He&#8217;s running through fields, drinking raw eggs, and finally climbing a huge flight of stairs and then &#8220;dancing&#8221; because he was victorious.</p>

<p>In the real world, there are no montages. I wake up in the morning and I think about how much I&#8217;d like to get done in a day. Sometimes I do that, sometimes I exceed expectation and sometimes I fail. But the main point is that I&#8217;m at least giving it a go, every single day. If I&#8217;m not writing, then I&#8217;m at least thinking about what I would write about, how the pieces all fit together. Perseverance is definitely a non-optional thing when it comes to writing a book. I focus on planning out a section and then writing it. Sometimes during the writing of it, I discover some oversight in a previous paragraph and jump back to fix it. If I don&#8217;t fix it, then I&#8217;ve got my awesome review team which will point out mistakes, which takes me on to my second point.</p>
<h3>Get a posse</h3>
<p>The review team so far have filed 870 notes for the book. Now, whilst this may seem like a lot, there&#8217;s a whole wall-o&#8217;-text there, some 130,000+ words so far. Many of these notes where stuff like places where I use &#8220;ran&#8221; rather than &#8220;run&#8221; or where sentences would have better wording. Then there were notes as well saying that the reviewer got lost in the text or that a code example is missing a character or overflows. Without these reviewers, I would not have been able to solve these notes as quickly as I have been, and I hope that they&#8217;ll stick with me until it&#8217;s over.</p>

<p>How do these reviewers file the notes? That&#8217;s the third point.</p>
<h3>The tools for writing a programming book, suck</h3>
<p>Surely, somebody has solved this issue. Unfortunately for myself, that somebody isn&#8217;t my publisher. I&#8217;m hand-writing the book in XML which goes a little like this:</p>
<pre>
&lt;informalexample id="ch12_152"&gt;
  &lt;programlisting id="ch12_153"&gt;
    &lt;![CDATA[create_table :accounts_users, :id =&gt; false do |t|
      t.string :account_id
      t.string :user_id
      t.boolean :admin, :default =&gt; false
    end
    
    remove_column :users, :admin
    ]]&gt;
  &lt;/programlisting&gt;
&lt;/informalexample&gt;
</pre>
<p>I&#8217;ve got TextMate macros for that so I just type <code>in[tab]</code> for it to generate the <code>informalexample</code> and nested <code>programlisting</code> tags, with the <code>id</code> attributes filled in at a later time by <a href='https://gist.github.com/737322'>a script I've written myself</a>. That in itself was an interesting problem to solve. Each and every single element in the document needs a unique ID, but you can&#8217;t just go ahead and number every single element in order: you have to be considerate of the fact that some elements may already have ids. If that&#8217;s the case, then you find the &#8220;biggest&#8221; id and just add +1 to that for every single new element.</p>

<p>Why do these elements need IDs? Because of how Manning&#8217;s review tool works. My editor and I both have access to a tool that we can log into and leave notes for the book. These notes relate to an element based on that element&#8217;s ID so even if the <em>content</em> of the element changes after the note has been left, we still know what element that refers to. The IDs for that particular system are something like <code>_432_4125_3843</code>, where the first number is the book id, the second number the chapter id and the third number the element number for that chapter. I prefer my naming schema, to be perfectly honest.</p>

<p>There&#8217;s a small problem with the tool my editor and I use: only we have access to it. For very good reason too. Anybody who has access to it gets to see every single other book written by Manning, which is probably not the best for security reasons there. Also, this tool requires me to use SVN (wherein a part of me dies every time that happens), as well as <a href='https://skitch.com/ryanbigg/rrxji/a'>an interface that is from many, many years ago.</a> To update a chapter, I must go into this interface and click on every chapter, scroll to the very bottom of the page, press the &#8220;Latest&#8221; radio button and press &#8220;Update&#8221;. Then once the request is done, I get no clear notification if something has gone wrong. It&#8217;s all very luck-based.</p>

<p>One Saturday, I got tired of doing this. I knew I could code something far, far greater. Hell, I was/am writing a book on Rails 3, why not build another Rails application to help in that process? That&#8217;s how Twist was born. On a single Saturday (ok, and some minor upkeep during some down time).</p>
<h3>Twist</h3>
<p>Twist is a Rails 3.0.3 application which currently has about 40 users. Each of these users can log into the system and leave notes for any element in any chapter and also see notes left by other users. Collaborative editing is the future, man. I can log into the system and see exactly what every other user sees, except I have one extra ability: I can close notes. Ideally I would like to have three stages for notes: Open, Complete and Closed so that people can check to see if the note is to their satisfaction, but I haven&#8217;t seen any large use for that yet. It&#8217;s just a nice-to-have.</p>

<p>So how does Twist get the book then? That Saturday was fever-pitch coding. I host the book on GitHub (quite probably my favourite online service that&#8217;s not a bank), and GitHub has Post-Receive Hooks which trigger when the repository is pushed to. With these, I can send a payload of a commit to any URL I desire. This payload contains information such as what files were added, modified or removed during the commits that have happened for that push. So that&#8217;s what Twist uses. It parses the payload, downloads the XML for the chapters and parses it all and stores it in a database structure that, simply put, goes like this:</p>
<pre>
  Book -&lt; Chapters -&lt; Revisions -&lt; Sections -&lt; Elements &gt;- Notes &gt;- Users
</pre>
<p>Every time I push a change to GitHub, it&#8217;s instantly available for the reviewers to see. No SVN or shitty interface bullshit. When reviewers visit a section it&#8217;s rendered right from the database. If it had a lot of traffic, sure, I&#8217;d cache it. It just doesn&#8217;t need it right now. One of my favourite features which I added recently was the ability to close notes through commit messages using a message such as &#8220;Fixed messed-up code sample - Finishes #711&#8221;, ala GitHub Issues. Oh, and <a href='https://skitch.com/ryanbigg/rrxkb/twist.ryanbigg.com-1.2.4'>it looks like this</a>. Hat-tip to Ben Hoskings for the protips on things like the line and paragraph spacing.</p>

<p>There&#8217;s one thing I haven&#8217;t been able to solve yet: testing the code samples.</p>
<h3>How do you know it works?</h3>
<p>One thing that bugs me with this writing process is that I have no solid clue if the code I&#8217;m writing actually works. A lo-fi way I&#8217;ve worked out of solving this is to write the code for the application as I&#8217;m writing the book. Make it work in the application and then it&#8217;s a matter of simply copying over the code from the application into the book. My main problem with that is that code and output can both change. I don&#8217;t know how yet to test this cleanly &#8211; and I&#8217;m pretty sure Manning&#8217;s XML format would prevent me from even trying &#8211; but I know it&#8217;s possible.</p>
<h3>Fin</h3>
<p>Anyway, long post is long and probably not that interesting to a normal reader. Still, it&#8217;s fascinating for me. The whole process gives me this fuzzy, warm feeling. Made some good progress on Chapter 12 today, and I think I&#8217;m going to go push that to GitHub (and by extension, Twist) right now. Bye!</p>]]></content>
 </entry>
 
 <entry>
   <title>Commit it, or else!</title>
   <link href="http://ryanbigg.com/2010/12/commit-it-or-else"/>
   <updated>2010-12-09T00:00:00+10:30</updated>
   <id>http://ryanbigg.com/2010/12/commit-it-or-else</id>
   <content type="html"><![CDATA[<p>I&#8217;ve seen the same question pop up a couple of times now:</p>
<blockquote>
  Should I commit the Gemfile.lock file that Bundler generates?
</blockquote>
<p>Yes. Do it. Do it now if you haven&#8217;t already.</p>

<p>Another common question is:</p>
<blockquote>
  I always get conflicts in my db/schema.rb file, why should I commit that?
</blockquote>
<p>This post answers both.</p>
<h3>"Why should I commit Gemfile.lock?"</h3>
<p>When you run <code>bundle install</code> in your project, Bundler will download and install all the gems and their dependencies and their dependencies&#8217; dependencies (and so on) and then create a <code>Gemfile.lock</code> file based on what it installed.</p>

<p>This file is incredibly important because it lists all the precise versions of everything that your project uses at that point in time. Of course, it&#8217;s up to you to ensure that the project is actually working at this point&#8230; something that you should be doing before you commit the <code>Gemfile</code> <strong>and</strong> the <code>Gemfile.lock</code> files. Whenever somebody else clones this project (say, in a couple of days after your setup) and runs <code>bundle install</code>, they will get the <strong>exact same</strong> versions of the gems. Without <code>Gemfile.lock</code>, dependencies will be re-resolved and versions could have been updated during that time. This can lead to undesired outcomes.</p>

<p>Commit it, or else.</p>
<h3>"Why should I commit schema.rb?</h3>
<p>The <code>db/schema.rb</code> file in Rails plays a very similar role to that of the <code>Gemfile.lock</code>. Its purpose is to provide the schema for the database at the absolute latest point. This allows everybody who&#8217;s working on the project &#8211; regardless of what time they enter the project &#8211; to run <code>rake db:schema:load</code> to get the absolute latest schema.</p>

<p>Now note here that I <strong>don&#8217;t</strong> recommend running <code>rake db:migrate</code> to get the latest database schema. There&#8217;s a couple of reasons why people may think this is a good idea, but let me tell you right now: it isn&#8217;t. If you&#8217;re getting started on a project, use <code>rake db:schema:load</code> to get set up (after, of course, setting up the database).</p>

<p><code>rake db:migrate</code> will run <em>every single damn migration</em> in your project, creating tables in one &#8220;step&#8221; and then destroying them in a future step. This is an utter waste of time. <code>db/schema.rb</code> has the final outcome of it already there for you.</p>

<p>Also, if you&#8217;re using <code>rake db:migrate</code> to insert data into your database: don&#8217;t. Use <code>db/seeds.rb</code> for that.</p>

<p>On a similar train of thought: if you&#8217;re using migrations to execute queries that you can&#8217;t do using Rails helpers, perhaps that&#8217;s not such a good idea either. Think about it: the only way you&#8217;re going to be able to run those again on another machine is by running all the migrations again, which we&#8217;ve just established is a Terrible Idea. What may be less of a Terrible Idea is to have an alternative Rake task such as a <code>db:setup</code> script which runs <code>db:schema:load</code> and then executes those specific queries. Yes, it&#8217;s more files to maintain, but this would stop you from having to run <strong>all</strong> the migrations to get those specific queries to re-run. Migrations shouldn&#8217;t be used to do this kind of low-level activity; it just simply doesn&#8217;t fit.</p>

<p>As for the conflicts in <code>db/schema.rb</code>? You&#8217;re a programmer for crying out loud. Suck it up and deal with it. Or <a href='http://tbaggery.com/2010/10/24/reduce-your-rails-schema-conflicts.html'>code up a solution</a>, at least.</p>]]></content>
 </entry>
 
 <entry>
   <title>Paths vs Subdomains</title>
   <link href="http://ryanbigg.com/2010/11/paths-vs-subdomains"/>
   <updated>2010-11-28T00:00:00+10:30</updated>
   <id>http://ryanbigg.com/2010/11/paths-vs-subdomains</id>
   <content type="html"><![CDATA[<p>Earlier today I put out <a href='http://twitter.com/ryanbigg/status/8747010869956608'>a tweet</a> which asked:</p>
<blockquote>
site.com/account (Github) or account.site.com (Basecamp) style for per-account URLs?
</blockquote>
<p>There were great arguments from both sides in the debate. Tweets like <a href='http://twitter.com/Sutto/status/8799294744170496'>Darcy Laycock's</a> and <a href='http://twitter.com/jms_/status/8770149087707137'>James Ottaway's</a>.</p>

<p>I&#8217;ve decided to make it paths for two reasons.</p>
<h3>Easier to test</h3>
<p>Quite simply, paths (http://ticketee.com/account) are much easier to test by booting up <code>rails server</code> than subdomains are. They require no additional configuration by that means and they&#8217;re guaranteed to work on all systems.</p>

<p>Subdomains on the other hand would require use of another tool such as <a href='http://github.com/bjeanes/ghost'>Ghost</a> which would work on Ubuntu and Mac OS X, but not Windows. There is no One True Solution for everybody when it comes to subdomains. Since Rails 3 in Action is intentionally written without discrimination between operating systems, I would prefer this chapter to be no exception to that rule.</p>
<h3>Account sharing</h3>
<p>In the application I am going to be sharing users across accounts. A user that is created on one account, can be gifted access to an alternative account. This would result in an &#8220;open&#8221; system, and I think a path URL would be better for this than a subdomain URL.</p>

<p>Thank you all for your suggestions and the interesting discussions tonight. You&#8217;ve been amazing.</p>]]></content>
 </entry>
 
 <entry>
   <title>Dollars to Documentation</title>
   <link href="http://ryanbigg.com/2010/11/dollars-to-documentation"/>
   <updated>2010-11-25T00:00:00+10:30</updated>
   <id>http://ryanbigg.com/2010/11/dollars-to-documentation</id>
   <content type="html"><![CDATA[<p>Last week I wrote a post called <a href='http://ryanbigg.com/2010/11/looking-for-sponsors/'>"Looking for Sponsors"</a> where I asked if anyone would be interested in donating to a project where I worked full-time on doing documentation for Rails.</p>

<p>After receiving a great response from it, I&#8217;m <a href='http://pledgie.com/campaigns/14034'>now officially taking donations</a> and <a href='http://docrails.uservoice.com/forums/88055-general'>suggestions on what to document</a>. After all, I want this to be a community-driven event.</p>

<p>I would like to start Monday.</p>

<p>As I say on the Pledgie, I&#8217;ve got some ideas already like finishing the <a href='http://guides.rubyonrails.org/initialization.html'>Initialization Internals Guide</a>, but really I&#8217;m leaving this in the hands of the very capable community.</p>

<p>So how about it? <a href='http://pledgie.com/campaigns/14034'>Give me a couple of dollars</a>, and I&#8217;ll give you some great documentation. Deal?</p>]]></content>
 </entry>
 
 <entry>
   <title>Looking for Sponsors</title>
   <link href="http://ryanbigg.com/2010/11/looking-for-sponsors"/>
   <updated>2010-11-19T00:00:00+10:30</updated>
   <id>http://ryanbigg.com/2010/11/looking-for-sponsors</id>
   <content type="html"><![CDATA[<p>Back in September I wrote a post called <a href='http://ryanbigg.com/2010/09/advanced-rails-documentation/'>"Advanced Rails Documentation"</a>, which talked about there being a dearth of advanced Ruby on Rails documentation about the place.</p>

<p>Since then, I&#8217;ve been talking with <strong>a lot</strong> of people in the Ruby world and that&#8217;s changed my opinion of what&#8217;s truly needed. It&#8217;s not so much the <em>advanced</em> documentation that&#8217;s needed, but more on the intermediate parts of Rails such as using application templates / builders, or even an Engines guide for when 3.1 drops. Piotr Sarnacki has been doing some seriously awesome work on those.</p>

<p>Another example, Railscamp was this weekend just gone. It was <strong> bloody great</strong>. During my time spent coding at it, I worked on investigating and documenting the <code>ActionDispatch::Routing::Mapper</code> class, in particular, most of the options for the methods such as <code>namespace</code> and <code>resources</code>. If you see anything wrong with the documentation of these methods, I&#8217;m probably your man to ask.</p>

<p>This is the kind of work that I&#8217;d be doing if I received sponsorship prior to January: working on guides and general documentation for Rails and its ecosystem. If you want examples of my work, you need not look any further than the blogs I&#8217;ve written here, as well as <a href='http://manning.com/katz'>Rails 3 in Action</a>, which is more a beginner-focussed text.</p>

<p>There was a <a href='http://pledgie.com/campaigns/34'>drive just like this back in 2006</a> and that was a resounding success. But back then, Rails was at 1.1.6! Rails has come quite a long way since then, and I think it&#8217;s time that we had some quality, community-sponsored documentation going on. I want to help the community, and I think this is the best way I can be of most use.</p>

<p>The intention of this post is to purely gauge the interest in a project like this. I&#8217;ll write another post during December with a link to a Pledgie (or similar). I&#8217;m more than happy to do it, but a man&#8217;s gotta eat. So my final question is: <strong>would you donate to a project like this, and how much (or what) would you donate?</strong></p>]]></content>
 </entry>
 
 <entry>
   <title>The Rails 3 Upgrade</title>
   <link href="http://ryanbigg.com/2010/11/the-rails-3-upgrade"/>
   <updated>2010-11-07T00:00:00+10:30</updated>
   <id>http://ryanbigg.com/2010/11/the-rails-3-upgrade</id>
   <content type="html"><![CDATA[<p>During the interim between GetUp and my-next-big-job I&#8217;ve spent the week at a place in Brisbane called <a href='http://ennova.com.au'>Ennova</a> hanging out with such talented people as <a href='http://twitter.com/ltw_'>Lucas Willett</a> and <a href='http://twitter.com/jasoncodes'>Jason Weathered</a>. During my brief stint I was <s>roped into</s> asked to help out with a Rails 3 upgrade. Here&#8217;s a semi-detailed list of what we did in order to upgrade the existing Rails 2.3.8 application to Rails 3.0.1.</p>
<h3>The Rails 3 Upgrade Handbook</h3><a href='http://railsupgradehandbook.com'>The Rails 3 Upgrade Handbook</a>
<p>I warn you now: this is a huge post (around 4,000 words). I think it contains a lot of good information that could probably help you or someone you know upgrade their application to Rails 3. It was 5 days effort upgrading this application to Rails 3 for two people, but a large majority of that time was spent fixing up the tests for the application as some were not that well-written. Most of the code is good code, though, and that&#8217;s really helpful when you&#8217;re doing something like this. In this post there&#8217;s only going to be mentions of things that are different for this particular application between Rails 2 and Rails 3 and the workflow we went through on each day during this effort.</p>

<p>Our plan of attack was to get at least <code>rails console</code> booting first, then make <code>rails console production</code> boot. Next, the application has both RSpec and test/unit tests as well as Cucumber features, so we chose to get the RSpec tests passing first, then the test/unit tests. If all of these tests passed then most of the Cucumber feature should fall in to place, as they did. The following task would be getting the Cucumber tests passing. During this whole process every time we came across a deprecation warning we would try to fix it.</p>
<h3>Bundler</h3>
<p>Before I came to Ennova they (like all smart / cool / awesome people I know) had already switched their 2.3.8 (I&#8217;m going to keep stressing this point) application over to using Bundler. It worked beautifully! If they hadn&#8217;t done this then we would have to install the &#8220;rails_upgrade&#8221; plugin using this line:</p>

<pre><code>script/plugin install git://github.com/rails/rails_upgrade.git</code></pre>

<p>And then run <code>rake rails:upgrade:gems</code> to switch the <code>config.gem</code> lines in the <em>config/environment(s)/<em>.rb_ files to <code>gem</code> lines in a <em>Gemfile</em>. There&#8217;s other commands that this plugin provides to which we should have used to upgrade our application in retrospect, but I think not using them didn&#8217;t slow us down</em>that* much. <a href='https://github.com/rails/rails_upgrade'>Check out the README here.</a></em></p>

<p>Because they&#8217;d already done this we began the process of upgrading to Rails 3 began with this line in the <em>Gemfile</em>:</p>
<pre>
  gem 'rails', '3.0.1'
</pre>
<p>Then we needed to run <code>bundle install</code> and then we were on our way.</p>
<h3>Monday</h3><strong>Partner: Lucas Willet</strong>
<p>Most of the upgrade process is a matter of &#8220;following the bouncing ball&#8221;. If we saw a deprecation warning, generally speaking it was explanatory enough that we were able to understand what it meant and then go about fixing it. The notes beneath are for those issues which were <em>not</em> purely deprecation warnings, but &#8220;gotchas&#8221;.</p>

<p>To &#8220;upgrade&#8221; the application, we begun by ensuring that everything was committed to a branch and that the application was stable. This application is a well-tested application (not 100% coverage, but getting there) and we assumed that if all the tests were passing on the 2.x version of the application then the goal to ensure that the Rails 3 application was upgraded is that all the tests should be passing too. If the application had any failing tests it would be priority #1 to fix these up before going through with the upgrade.</p>

<p>The application uses Git for version control so we checked out a new branch called &#8220;rails-3&#8221; and began our work. The next command we had to use was the <code>rails new .</code> from within the application itself which runs the Rails application generator on the current directory. This is where you have to be really careful that it doesn&#8217;t override things such as the <em>app/controllers/application.rb</em> file. If you&#8217;ve got version control then it&#8217;s quite easy to check out this file, but if you miss it then it&#8217;s difficult (as in, you&#8217;d have to generate another application and copy over the important bits) of a file if you press the wrong key during this part. Be very careful.</p>

<p>Our first test was to see if we could get <code>rails console production</code> running which would mean that the application was at least booting in production mode, then we would move on to getting the tests to pass. the &#8220;production&#8221; environment is very similar to the &#8220;test&#8221; environment and although we <em>could</em> have used the &#8220;test&#8221; environment, we wanted to make sure that all the production-environment code was running. When we ran this command, it bombed as expected. <strong>No upgrade is smooth.</strong></p>

<p>The first couple of errors we encountered we for the <code>acts_as_archive</code> and <code>searchlogic</code> gems. I don&#8217;t have the errors to hand right now, but they were show-stoppers. Quite a lot of the errors we encountered were because we were using older versions of gems, or that the gems had not been updated on their &#8220;canonical&#8221; repositories so we had to find forks. These were both this kind of error.</p>

<p><code>acts_as_archive</code> was easy enough to upgrade, we found <a href='http://github.com/xxx/acts_as_archive'>a fork by xxx</a> for it and pointed our Gemfile at that. We found out that the <em>gemspec</em> wasn&#8217;t quite right (it referenced a non-existant <code>rails</code> directory) and so we committed a patch to make it stop displaying a warning for it and xxx was kind enough to merge it.</p>

<p>Then there was Searchlogic. What a gigantic clusterfuck of code. I don&#8217;t blame him for writing such terrible code, it was written before ARel existed and ARel does effectively most of what Searchlogic does anyway. I&#8217;m sure <a href='http://github.com/binarylogic'>binarylogic</a> has the best intentions at heart, but his code is really fucking confusing for me. We also found a <a href='http://github.com/railsdog/searchlogic'>Rails 3 compatible fork of Searchlogic by railsdog</a> and it worked for most cases. We ended up chucking it out and writing our own scopes using ARel (which, if at all possible, has now made me <strong>more</strong> in love with Aaron Patterson), including a custom <a href='https://gist.github.com/663752'>module of our (Jason and myself) own called `WildcardSearch`</a>. This allows us to search for keywords in specific fields of the table we&#8217;re looking up in, and allows us to also do queries on associated records too. Check out the code, it&#8217;s great stuff.</p>

<p>In the application there was a <em>config/preinitializer.rb</em> which was being used for setting up Bundler, as well as defining constants or changing things such as the default date formatting in the application. For Rails 2.3.8, you need the <em>config/preinitializer.rb</em> to load Bundler, but because we upgraded to Rails 3 this part of the file was now redundant&#8230; but where would you put the constants / settings? We decided it would be best to move them into an initializer, which involved quite simply creating a new file at <em>config/initializers/default.rb</em> and moving the code across. Generally speaking, any code that sets up your application&#8217;s environment should now be placed in <em>config/initializers</em>, not <em>lib</em>.</p>

<p>Next up, in <em>config/environments/production.rb</em> we set the <code>config.active_support.deprecation</code> to <code>:notify</code> so that when the application was running in production mode (like when we were running <code>rails console production</code>) it would show us the deprecation warnings in the console rather than hiding them. We also set this same setting to <code>:stderr</code> in the <em>config/environments/test.rb</em> and <em>config/environments/development.rb</em> files. Also in these files there was reference to an old setting called <code>consider_all_requests_local</code>, which we removed reference to.</p>

<p>The first deprecation warning that came up when <code>rails console production</code> decided it wanted to start booting our application was that the syntax in our routes file was deprecated. This was because we were using the deprecated mapper, which in simple terms meaning that our routes went like this:</p>

<pre><code>ActionController::Routing::Routes.draw do |map|
  map.root :controller =&gt; &quot;welcome&quot;, :action =&gt; &quot;index&quot;</code></pre>

<p>When they should be something like this:</p>

<pre><code>Rails.application.routes.draw do
  root :to =&gt; &quot;welcome#index&quot;</code></pre>

<p>Ahh, much better! This is where we stuffed up, we should have run the <code>rake rails:upgrade:routes</code> command <em>before</em> we ran <code>rails new .</code> because the rails upgrade plugin only works on a Rails 2 application. We spent a couple of minutes going through this file fixing up all the lines in this file to use their new syntax. Whilst it&#8217;s handy to know how each of the methods map across between Rails 2 and 3, it&#8217;s also good to know that if you don&#8217;t know what a route <em>should</em> be in Rails 3 that you can reference the <a href='http://guides.rubyonrails.org/routing.html'>Routing Guide</a>. The current (as-of-writing) gem version for <em>declarative_authorization</em> is 0.5 and it uses this old, deprecated routing syntax too. Thankfully sttfn has updated his gem like all good gem authors <em>should</em>, and we were able to load the gem straight from GitHub with this line:</p>

<pre><code>gem &#39;declarative_authorization&#39;, :git =&gt; &quot;git://github.com/stffn/declarative_authorization&quot;</code></pre>

<p>The next warnings when running <code>rails console production</code> was that we were using <code>named_scope</code> when in Rails 3 the correct method is simply <code>scope</code>. We did a find-and-replace to fix these up, only to run <code>rails console</code> and to find out that <code>authlogic</code> this time was the one throwing the remaining warnings. I&#8217;d already done an upgrade at GetUp from Rails 2 to Rails 3 and because binarylogic is inattentive of his gems I went about doing an upgrade for it to make it work with Rails 3, resulting in <a href='http://github.com/radar/authlogic'>my fork of authlogic</a> which should have all the deprecation warnings fixed.</p>

<p>More ActiveRecord deprecations were next, with a couple of callbacks in our application defined like this:</p>

<pre><code>def after_update
  # do something
end</code></pre>

<p>Other callbacks like <code>before_create</code> and <code>after_create</code> existed too. Rather than defining the callback methods like this, the correct way in Rails 3 to define these is to define them as methods (private ones for bonus points) and then use the callback to call them, like this:</p>

<pre><code>after_update :do_something

def do_something
  something.do!
end</code></pre>

<p>It&#8217;s best practice to define the callbacks like this because you may have multiple callbacks you want to run after a record has been updated, or created or whatever.</p>

<p>It was after this that our <code>rails console production</code> booted with no errors. Great! The application has RSpec and test/unit tests, and I&#8217;m very partial to RSpec so we tried running it and it bombed too. We bumped the version number of <code>rspec-rails</code> up to 2.0.1 in the <em>Gemfile</em>, ran <code>bundle install</code> again and then tried running the tests. They failed because of this error:</p>

<pre><code>no such file to load -- spec</code></pre>

<p>We had to change the requires in <em>spec/spec_helper.rb</em> from this:</p>

<pre><code>require &#39;spec/autorun&#39;
require &#39;spec/rails&#39;
require &#39;spec&#39;</code></pre>

<p>To this:</p>

<pre><code>require &#39;rspec/autorun&#39;
require &#39;rspec/rails&#39;
require &#39;rspec&#39;</code></pre>

<p>Also in this file, the <code>Spec::Runner</code> constant doesn&#8217;t exist, and this is used for this line further down in the file:</p>

<pre><code>Spec::Runner.configure do |config|
   ...
end</code></pre>

<p>RSpec is now configured using the <code>RSpec</code> constant, so the above lines are now:</p>

<pre><code>RSpec.configure do |config|
  ...
end</code></pre>

<p>At this point RSpec was launching and we were informed of our next deprecation warning: the <code>cache_template_loading</code> setting for the application configuration (ours was in <em>config/environments/test.rb</em>) has been deprecated, and so we had to remove it. After this our specs were at least running (but not all passing), and so we decided we&#8217;d come back to them after we attempted to get the test/unit tests to pass. Just like <code>rails console</code> and the RSpec tests before them, they bombed too.</p>

<p>This time it was due to this error:</p>

<pre><code>no such file to load -- test_help</code></pre>

<p>To be honest, I don&#8217;t use test/unit to test Rails applications, I just hate it. I was pairing with Lucas on the application and he&#8217;d been brought up to only ever use RSpec and Cucumber, so he was just following my lead on this one. Then I made a bad mistake: <strong>I removed the test_help line</strong>.</p>
<small>We found out a few days later that this file is actually now at `rails/test_help`. This file is incredibly important for transactions in tests and it wasn't until Wednesday when we fixed this problem. Don't make the same mistake as us, it's important!</small>
<p>In quite a lot of our test/unit tests we had this line:</p>

<pre><code>include ActionController::Assertions::SelectorAssertions</code></pre>

<p>This module has now been moved into Action Dispatch and so the correct <code>include</code> is this:</p>

<pre><code>include ActionDispatch::Assertions::SelectorAssertions</code></pre>

<p>The rest of Monday was spent working on writing the <code>WildcardSearch</code> module and getting stuck on a little bug with it.</p>
<h3>Tuesday</h3><strong>Partner: Jason</strong>
<p>This was the first day that I got to pair with <a href='http://twitter.com/jasoncodes'>Jason Weathered (@jasoncodes)</a> and we carried on the good work that Lucas and I did the day before. Jason&#8217;s been doing Rails for about a year now but is scarily on or very near my level. Dude is amazing.</p>

<p>The first problem we fixed on Tuesday was that <code>rake spec</code> was running, but not returning anything. It turns out that it this is because we had <code>rspec-rails</code> in the <code>:test</code> group which means that its rake tasks were only being loaded in the <code>test</code> environment, where by running <code>rake spec</code> we need them to exist in the <code>:development</code> group. Moving this gem into a group block like this:</p>

<pre><code>group :development, :test do 
  gem &#39;rspec-rails&#39;, &#39;2.0.1&#39;
end</code></pre>

<p>This makes RSpec&#8217;s rake tasks available in the <code>development</code> environment so we were able to run <code>rake spec.</code> All of Tuesday was spent trying to get the RSpec tests to pass once again.</p>

<p>With the forked version of Searchlogic we were using, our <code>*_like_any</code> methods like the one used in this method:</p>

<pre><code>def text_contains(text)
  name_or_description_or_optional_originator_username_or_status_like_any
end</code></pre>

<p>Just weren&#8217;t working. The methods were apparently undefined. The intention of this method is to find an Event with a name or description containing keywords. Let&#8217;s assume that <code>text</code> in this context is &#8220;foo bar&#8221;, the query the <code>like_any</code> method uses here will look up an <code>Event</code> record which has a name containing either foo <em>OR</em> bar, or a description containing either foo <em>OR</em> bar, or a related user who&#8217;s username contains either foo <em>OR</em> bar. It&#8217;s a messy query, and this Searchlogic method generated it for us. I&#8217;m not going to post the mess here. We replaced this method with v1 of our <code>WildcardSearch</code> module, the end-result (on Thursday) looking like this:</p>

<pre><code>def text_contains(text)
  self.includes(:originator).wildcard_search(:name, :description, { :originator =&gt; :username })
end</code></pre>

<p>We use <code>includes</code> here and pass it an association name. ARel&#8217;s really smart and will know if we use the association name here what table to join. Even better than that, when we use a <code>where</code> later on in that same query, it will use a <code>LEFT OUTER JOIN</code> to join that table and run the query on the <code>events</code> and <code>users</code> tables. ARel is extremely capable of doing what Searchlogic did, it&#8217;s Rails 3 compatible and it&#8217;s supported by somebody who&#8217;s fairly active in the community: Aaron Patterson. It was about this moment where we decided to scrap all usage of Searchlogic in our application favour of ARel. After this replacement, quite a few of our failing specs were passing.</p>

<p>A large majority of this day was spent cherry-picking off failing specs. The first of these was that our tests making sure the validations were in place were checking that the error message contains a string:</p>

<pre><code>thing.errors[:user_id].should == &quot;has already been taken&quot;</code></pre>

<p>When in Rails 3, errors<span>:attribute</span> now returns an <code>Array</code>. The Rails 3 correct version of this is:</p>

<pre><code>thing.errors[:user_id].should == [&quot;has already been taken&quot;]</code></pre>

<p>Fixing this fixed up even more of our specs, but we still had work to go. During the running of our specs we encountered a deprecation warning with our mailer:</p>

<pre><code>Notifier.deliver_confirmation_instructions is deprecated, use Notifier.confirmation_instructions.deliver instead.</code></pre>

<p>We fixed this up nice and quickly and looked through the application for <code>deliver_</code> and fixed those deprecations up too. Personally I prefer to use the <code>deliver!</code> alias method as a &#8220;destructive&#8221; / &#8220;undoable&#8221; method.</p>

<p>The next issue we came across was to do with a little change between Rails 2 and 3 in regards to partial rendering. It had to do with a line like this:</p>

<pre><code>render :partial =&gt; &quot;some/partial&quot;, :collection =&gt; @things</code></pre>

<p>In Rails 2, when you pass the <code>:collection</code> option to <code>render</code> like this, each of the objects are passed to the partial as <code>object</code>. In Rails 3, this changes to be the name of the partial itself mainly because now you can do things like this:</p>

<pre><code>render @things</code></pre>

<p>Let&#8217;s assume for the time being that the <code>@things</code> variable is a collection of <code>Thing</code> objects. When you call <code>render @things</code> this will render, by default, the partial at <em>app/views/things/_things.html.erb</em>. The objects of the collection are then passed through as the local variable <code>thing</code>. Our problem was that we were using the Rails 2 line, and so Rails 3 was assuming that we wanted the variables still called after the partial. To give the variables the right name we use lines like this:</p>

<pre><code>render :partial =&gt; &quot;some/partial&quot;, :collection =&gt; @things, :as =&gt; :other_thing</code></pre>

<p>Now the objects will be available in the partial as <code>other_thing</code>. This fixed most of the view breakages, although we had another big one coming up.</p>

<p>That was the <code>nested_layouts</code> gem which is no longer compatible with Rails 3. To fix this, we used <a href='http://guides.rubyonrails.org/layouts_and_rendering.html#using-nested-layouts'>this section</a> from the bottom of the Layouts and Rendering guide for Rails 3. I think this is a much more elegant solution to the <code>nested_layouts</code> hackery.</p>

<p>After fixing <em>that</em> test, the next problem was that one of our files in <em>lib</em> was not being loaded. This is because in Rails 2 the files in <em>lib</em> are autoloaded, where in Rails 3 you must manually require them. Or at least you would if you didn&#8217;t have this option in <em>config/application.rb</em>:</p>

<pre><code>config.load_paths += %W( #{config.root}/lib )</code></pre>

<p>If you wanted to add more directories to be autoloaded just add them to this array. With this small change we fixed some more &#8220;broken&#8221; tests.</p>

<p>The next problem was that we were getting this error in some of our views:</p>

<pre><code>undefined local variable or method `form_remote_tag&#39;</code></pre>

<p>In Rails 2 the <code>form_remote_tag</code> and related methods have been moved out into a plugin called <code>prototype_legacy_helper</code>. We installed this plugin using this command:</p>

<pre><code>rails plugin:install git://github.com/rails/prototype_legacy_helper</code></pre>

<p>After installing this plugin our tests were <em>still</em> failing. We later found out that it was a bug with <code>prototype_legacy_helper</code> itself so I asked Jos Valim (the Rails core member) who maintains it. He replied &#8220;I don&#8217;t know&#8221;. Uh oh. So Jason and I fixed the bug and in doing so I gained commit rights to the project. Therefore I suppose I&#8217;m now the maintainer of it. If you want a bug fixed in it send in a patch and I&#8217;ll apply it.</p>

<p>That&#8217;s how we wrapped up Tuesday.</p>
<h3>Wednesday</h3><strong>Partner: Jason</strong>
<p>Jason and I were pairing on Wednesday too. By this point, we&#8217;d fixed the major issues with the application and were just going through the deprecation warnings in the application. A lot of the changes for this day were fixing deprecation warnings in the application, and so this day may seem like we didn&#8217;t do much, but we did quite a bit.</p>

<p>One of the major changes was that now any helper that outputs something in a view uses the <code>&lt;%=</code> ERB tag, rather than <code>&lt;%</code>. The latter&#8217;s going to be deprecated in Rails 3.1 so it&#8217;s best that we switch this over. Most of this happened on the <code>form_for</code>, but we had a couple of <code>content_tag</code>s that were doing it too.</p>

<p>We started off the day by realising that we didn&#8217;t need the <em>config/environments/cucumber.rb</em> file any more, Cucumber now runs within the &#8220;test&#8221; environment rather than its own special &#8220;cucumber&#8221; environment. This also means that we could remove the <code>cucumber</code> key from <em>config/database.yml</em> as that database setting is never used.</p>

<p>A couple of our functional tests had referenced a constant &#8211; <code>ActionController::TestUploadedFile</code> &#8211; which is now available in Rack instead as <code>Rack::Test::UploadedFile</code>. There was also some tests referring to fixtures which we converted over to using Factory Girl&#8217;s factories.</p>

<p>We also had a plugin which had its <em>tasks</em> folder in the root of the directory, where Rails 3 expects it to be in <em>lib/tasks</em>. It was a plugin of our own making so we moved this folder into its proper spot.</p>

<p>The application Sass extensively, so when we tried the application through <code>rails server</code>, it created new files at <em>public/stylesheets</em> for the parsed Sass stylesheets. This is incorrect, as the Hassle gem we had installed should have been putting them into a <em>tmp</em> folder and reading it from there because this application is deployed on Heroku. To fix this, we changed the <code>gem</code> specification of hassle in our <em>Gemfile</em> to this:</p>

<pre><code>gem &#39;hassle&#39;, &#39;0.0.1&#39;, :git =&gt; &#39;git://github.com/fphilipe/hassle.git&#39;</code></pre>

<p>Next, we created an initializer to load Hassle in as a middleware, called <em>config/initializers/hassle.rb</em>:</p>

<pre><code>Rails.configuration.middleware.use Hassle</code></pre>

<p>With fphilipe&#8217;s fork of <code>hassle</code>, we were able to get the stylesheets to go in the correct directory.</p>

<p>At the end of Wednesday, Jason and I came across a problem where a <code>flash[:notice]</code> was seemingly being lost and we spent the last half-an-hour trying to figure out why, to no avail.</p>
<h3>Thursday</h3><strong>Partner: Lucas</strong>
<p>On Thursday on the way in I talked to Lucas about Wednesday night&#8217;s problem and suggested it could be a double redirect as I had seen it happen before on an application. Turns out that was the problem, and we used <code>flash.keep</code> to keep the flash for the next request. With this final little change, all the test/unit tests, functionals and RSpec tests were passing. Time to get the Cucumber features to pass.</p>

<p>One of the little minor-changes-that-breaks-everything was that in Rails 2 the submit button for a form, if not given an argument, defaulted to &#8220;Save changes&#8221;. In Rails 3, this now defaults to either &#8220;Create <span>Object</span>&#8221; where <span>Object</span> is the class name of the form&#8217;s object, or &#8220;Update <span>Object</span>&#8221;. The view inspects the model object it&#8217;s given to determine what the button should display! I think this is much better, but it just about broke The Everything. We went through the features and did a manual find-and-replace for all these occurrences and fixed them up.</p>

<p>Next, we had a helper which was outputting HTML as a string. This is problematic because in Rails 3, all HTML-as-a-string is marked as unsafe, and is escaped. To fix this we used <code>html_safe</code> on the return value of this helper. There was also another helper in this file which we fixed up a little later on too.</p>

<p>The next deprecation warning we came across wasn&#8217;t to do with Rails, but Capybara. It was this:</p>

<pre><code>DEPRECATED: #click is deprecated, please use #click_link_or_button instead</code></pre>

<p>We found the offending step and changed it to use this new method.</p>

<p>It was at about this point that we decided to scrap Searchlogic. On our <code>Person</code> model we had a boolean field called <code>active</code> which Searchlogic should have been defining a scope much like this for:</p>

<pre><code>scope :active, where(:active =&gt; true)</code></pre>

<p>Sadly, this wasn&#8217;t working. My suspicion was that it was defining it something like this:</p>

<pre><code>scope :active, where(:active =&gt; &#39;t&#39;)</code></pre>

<p>or</p>

<pre><code>scope :active, where(:active =&gt; &#39;true&#39;)</code></pre>

<p>As I stated before, Searchlogic is a clusterfuck of a codebase and so I didn&#8217;t really want go hunting in there. I also said before that ARel does exactly what Searchlogic did, so we scrapped Searchlogic. A quick run of the RSpec tests picked up any occurrences where we removed Something Important and we re-implemented the scopes with ARel. Probably took us all of 10 minutes.</p>

<p>In some custom code we had this:</p>

<pre><code>some_association.scoped(:include =&gt; :children)</code></pre>

<p>It took me a little while before I realised that you can just use ARel for this too:</p>

<pre><code>some_association.includes(:children)</code></pre>

<p>It was just one of those way-too-obvious fixes that you overlook initially and then gape in awe when you write it.</p>
<h3>Friday</h3><strong>Partner: Jason</strong>
<p>The final day!</p>

<p>We had some features that used the <code>WildcardSearch</code> module that were failing, even though we were <em>positive</em> it was correct. Turns out it wasn&#8217;t case-insensitive! Also turns out that Rails 3.0.1 (well, actually the version of ARel that <em>comes with</em> Rails 3.0.1), doesn&#8217;t support case-insensitive matching with the <em>matches</em> method. Thankfully there&#8217;s a smart-cookie out there who&#8217;s written <a href='https://rails.lighthouseapp.com/projects/8994/tickets/3174-add-support-for-postgresql-citext-column-type'>a beautiful patch</a> for it, <strong>but it only works with PostgreSQL</strong>. That&#8217;s fine, we&#8217;re smart so we use PostgreSQL. We used the patch&#8217;s code in an initializer and it worked flawlessly.</p>

<p>During the running of our tests, we used <code>Then show me the page</code> <strong>a lot</strong>. This resulted in lots of <em>capybara-[timestamp]</em> files in the root directory. To fix this little problem, we put this code in our <em>features/support/app.rb</em> file:</p>

<pre><code>Capybara.save_and_open_page_path = Rails.root + &#39;tmp&#39;</code></pre>

<p>All fixed!</p>

<p>One of our actions returned two formats: a <code>html</code> version and a <code>pdf</code> format. In the <code>pdf</code> <code>respond_to</code> block the code looked like this:</p>

<pre><code>@template.template_format = :html
kit = PDFKit.new(render_to_string)</code></pre>

<p>It turns out that <code>@template</code> is no longer an accessible-from-the-controller variable. Who&#8217;d have thunk it? To work around this problem, we had to use the (undocumented! grr) <code>:action</code> option for <code>render_to_string</code>, changing the final line to this:</p>

<pre><code>kit = PDFKit.new(render_to_string(:action =&gt; &#39;print.html.haml&#39;))</code></pre>

<p>We simply wanted the <code>html</code> version of this template, where as this code was trying to render the <code>print.pdf.erb</code> template which simply didn&#8217;t exist.</p>

<p>The next issue was that we were using <code>find_or_create_by*</code> in a step like this:</p>

<pre><code>role = @project.roles.find_or_create_by_name(role_name, :category =&gt; category)</code></pre>

<p>This syntax isn&#8217;t supported in Rails 3 (it thinks that <code>:category</code> is a key like <code>:joins</code> or <code>:includes</code>) and so we had to change it to the way-more-verbose this:</p>

<pre><code>role = @project.roles.find_by_name(role_name) || @project.roles.create!(:name =&gt; role_name, :category =&gt; category)</code></pre>

<p>That was the final Rails 3-caused issue that we came across on Friday, and by 4pm we had all the Cucumber features, RSpec specs, and test/unit tests all passing. Everything worked.</p>
<h3>So now what?</h3>
<p>Well, Ennova&#8217;s not going to deploy this application directly to production just yet. I&#8217;d say they should give it a week on staging so that one of the business guys can go through the application and make sure it&#8217;s working as intended. The application isn&#8217;t <em>completely</em> covered in tests, so there&#8217;s bound to be something we missed out. For the most part though, it&#8217;s a fully-functional Rails 3 application working nearly-exactly like it did in Rails 2.</p>

<p>A lot of the upgrading work was done on Monday and Tuesday, with quite a large majority of the remaining time spent just fixing deprecation warnings in our application or making the tests better. All in all, I think it went very well.</p>

<p>I hope this helps somebody out there get up the nerve to upgrade their application to Rails 3. It&#8217;s stable, it&#8217;s proven to work (Gemcutter, for instance, runs Rails 3) and it&#8217;s awesome. Also, with all <a href='http://edgeguides.rubyonrails.org/3_0_release_notes.html'>the new features in Rails 3</a>, how can you resist?</p>]]></content>
 </entry>
 
 <entry>
   <title>Gone from GetUp</title>
   <link href="http://ryanbigg.com/2010/10/gone-from-getup"/>
   <updated>2010-10-30T00:00:00+10:30</updated>
   <id>http://ryanbigg.com/2010/10/gone-from-getup</id>
   <content type="html"><![CDATA[<p>Yesterday was my last day at GetUp. I&#8217;m moving on to bigger and better things now.</p>

<p>If you&#8217;ve been <a href='http://twitter.com/ryanbigg'>following me on Twitter</a> you would have been able to work out by the hints that I&#8217;ve been dropping all week that this was the case. If you didn&#8217;t work it out from the hints then <a href='http://twitter.com/#!/ryanbigg/status/29062245881'>one of last night's messages</a> should have spelled it out clearly enough.</p>

<p>During my time there, I was training up the ex-PHP developers in the ways of Ruby on Rails whilst developing the new version of GetUp&#8217;s website. This is definitely the kind of work that I want to do for as long as I&#8217;m able, it&#8217;s been a blast.</p>

<p>There are many reasons why I&#8217;m leaving the organisation and some of them cannot be made public. What can be made public is that last Thursday changed everything.</p>

<p>I received news early that morning that a very good UK friend of mine, (Angus / Fares Yusuf) Donaldson, had passed away 6 days prior. We had met online a couple of years back, hanging out in #rubyonrails, #offrails and more recently #railsbridge together. It was until March this year when I was on my way to Scotland that we met in person, staying in Heathrow Airport for 7 hours during an epic layover between flights. I kept telling Angus that my flight was at 2:30pm and he kept saying it was fine. By the time Angus brought me to the correct terminal, the flight had already gone through final boarding and I hadn&#8217;t even checked in yet! Angus thought that the <em>check-in</em> time was the one I was saying, NOT the flight departure time. Whilst I was mildly panicking, he sweet-talked an airhostess and got me on the next available flight. I&#8217;ll miss him quite a lot. It made me feel mortal. If the indestructible Angus could die, then I could too.</p>

<p>Later on that morning the other friend I caught up with in the UK, Sam Elliott, sent me a DM about a job that I may be interested in. I looked into it and contacted the people offering it, but then had to leave for work. Was still in a shocked/dazed state when I arrived, I don&#8217;t remember much. At about 10am I had a chat to the company but I wasn&#8217;t able to offer my help because I wasn&#8217;t sure if my contract was going to end the following week or not.</p>

<p>This was one of the things about GetUp and my contract. I never received a paper copy until about 6 months in. During the whole time I was there, my contract was extended by about a month per time, going from end of May to end of June, to end of July, to end of October. These discussions happened usually less than 1 week before the contract expired. Obviously there was still work to do, but I had no hint if the contract was going to still be extended or not. I would have preferred greater notice.</p>

<p>On Thursday night I got some bad news: they were going to be letting two of my team go, James and Charles. I read it as they were &#8220;thinking&#8221; of doing it, but the following Monday found out it was a definite. On Monday afternoon, each of the Online team had one-on-ones with Daryl and Simon with Charles and then James going first. I asked James what they asked him and he showed me a letter with &#8220;Redundancy&#8221; as the header. To be perfectly honest, I was furious at this stage. They were letting the two full-time people on the team who were getting decent at Rails go. I calmed down, sat through my one-on-one without leaping the desk and smashing Simon&#8217;s stupid face into a bloody pulp, went home, and cried.</p>

<p>I talked with a lot of people that night. That was the theme over the next few days as well, just pure talking. Voice chats, text messages, Skype chats&#8230; it was just so much talking. The company I spoke to on Thursday asked me again on Tuesday morning if I&#8217;d still be interested and I basically said &#8220;yes, I&#8217;m very much interested and leaning that way now, but I have to talk to my boss&#8221;. So on Tuesday morning I spoke with Daryl who sympathised with my anger, but wished that I could stay on 6 more weeks. I said that I would have to speak with the other company again.</p>

<p>Wednesday morning, that&#8217;s what happened. They said they needed somebody right away and if they couldn&#8217;t get me, then they&#8217;d have to move on. If I didn&#8217;t leave GetUp, I could have potentially missed out on this fabulous opportunity. I told Daryl the bad news Wednesday morning and he said he was disappointed but agreed that I had to do what was best for me. At the end of the week, I would be leaving GetUp and moving on.</p>

<p>The other company was really happy when I told them late Wednesday morning, and so was I. It&#8217;s something that I&#8217;ve wanted to do for quite a long time and I really think it&#8217;ll benefit the community in a great way. Sorry for being so cryptic about the details, just there&#8217;s very little that I&#8217;m able to share right now.</p>

<p>Thursday and Friday was handover with Alex (contractor) and Francois (full-timer). I wish them the best of luck in developing and delivering v3. On Friday at the team meeting I got given a great well wishes card from the team as well as an awesome satchel bag for my laptop that doesn&#8217;t look as dodgy as a backpack.</p>

<p>On Sunday, my contract expires. After that, I&#8217;m going to be spending two weeks in Brisbane, one of them working for a company up there doing a Rails 3 upgrade work and some pairing with their team and then the following week I begin my contract at this new job. It&#8217;s a remote contract so I&#8217;ll probably just be desk-hopping around the place doing the work. I&#8217;d like to not stay in the house the whole time. The weekend after that is Railscamp, which I&#8217;m really looking forward to.</p>

<p>I&#8217;m still going to be writing Rails 3 in Action during this new contract. We&#8217;re hoping to have a new release out Real Soon Now(tm), as soon as I get some time to speak with Yehuda about the latest major review comments. It should contain chapters 1-10 with 11 coming Real Soon After(tm).</p>

<p>The future&#8217;s looking good. See you there.</p>]]></content>
 </entry>
 
 <entry>
   <title>Writing isn't all rainbows</title>
   <link href="http://ryanbigg.com/2010/10/writing-isnt-all-rainbows"/>
   <updated>2010-10-19T00:00:00+10:30</updated>
   <id>http://ryanbigg.com/2010/10/writing-isnt-all-rainbows</id>
   <content type="html"><![CDATA[<p>There, I said it and I&#8217;ll say it again.</p>

<p>Writing isn&#8217;t all rainbows.</p>

<p>What do I mean by this? Put simply: it&#8217;s not an enjoyable process all of the time. It has its moments, both good and bad. Right now you may be able to tell I&#8217;m having a bad one. I should be writing Rails 3 in Action, but instead I&#8217;m writing this post.</p>

<p>As a famous author once said: &#8220;Writing is like taking a shit. Don&#8217;t if you don&#8217;t <strong>have</strong> to.&#8221;. So I&#8217;m not writing tonight. I am simply not in the mood for it, and to be perfectly honest I am feeling a lot burned out tonight. I am human too.</p>

<p>Writing Rails 3 in Action is difficult. I have to stay on top of the gem changes (such as rspec and rails, which should now be stable) and know what is the &#8220;accepted best practice&#8221; of how to do something. I then have to explain that in exceptional detail so that people get it on their first read and know what I&#8217;m thinking at this point. If a reader gets lost, then I have failed.</p>

<p>I do most of my writing on the weekends, since I am working full time at GetUp. Chapter 8 took me almost a month to complete because it was a very complex chapter that had a lot going on all at once. I eventually re-wrote it and people have been saying it&#8217;s much better. Relief. Chapter 10 took me a little over a week. Chapter 11 should be completed this weekend (its third weekend).</p>

<p>If you&#8217;re thinking of writing a book ask yourself one question: What makes yours unique? I&#8217;m trying to make Rails 3 in Action unique by using Cucumber, RSpec, Rails and all the other gems we use to build a full-featured application throughout the entire book. I hope this is unique enough for the readers.</p>

<p>I&#8217;m not writing this for the money. Being honest, the advances I&#8217;ve been receiving wouldn&#8217;t even fund my rent for the time it took to write the part I&#8217;m being paid for, let alone all the other fun things you have to pay for in life. There is no way I can live on just the money from the book advances, so I work. Working what is basically super-full-time takes its toll on a person after a while, and I get a little down.</p>

<p>However, when you work at a job where there&#8217;s interesting challenges to solve and good people to work with, then that isn&#8217;t as much of a drag as some would think. GetUp&#8217;s like that, and I&#8217;m thankful for that. I can go home at the end of the day feeling &#8220;accomplished&#8221; and thinking &#8220;what can I accomplish on the book tonight?&#8221;. Those kinds of nights I&#8217;ll bash out a section or two. Tonight is not one of those nights, for reasons I won&#8217;t go into right now.</p>

<p>I&#8217;m not writing the book for the money. I&#8217;m not writing it for the fame (got enough, thanks). I&#8217;m writing it because when a person tweets about it or posts to the forum and uses phrases like &#8220;awesome!&#8221; and &#8220;thanks for this, I really love what you&#8217;ve done!&#8221;&#8230;</p>

<p>That&#8217;s the &#8220;rainbows&#8221; I live for. That&#8217;s what I write for.</p>

<p>Thanks for your support so far. It makes nights like this all that more tolerable.</p>]]></content>
 </entry>
 
 <entry>
   <title>Lighthouse has problems, but they're fixing them</title>
   <link href="http://ryanbigg.com/2010/10/lighthouse-has-problems-but-theyre-fixing-them"/>
   <updated>2010-10-11T00:00:00+10:30</updated>
   <id>http://ryanbigg.com/2010/10/lighthouse-has-problems-but-theyre-fixing-them</id>
   <content type="html"><![CDATA[<p>After I wrote my <a href='http://ryanbigg.com/2010/10/lighthouse-has-problems/'>Lighthouse has problems</a> post last week, I was contacted by ENTP who asked to speak to me regarding some clarifications, and now I&#8217;ve finally gotten around to posting them.</p>

<p>Firstly: ENTP is working on a major upgrade of Lighthouse. They <a href='http://help.lighthouseapp.com/discussions/problems/1791-spammers-taking-over'>plan on fixing the spam issue </a>and will have trusted and untrusted user accounts, where trusted users can change the title and tags of a ticket. They will also implement rate limiting which will be a way to detect the spammers current tactics on LH. This fixes points #2 and #4 of my post.</p>

<p>Secondly: there&#8217;s now less tickets for Rails itself with the <a href='https://rails.lighthouseapp.com/projects/8994-ruby-on-rails/tickets/bins/5837'>"Open Tickets"</a> currently hovering around 753. This is because of the wonderful team of Lighthouse volunteers including David Trasbo, Rohit Arondekar who have been marking old tickets as stale and replying to those which need patches. If you have a ticket which you&#8217;d like some eyes on, assign it to one of us and we&#8217;ll take a peek.</p>

<p>Thirdly: I wrote <a href='http://gist.github.com/617963'>a Mechanize script</a> to revert / delete the spam comments, which will stave off the problem until ENTP can get around to fixing their system. Myself and a couple of other volunteers run this whenever spammers are detected. Seems to do the trick quite nicely, but the code is ugly as all hell.</p>

<p>I have to play the devil&#8217;s advocate here: Lighthouse doesn&#8217;t suck, entirely. It&#8217;s a bit rough around the edges but it&#8217;s no Trac. Remember Trac? Good times were had, and spam was a problem back then. It&#8217;s a tricky problem to solve and I hope that the Lighthouse guys can actually do some serious work on it, maybe even implement a <em>proper</em> spam filter, such as Akismet, but nothing is perfect.</p>

<p>Lighthouse is serving us perfectly fine right now, it&#8217;s just a little cluttered. We&#8217;re working on that, and we&#8217;d like your help. If you could spend some of your time this week going through the <a href='https://rails.lighthouseapp.com/projects/8994-ruby-on-rails/tickets/bins/5837'>"Open Tickets"</a> and assigning old ones to one of either Rohit, David or myself, we&#8217;ll get right round to closing them up.</p>

<p>I&#8217;d like to see it below 700 by the end of next weekend.</p>]]></content>
 </entry>
 
 <entry>
   <title>Lighthouse has problems</title>
   <link href="http://ryanbigg.com/2010/10/lighthouse-has-problems"/>
   <updated>2010-10-06T00:00:00+10:30</updated>
   <id>http://ryanbigg.com/2010/10/lighthouse-has-problems</id>
   <content type="html"><![CDATA[<p>Once again, the Rails lighthouse is chockas. 944 open tickets as of this post.</p>

<p>That is disgraceful. I wrote how I felt back in April, and now I am just sad, not angry.</p>

<p>Nobody is willing to dedicate the time required to go through and play gatekeeper between these tickets and the core team, and so there is only a dribble of tickets actually being looked at / dealt with. Sure, we can have bugmashes every &#8220;x&#8221; &#8220;y&#8221;, but they only do so much. We need a continued effort to bring this number down and keep it down, but it&#8217;s not for the financial benefit of everyone, so nobody&#8217;s going to do it.</p>

<p>Besides that, Lighthouse has some quite serious issues itself. The sheer fact that I have to use an ordered list to outline the problems shows the extreme side of this situation.</p>
<ol>
  <li>There's no way for a project "admin" to completely delete / ban a user. For instance if I want to delete a <a href='https://rails.lighthouseapp.com/users/118614'>spamming fucktard</a> like this guy, I can't.</li>
  <li>There is no spam protection. If a user posts two comments within the space of a minute they should be prompted with a captcha. This will stop the bot spam, at least. Manual spam can be dealt with by fixing point #1.</li>
  <li>If I don't want to delete a user, but I want to delete <strong>some</strong> of their comments, I can't do that either.</li>
  <li>Normal users can change the title of a ticket <strong>they don't even own</strong>. See: "Diaspora Syndrome"</li>
  <li>When you delete the last comment of a ticket that has changed the title of that ticket, it doesn't revert the ticket's title</li>
  <li>There are currently 1,584 tags for Rails lighthouse alone. The problem here is that <strong>anybody</strong> can add a tag to a ticket. <strong>Most of the tags only have one ticket assigned to them.</strong></li>
</ol>
<p>But ENTP won&#8217;t fix these issues. They have much more exciting products to work on now. It&#8217;s a product that was developed years ago and they have a tiny team working on maintaining it. This is sad, too.</p>

<p>The maintenance of the Rails lighthouse is non-existant. The maintenance of Lighthouse in general is almost non-existant. This makes me sad. These problems seem almost unfixable to me as a single person. But together, as a community, we can work on fixing the Rails Lighthouse.</p>

<p>Please, please, please: spend some time each week looking at the tickets on the Lighthouse. Do these things:</p>
<ol>
<li>You can be extremely helpful just by assigning tickets that need to be closed, resolved, wontfix'd or marked as duplicate to me or anybody else on the "Assigned to" list.</li>
<li> If you want to be extremely extremely helpful, verify that patches apply correctly and if you think that specific patch should be applied to Rails and you've tested it, give that ticket a +1. Once the ticket has 3 +1s, assign it to somebody on the "Assigned to" list who will then mark it as verified. This is the final step before it gets tested + merged by Core.</li>
<li> If it doesn't apply, just put a comment there explaining what broke and hopefully the OP will fix it.</li>
<li> If you think that the patch <strong>should not</strong> be applied to Rails, give the ticket a comment with "-1" at the start, and a reason for the "downvote". When a ticket receives 3 -1s, it will be marked as "wontfix".</li>
</ol>
<p>A little help here?</p>]]></content>
 </entry>
 
 <entry>
   <title>Gem Development Guide</title>
   <link href="http://ryanbigg.com/2010/10/gem-development-guide"/>
   <updated>2010-10-01T00:00:00+09:30</updated>
   <id>http://ryanbigg.com/2010/10/gem-development-guide</id>
   <content type="html"><![CDATA[<p>From <a href='http://ryanbigg.com/2010/09/advanced-rails-documentation/'>my request yesterday</a> asking people what Rails documentation would be valuable, a large group of respondents said they&#8217;d like to see a guide on how to develop a gem. As I figured this would only take me two days to write and would be a good way to promote <a href='http://manning.com/katz'>a certain book</a>, I&#8217;ve begun writing one which I should have finished by tonight with only generators and releasing to cover.</p>

<p>You <a href='http://github.com/radar/guides/blob/master/gem-development.md'>can see it here</a>.</p>

<p>This is the kind of guide I was talking about in yesterday&#8217;s post. They don&#8217;t have to be short and they don&#8217;t have to be long, they just have to be <em>informative</em>. Is this what people would like to see more of? Are the topics I put forward yesterday worthwhile covering or is there something more interesting to the Greater Audience?</p>]]></content>
 </entry>
 
 
</feed>